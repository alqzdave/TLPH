<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <title>History | DENR Portal</title>

  <style>
    body { font-family: 'Poppins', system-ui, -apple-system, sans-serif; }
    .history-card { padding: 0 !important; }
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tab-content > p {
      background: #eff6ff;
      border-left: 4px solid #10b981;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px !important;
      font-weight: 500;
    }

    .tab-content > p i {
      color: #10b981;
      margin-right: 8px;
    }

    /* Transaction History Styles */
    .transaction-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .transaction-card:hover {
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.12);
      border-color: #10b981;
      transform: translateY(-2px);
    }

    .transaction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .permit-name {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      background: #dcfce7;
      color: #15803d;
      flex-shrink: 0;
    }

    .transaction-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f1f5f9;
      flex: 1;
    }

    .detail-item {
      font-size: 12px;
    }

    .detail-label {
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.4px;
      margin-bottom: 6px;
    }

    .detail-value {
      color: #111827;
      font-weight: 700;
      margin-top: 0;
      font-size: 14px;
    }

    /* Application Card Styles */
    .application-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      align-items: center;
    }

    .application-card:hover {
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15);
      border-color: #10b981;
      transform: translateY(-4px);
    }

    .application-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .application-type-badge {
      display: inline-block;
      padding: 6px 14px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .service-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }

    .service-card:hover {
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
    }

    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .service-title {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .service-date {
      font-size: 12px;
      color: #6b7280;
    }

    .service-status-badge {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }

    .service-status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .service-status-badge.approved {
      background: #d1fae5;
      color: #065f46;
    }

    .service-status-badge.processing {
      background: #dbeafe;
      color: #1e40af;
    }

    .service-status-badge.rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .service-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f3f4f6;
    }

    .service-detail-item {
      display: flex;
      flex-direction: column;
    }

    .service-detail-label {
      font-size: 10px;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .service-detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    .service-actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
    }

    .service-btn {
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .service-btn-primary {
      background: #10b981;
      color: white;
    }

    .service-btn-primary:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .service-btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .service-btn-secondary:hover {
      background: #e5e7eb;
    }

    .service-btn[style*="background: #f59e0b"]:hover {
      background: #d97706 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .empty-service-message {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-service-message i {
      font-size: 48px;
      margin-bottom: 16px;
      color: #d1d5db;
    }

    .application-type-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #d1fae5;
      color: #047857;
      white-space: nowrap;
      width: fit-content;
    }

    .application-card p {
      margin: 0;
      color: #374151;
      font-size: 15px;
      font-weight: 600;
      line-height: 1.4;
    }

    .receipt-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .receipt-btn:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
    }

    .receipt-btn:active {
      transform: translateY(0);
    }

    .empty-message {
      text-align: center;
      padding: 60px 40px;
      color: #9ca3af;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border-radius: 12px;
      border: 1px dashed #e5e7eb;
    }

    .empty-message i {
      font-size: 56px;
      color: #d1d5db;
      margin-bottom: 20px;
      display: block;
    }

    .empty-message p {
      font-size: 16px;
      color: #6b7280;
      margin: 0;
      font-weight: 500;
    }

    /* Receipt Modal */
    .receipt-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1050;
      backdrop-filter: blur(4px);
    }

    .receipt-modal.active {
      display: flex;
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .receipt-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.25);
      padding: 40px;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from { 
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .receipt-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #10b981;
      padding-bottom: 20px;
    }

    .receipt-title {
      font-size: 24px;
      font-weight: 800;
      color: #111827;
      margin: 0 0 10px;
    }

    .receipt-subtitle {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .receipt-section {
      margin-bottom: 24px;
    }

    .receipt-section-title {
      font-size: 14px;
      font-weight: 700;
      color: #111827;
      text-transform: uppercase;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    .receipt-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 13px;
    }

    .receipt-row-label {
      color: #6b7280;
      font-weight: 500;
    }

    .receipt-row-value {
      color: #111827;
      font-weight: 600;
    }

    .receipt-total {
      display: flex;
      justify-content: space-between;
      padding: 16px;
      background: #f0fdf4;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 700;
    }

    .receipt-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }

    .print-btn, .close-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .print-btn {
      background: #10b981;
      color: white;
    }

    .print-btn:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .close-btn {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }

    .close-btn:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .close-btn:active {
      transform: translateY(0);
    }

    /* Inventory History Styling */
    #inventoryList main { padding: 0 !important; }
    
    #inventoryList h1,
    #inventoryList h2 {
      font-size: 22px;
      font-weight: 800;
      color: #111827;
      margin: 0 0 8px;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }

    #inventoryList p {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 0 32px;
    }

    #inventoryList [class*="card"] {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 24px;
      align-items: center;
      transition: all 0.3s ease;
    }

    #inventoryList [class*="card"]:hover {
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.12);
      border-color: #10b981;
      transform: translateY(-2px);
    }

    #inventoryList [class*="item-id"],
    #inventoryList [class*="reference"],
    #inventoryList code {
      background: #f3f4f6;
      padding: 10px 14px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      font-weight: 700;
      color: #10b981;
      white-space: nowrap;
      border: 1px solid #e5e7eb;
      flex-shrink: 0;
      align-self: center;
    }

    #inventoryList [class*="item-name"],
    #inventoryList strong {
      font-size: 16px;
      font-weight: 800;
      color: #111827;
      display: block;
      margin-bottom: 12px;
      grid-column: 1;
    }

    #inventoryList [class*="item-info"],
    #inventoryList [class*="info-group"] {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 20px;
      margin-bottom: 0;
      grid-column: 1;
      width: 100%;
    }

    #inventoryList [class*="info-label"],
    #inventoryList [class*="label"],
    #inventoryList small,
    #inventoryList label {
      display: block;
      font-size: 10px;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    #inventoryList [class*="info-value"],
    #inventoryList [class*="value"],
    #inventoryList [class*="amount"] {
      font-size: 14px;
      font-weight: 700;
      color: #111827;
    }

    #inventoryList [class*="amount"],
    #inventoryList [class*="sales"],
    #inventoryList [class*="total"] {
      color: #10b981;
      font-size: 16px;
    }

    #inventoryList button,
    #inventoryList [role="button"] {
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      white-space: nowrap;
      flex-shrink: 0;
      align-self: center;
    }

    #inventoryList button:hover,
    #inventoryList [role="button"]:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    #inventoryList a[class*="close"],
    #inventoryList a.close {
      background: #f3f4f6 !important;
      color: transparent !important;
      border: 1px solid #e5e7eb !important;
      width: 36px !important;
      height: 36px !important;
      border-radius: 6px !important;
      font-size: 0 !important;
      text-decoration: none !important;
      cursor: pointer !important;
      transition: all 0.2s !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 !important;
      white-space: nowrap !important;
      flex-shrink: 0 !important;
      position: relative !important;
    }

    #inventoryList a[class*="close"]::before,
    #inventoryList a.close::before {
      content: "✕" !important;
      font-size: 18px !important;
      color: #6b7280 !important;
      position: absolute !important;
    }

    #inventoryList a[class*="close"]:hover,
    #inventoryList a.close:hover {
      background: #e5e7eb !important;
      border-color: #d1d5db !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
    }

    #inventoryList a[class*="close"]:hover::before,
    #inventoryList a.close:hover::before {
      color: #374151 !important;
    }

    #inventoryList .exit-btn {
      background: #f3f4f6 !important;
      color: transparent !important;
      border: 1px solid #e5e7eb !important;
      width: 36px !important;
      height: 36px !important;
      border-radius: 6px !important;
      font-size: 0 !important;
      text-decoration: none !important;
      cursor: pointer !important;
      transition: all 0.2s !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 !important;
      flex-shrink: 0 !important;
      position: relative !important;
    }

    #inventoryList .exit-btn span {
      display: none !important;
    }

    #inventoryList .exit-btn::before {
      content: "✕" !important;
      font-size: 18px !important;
      color: #6b7280 !important;
      position: absolute !important;
      font-family: Arial, sans-serif !important;
      font-weight: bold !important;
    }

    #inventoryList .exit-btn:hover {
      background: #e5e7eb !important;
      border-color: #d1d5db !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
    }

    #inventoryList .exit-btn:hover::before {
      color: #374151 !important;
    }

    #inventoryList .close {
      background: #f3f4f6 !important;
      color: transparent !important;
      border: 1px solid #e5e7eb !important;
      width: 36px !important;
      height: 36px !important;
      border-radius: 6px !important;
      font-size: 0 !important;
      font-weight: 700 !important;
      cursor: pointer !important;
      transition: all 0.2s !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 !important;
      white-space: nowrap !important;
      flex-shrink: 0 !important;
      position: relative !important;
    }

    #inventoryList .close::before {
      content: "✕" !important;
      font-size: 18px !important;
      color: #6b7280 !important;
      position: absolute !important;
      font-family: Arial, sans-serif !important;
      font-weight: bold !important;
    }

    #inventoryList .close:hover {
      background: #e5e7eb !important;
      border-color: #d1d5db !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
    }

    #inventoryList .close:hover::before {
      color: #374151 !important;
    }

    #inventoryList [class*="secure"] {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      padding: 12px 16px;
      border-radius: 8px;
      color: #15803d;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    

    #inventoryList article,
    #inventoryList section {
      margin-bottom: 0;
    }

    /* Responsive adjustments for inventory cards */
    @media (max-width: 1200px) {
      #inventoryList [class*="card"] {
        grid-template-columns: 1fr auto;
      }
    }

    @media (max-width: 1024px) {
      #inventoryList [class*="card"] {
        grid-template-columns: 1fr;
      }

      #inventoryList [class*="item-info"],
      #inventoryList [class*="info-group"] {
        grid-column: 1;
      }

      #inventoryList [class*="secure"],
      #inventoryList a[class*="close"],
      #inventoryList button {
        justify-self: start;
      }
    }

    @media print {
      body { background: white; }
      .receipt-actions { display: none; }
      .receipt-modal { background: none; }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 24px;
      }

      .card-custom {
        padding: 20px;
      }

      .transaction-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .receipt-content {
        padding: 24px;
      }

      #inventoryList [class*="card"] {
        padding: 16px;
        gap: 16px;
      }

      .application-card {
        flex-direction: column;
        align-items: flex-start;
      }

      .application-header {
        width: 100%;
        justify-content: space-between;
      }

      .receipt-btn {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .transaction-card > div {
        flex-direction: column !important;
        align-items: stretch !important;
      }

      .receipt-btn {
        align-self: stretch;
        width: 100%;
      }

      .transaction-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      #inventoryList [class*="card"] {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      #inventoryList [class*="secure"],
      #inventoryList a[class*="close"],
      #inventoryList button {
        justify-self: start;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 20px;
      }

      .card-custom {
        padding: 16px;
        border-radius: 12px;
      }

      .transaction-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .transaction-details {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .tabs-container {
        gap: 4px;
        margin-bottom: 20px;
      }

      .tab-btn {
        padding: 10px 14px;
        font-size: 12px;
      }

      .receipt-modal {
        padding: 20px;
      }

      .receipt-content {
        width: 100%;
        padding: 20px;
      }

      .application-card {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px 16px;
      }

      .application-header {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }

      .receipt-btn {
        width: 100%;
      }

      #inventoryList [class*="card"] {
        flex-direction: column;
        padding: 16px;
        gap: 12px;
      }

      #inventoryList [class*="item-info"],
      #inventoryList [class*="info-group"] {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  {% include 'user/header.html' %}

  <div class="container mx-auto px-4 sm:px-6 py-6 sm:py-10">
    <div class="max-w-6xl mx-auto">

      <!-- Header -->
      <div class="mb-6 sm:mb-10">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-black uppercase tracking-tight text-green-800 mb-2">
          <i class="fa-solid fa-history mr-2"></i>History
        </h1>
        <p class="text-gray-500 font-bold uppercase tracking-widest text-[9px] sm:text-[10px]">
          View your submitted applications, services, and inventory records
        </p>
      </div>

      <!-- Download Buttons -->
      <div class="flex flex-wrap gap-2 sm:gap-3 mb-6">
        <button onclick="downloadApplicationsPDF()" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold text-[10px] sm:text-xs rounded-lg transition-all transform active:scale-95 uppercase tracking-wider">
          <i class="fa-solid fa-download"></i> <span class="hidden sm:inline">Applications</span>
        </button>
        <button onclick="downloadServiceRequestsPDF()" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white font-bold text-[10px] sm:text-xs rounded-lg transition-all transform active:scale-95 uppercase tracking-wider">
          <i class="fa-solid fa-download"></i> <span class="hidden sm:inline">Services</span>
        </button>
        <button onclick="downloadInventoryHistoryPDF()" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-bold text-[10px] sm:text-xs rounded-lg transition-all transform active:scale-95 uppercase tracking-wider">
          <i class="fa-solid fa-download"></i> <span class="hidden sm:inline">Inventory</span>
        </button>
      </div>

      <!-- History Records -->
      <div id="historyContainer" class="space-y-3 sm:space-y-4"></div>

    </div>
  </div>

  <!-- Receipt Modal -->
  <div class="receipt-modal fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4" id="receiptModal">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="border-b border-gray-200 p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-black uppercase text-green-800">Receipt</h2>
      </div>
      
      <div class="p-4 sm:p-6 space-y-4 text-sm">
        <div>
          <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Date</label>
          <p id="receiptDate" class="text-gray-800 font-semibold">-</p>
        </div>
        <div>
          <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Reference</label>
          <p id="receiptReference" class="text-gray-800 font-semibold text-xs break-all">-</p>
        </div>
        <div>
          <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Type</label>
          <p id="receiptPermitType" class="text-gray-800 font-semibold">-</p>
        </div>
        <div>
          <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Amount</label>
          <p id="receiptAmount" class="text-lg font-bold text-green-700">₱0.00</p>
        </div>
        <div class="border-t border-gray-200 pt-4">
          <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Status</label>
          <p id="receiptStatus" class="text-green-700 font-bold">Approved</p>
        </div>
      </div>
      
      <div class="border-t border-gray-200 p-4 sm:p-6 flex gap-3">
        <button onclick="window.print()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-xs transition-all">
          <i class="fa-solid fa-print mr-1"></i> Print
        </button>
        <button onclick="closeReceipt()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-xs transition-all">
          <i class="fa-solid fa-xmark mr-1"></i> Close
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, onAuthStateChanged } from "{{ url_for('static', filename='js/firebase-config.js') }}";
    import { query, where, getDocs, collection, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const peso = new Intl.NumberFormat("en-PH", { style: "currency", currency: "PHP" });

    // Tab switching removed - all sections displayed at once
    
    async function loadHistory() {
      try {
        const historyContainer = document.getElementById('historyContainer');
        
        // Show loading state
        historyContainer.innerHTML = `
          <div class="text-center py-12">
            <i class="fa-solid fa-spinner fa-spin text-2xl sm:text-3xl text-green-700 mb-4" style="display: block;"></i>
            <p class="text-gray-500 font-bold uppercase text-[10px] tracking-widest">Loading history...</p>
          </div>
        `;

        const user = auth.currentUser;
        console.log('Current user:', user);
        
        if (!user) {
          historyContainer.innerHTML = `
            <div class="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
              <i class="fa-solid fa-exclamation-circle text-3xl text-gray-300 mb-4" style="display: block;"></i>
              <p class="text-gray-600 font-bold uppercase text-[10px] tracking-widest">Please sign in to view history</p>
            </div>
          `;
          return;
        }

        // Load all three data sources in parallel
        console.log('Loading data from all sources...');
        const [applicationsData, servicesData, inventoryData] = await Promise.all([
          loadApplicationsData(user),
          loadServiceRequestsData(user),
          loadInventoryData(user)
        ]);

        console.log('Applications:', applicationsData.length);
        console.log('Services:', servicesData.length);
        console.log('Inventory:', inventoryData.length);

        // Combine all items
        const allItems = [...applicationsData, ...servicesData, ...inventoryData];
        console.log('Total items:', allItems.length);
        
        if (allItems.length === 0) {
          historyContainer.innerHTML = `
            <div class="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
              <i class="fa-solid fa-inbox text-3xl text-gray-300 mb-4" style="display: block;"></i>
              <p class="text-gray-600 font-bold uppercase text-[10px] tracking-widest">No records found</p>
            </div>
          `;
          return;
        }

        // Sort by date (newest first)
        allItems.sort((a, b) => {
          const dateA = a.date instanceof Date ? a.date : new Date(a.date);
          const dateB = b.date instanceof Date ? b.date : new Date(b.date);
          return dateB - dateA;
        });

        // Render all items
        let html = '';
        allItems.forEach(item => {
          html += item.html;
        });

        historyContainer.innerHTML = html;
      } catch (error) {
        console.error('Error loading history:', error);
        document.getElementById('historyContainer').innerHTML = `
          <div class="empty-message">
            <i class="fa-solid fa-exclamation-triangle" style="color: #ef4444;"></i>
            <p style="color: #ef4444;">Error loading history: ${error.message}</p>
          </div>
        `;
      }
    }

    async function loadApplicationsData(user) {
      try {
        const applications = [];

        // Load from Firebase applications collection
        try {
          console.log('Loading applications from Firebase for user:', user.uid);
          const appsQuery = query(
            collection(db, 'applications'),
            where('userId', '==', user.uid)
          );
          const appsSnapshot = await getDocs(appsQuery);
          
          console.log('Firebase applications found:', appsSnapshot.size);

          const categoryLabels = {
            'farming': 'Crop & Plant',
            'livestock': 'Fisheries & Agriculture',
            'agribusiness': 'Agribusiness & Agro-Processing',
            'trade': 'Agricultural Trade',
            'infrastructure': 'Infrastructure',
            'research': 'Research & Innovation',
            'support': 'Support & Insurance',
            'safety': 'Food Safety',
            'extension': 'Extension Services',
            'climate': 'Climate & Risk',
            'data': 'Digital Agriculture',
            'compliance': 'Compliance & Enforcement',
            'institutional': 'Cooperative Development'
          };

          appsSnapshot.forEach((doc) => {
            const app = doc.data();
            console.log(`Application: ${app.category} | Status: ${app.status}`);
            
            // Show all applications regardless of status
            const categoryLabel = categoryLabels[app.category] || app.category || 'Application';
            const date = app.submittedAt ? new Date(app.submittedAt.toDate()).toLocaleDateString('en-PH', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            }) : 'N/A';
            
            const statusInfo = getStatusInfo(app.status);
            
            applications.push({
              date: app.submittedAt || new Date(),
              html: `
                <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-5 hover:border-blue-500 transition-all">
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3 pb-3 border-b border-gray-100">
                    <div class="flex items-center gap-2">
                      <span class="status-badge ${statusInfo.bgClass} ${statusInfo.textClass} text-xs font-bold px-2.5 py-1 rounded">${categoryLabel}</span>
                      <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">${date}</span>
                    </div>
                    <a href="/user/inventory/stock-info?id=${doc.id}" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 transition">
                      <i class="fa-solid fa-eye mr-1"></i> View Details
                    </a>
                  </div>
                  <div class="space-y-2">
                    <div>
                      <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Category</p>
                      <p class="text-sm font-bold text-gray-800">${categoryLabel}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3 sm:gap-4">
                      <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Investment</p>
                        <p class="text-sm font-bold text-blue-700">₱${Number(app.investmentQty || 0).toLocaleString()}</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Harvest Qty</p>
                        <p class="text-xs font-mono text-gray-700">${Number(app.harvestQty || 0).toLocaleString()} units</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Status</p>
                        <p class="text-xs font-bold ${statusInfo.textClass}">${statusInfo.label}</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">ID</p>
                        <p class="text-xs font-semibold text-gray-700">${doc.id.substring(0, 8)}</p>
                      </div>
                    </div>
                  </div>
                </div>
              `
            });
          });
        } catch (fbError) {
          console.error('Error loading from Firebase applications:', fbError);
        }

        // Also load from payment transactions API
        try {
          let userEmail = null;

          await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              if (user && user.email) {
                userEmail = user.email;
              }
              unsubscribe();
              resolve();
            });
          });

          if (!userEmail) {
            userEmail = (localStorage.getItem('denr_user_email') || '').trim();
          }

          console.log('Loading payment transactions for email:', userEmail);

          if (userEmail) {
            const response = await fetch(`/api/payments/transactions?email=${encodeURIComponent(userEmail)}`);
            const result = await response.json();

            console.log('API Response:', result);

            if (result.status === 'success' && result.transactions && Array.isArray(result.transactions)) {
              console.log('All transactions:', result.transactions);
              
              const approvedApps = result.transactions.filter(t => {
                const displayStatus = (t.display_status || '').toLowerCase();
                const status = (t.status || '').toLowerCase();
                const approvalStatus = (t.approval_status || '').toLowerCase();
                const combined = displayStatus || status || approvalStatus;
                
                const isApproved = 
                  combined === 'approved' || 
                  combined === 'paid' || 
                  combined === 'completed' || 
                  combined === 'success' ||
                  combined === 'pending_payment' ||
                  combined === 'paid_at' ||
                  t.paid_at !== null || 
                  t.paid_at !== undefined ||
                  t.amount > 0;
                
                const isNotService = !isServiceTransaction(t);
                console.log(`Transaction: ${t.transaction_name} | Status: ${combined} | Amount: ${t.amount} | Approved: ${isApproved} | NotService: ${isNotService}`);
                return isApproved && isNotService;
              });

              console.log('Filtered payment transactions:', approvedApps.length);

              approvedApps.forEach(t => {
                const date = t.created_at ? new Date(t.created_at).toISOString().split('T')[0] : 'N/A';
                const updated = t.updated_at ? new Date(t.updated_at).toLocaleString() : 'N/A';
                const appType = t.transaction_type || extractAppType(t.transaction_name) || 'License/Permit';
                const appDescription = t.transaction_name || 'Unknown Application';
                const appAmount = peso.format(t.amount || 0);
                
                applications.push({
                  date: t.created_at || new Date(),
                  html: `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-5 hover:border-blue-500 transition-all">
                      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3 pb-3 border-b border-gray-100">
                        <div class="flex items-center gap-2">
                          <span class="status-badge bg-blue-100 text-blue-700 text-xs font-bold px-2.5 py-1 rounded">${appType}</span>
                          <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">${date}</span>
                        </div>
                        <button onclick="viewReceipt('${t.reference || t.external_id}', '${(t.transaction_name || 'Unknown').replace(/'/g, "\\'")}', '${date}', '${peso.format(t.amount || 0)}', '${(t.description || '').replace(/'/g, "\\'")}', '${t.invoice_id || 'N/A'}', '${t.payment_method || 'Online Payment'}', '${updated}')" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 transition">
                          <i class="fa-solid fa-receipt mr-1"></i> Receipt
                        </button>
                      </div>
                      <div class="space-y-2">
                        <div>
                          <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Description</p>
                          <p class="text-sm font-bold text-gray-800">${appDescription}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3 sm:gap-4">
                          <div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Amount</p>
                            <p class="text-sm font-bold text-blue-700">${appAmount}</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Reference</p>
                            <p class="text-xs font-mono text-gray-700 break-all">${t.reference || t.external_id || 'N/A'}</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Status</p>
                            <p class="text-xs font-bold text-green-700">PAID</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Method</p>
                            <p class="text-xs font-semibold text-gray-700">${t.payment_method || 'Online'}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  `
                });
              });
            }
          }
        } catch (apiError) {
          console.error('Error loading from payment API:', apiError);
        }

        console.log('Total applications loaded:', applications.length);
        return applications;
      } catch (error) {
        console.error('Error loading applications:', error);
        return [];
      }
    }

    function getStatusInfo(status) {
      const statusMap = {
        'approved': { label: 'APPROVED', bgClass: 'bg-green-100', textClass: 'text-green-700' },
        'pending': { label: 'PENDING', bgClass: 'bg-yellow-100', textClass: 'text-yellow-700' },
        'under-review': { label: 'UNDER REVIEW', bgClass: 'bg-blue-100', textClass: 'text-blue-700' },
        'rejected': { label: 'REJECTED', bgClass: 'bg-red-100', textClass: 'text-red-700' },
        'cancelled': { label: 'CANCELLED', bgClass: 'bg-gray-100', textClass: 'text-gray-700' }
      };
      return statusMap[status] || { label: status?.toUpperCase() || 'UNKNOWN', bgClass: 'bg-gray-100', textClass: 'text-gray-700' };
    }

    async function loadServiceRequestsData(user) {
      try {
        console.log('Loading service requests for user:', user.uid);
        
        const q = query(
          collection(db, 'service_requests'),
          where('userId', '==', user.uid)
        );

        const querySnapshot = await getDocs(q);
        console.log('Service requests found:', querySnapshot.size);
        
        const services = [];
        
        querySnapshot.forEach((doc) => {
          const item = doc.data();
          const status = (item.status || '').toLowerCase();
          const paymentStatus = (item.paymentStatus || '').toLowerCase();
          console.log(`Service: ${item.description || item.serviceType} | Status: ${status} | PaymentStatus: ${paymentStatus} | Full: ${JSON.stringify(Object.keys(item))}`);
          
          // Show services that are approved, have completed payment, or are submitted
          // More lenient filtering to catch more records
          const isApprovedOrCompleted = 
            status === 'approved' || 
            status === 'pending' ||
            status === 'submitted' ||
            paymentStatus === 'completed' || 
            paymentStatus === 'paid' ||
            paymentStatus === 'free' ||
            item.createdAt !== null || 
            item.createdAt !== undefined;
          
          if (isApprovedOrCompleted) {
            services.push({
              id: doc.id,
              ...item
            });
          }
        });

        console.log('Approved services:', services.length);

        services.sort((a, b) => {
          const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
          return dateB - dateA;
        });

        return services.map(service => {
          const date = service.createdAt ? new Date(service.createdAt).toLocaleDateString('en-PH', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          }) : 'N/A';
          
          const serviceType = service.serviceType || 'Service Request';
          const status = (service.status || 'Unknown').toUpperCase();
          const description = service.description || 'No description provided';

          return {
            date: service.createdAt || new Date(),
            html: `
              <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-5 hover:border-green-500 transition-all">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3 pb-3 border-b border-gray-100">
                  <div class="flex items-center gap-2">
                    <span class="status-badge bg-gray-200 text-gray-700 text-xs font-bold px-2.5 py-1 rounded">${serviceType}</span>
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">${date}</span>
                  </div>
                  <span class="text-[10px] font-bold text-green-700 bg-green-50 px-2.5 py-1 rounded">${status}</span>
                </div>
                <div class="space-y-2">
                  <div>
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Description</p>
                    <p class="text-sm font-bold text-gray-800">${description}</p>
                  </div>
                  <div class="grid grid-cols-2 gap-3 sm:gap-4 text-xs">
                    <div>
                      <p class="text-gray-500 font-bold uppercase tracking-widest mb-0.5">Type</p>
                      <p class="font-semibold text-gray-700">${serviceType}</p>
                    </div>
                    <div>
                      <p class="text-gray-500 font-bold uppercase tracking-widest mb-0.5">Status</p>
                      <p class="font-bold text-green-700">${status}</p>
                    </div>
                  </div>
                </div>
              </div>
            `
          };
        });
      } catch (error) {
        console.error('Error loading services:', error);
        return [];
      }
    }

    async function loadInventoryData(user) {
      try {
        console.log('Loading inventory for user:', user.uid);
        
        // Query ALL inventory items (not just approved) to see what's there
        const q = query(
          collection(db, 'inventory_registrations'), 
          where('userId', '==', user.uid)
        );
        
        const querySnapshot = await getDocs(q);
        console.log('Inventory items found:', querySnapshot.size);
        querySnapshot.forEach((doc) => {
          const item = doc.data();
          console.log(`Inventory: ${item.category || 'Unknown'} | Status: ${item.status || 'No status'} | Full: ${JSON.stringify(Object.keys(item))}`);
        });
        
        // Filter to approved items
        const approvedQuery = query(
          collection(db, 'inventory_registrations'), 
          where('userId', '==', user.uid),
          where('status', '==', 'approved')
        );
        
        const approvedSnapshot = await getDocs(approvedQuery);
        console.log('Approved inventory items:', approvedSnapshot.size);

        const categoryLabels = {
          'farming': 'Crop & Plant',
          'livestock': 'Fisheries & Agriculture',
          'agribusiness': 'Agribusiness & Agro-Processing',
          'trade': 'Agricultural Trade',
          'infrastructure': 'Infrastructure',
          'research': 'Research & Innovation',
          'support': 'Support & Insurance',
          'safety': 'Food Safety',
          'extension': 'Extension Services',
          'climate': 'Climate & Risk',
          'data': 'Digital Agriculture',
          'compliance': 'Compliance & Enforcement',
          'institutional': 'Cooperative Development'
        };

        const sortedDocs = [];
        approvedSnapshot.forEach(doc => sortedDocs.push(doc));
        sortedDocs.sort((a, b) => {
          const aTime = a.data().submittedAt?.toDate?.() || new Date(0);
          const bTime = b.data().submittedAt?.toDate?.() || new Date(0);
          return bTime - aTime;
        });

        console.log('Sorted inventory:', sortedDocs.length);

        return sortedDocs.map((doc, index) => {
          const item = doc.data();
          const categoryLabel = categoryLabels[item.category] || item.category || 'Product';
          const submittedDate = item.submittedAt ? new Date(item.submittedAt.toDate()).toLocaleDateString('en-PH', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          }) : 'N/A';

          return {
            date: item.submittedAt || new Date(),
            html: `
              <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-5 hover:border-amber-500 transition-all">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3 pb-3 border-b border-gray-100">
                  <div class="flex items-center gap-2">
                    <span class="status-badge bg-amber-100 text-amber-700 text-xs font-bold px-2.5 py-1 rounded">Inventory</span>
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">${submittedDate}</span>
                  </div>
                  <a href="/user/inventory/stock-info?id=${doc.id}" class="text-[10px] font-bold text-amber-600 hover:text-amber-800 transition">
                    <i class="fa-solid fa-eye mr-1"></i> View Details
                  </a>
                </div>
                <div class="space-y-2">
                  <div>
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-0.5">Category</p>
                    <p class="text-sm font-bold text-gray-800">${categoryLabel}</p>
                  </div>
                  <div class="grid grid-cols-2 gap-3 sm:gap-4 text-xs">
                    <div>
                      <p class="text-gray-500 font-bold uppercase tracking-widest mb-0.5">Harvest Qty</p>
                      <p class="font-bold text-amber-700">${Number(item.harvestQty || 0).toLocaleString()} units</p>
                    </div>
                    <div>
                      <p class="text-gray-500 font-bold uppercase tracking-widest mb-0.5">Investment Value</p>
                      <p class="font-bold text-amber-700">₱${Number(item.investmentQty || 0).toLocaleString()}</p>
                    </div>
                    <div>
                      <p class="text-gray-500 font-bold uppercase tracking-widest mb-0.5">Status</p>
                      <p class="font-bold text-green-700">APPROVED</p>
                    </div>
                    <div>
                      <p class="text-gray-500 font-bold uppercase tracking-widest mb-0.5">Unit Price</p>
                      <p class="font-semibold text-gray-700">₱${item.harvestQty > 0 ? (Number(item.investmentQty || 0) / Number(item.harvestQty)).toFixed(2) : '0.00'}</p>
                    </div>
                  </div>
                </div>
              </div>
            `
          };
        });
      } catch (error) {
        console.error('Error loading inventory:', error);
        return [];
      }
    }

    function extractAppType(transactionName) {
      if (!transactionName) return null;
      
      const name = transactionName.toLowerCase();
      
      if (name.includes('fisheries') || name.includes('fish')) return 'Fisheries License';
      if (name.includes('forest') || name.includes('timber')) return 'Forest Permit';
      if (name.includes('wildlife')) return 'Wildlife Permit';
      if (name.includes('livestock') || name.includes('farm')) return 'Livestock Permit';
      if (name.includes('environmental')) return 'Environmental Clearance';
      if (name.includes('permit')) return 'Permit';
      if (name.includes('license')) return 'License';
      
      return 'License/Permit';
    }

    function isServiceTransaction(transaction) {
      const name = (transaction.transaction_name || '').toLowerCase();
      const description = (transaction.description || '').toLowerCase();
      const externalId = (transaction.external_id || transaction.reference || '').toLowerCase();

      if (externalId.startsWith('service-')) return true;

      const serviceKeywords = [
        'service', 'compensation', 'pest', 'typhoon',
        'compliance', 'disease', 'visit', 'farm',
        'fertilizer', 'financial', 'seminar'
      ];

      return serviceKeywords.some(keyword =>
        name.includes(keyword) || description.includes(keyword)
      );
    }


    window.viewReceipt = function(reference, permitType, date, amount, description, invoiceId, method, updated) {
      document.getElementById('receiptReference').textContent = reference;
      document.getElementById('receiptPermitType').textContent = permitType;
      document.getElementById('receiptDate').textContent = date;
      document.getElementById('receiptAmount').textContent = amount;
      document.getElementById('receiptDescription').textContent = description || 'DENR License/Permit Payment';
      document.getElementById('receiptStatus').textContent = 'Approved';
      document.getElementById('receiptModal').classList.remove('hidden');
      document.getElementById('receiptModal').classList.add('flex');
    };

    window.closeReceipt = function() {
      document.getElementById('receiptModal').classList.add('hidden');
      document.getElementById('receiptModal').classList.remove('flex');
    };

    document.getElementById('receiptModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeReceipt();
      }
    });

    window.downloadApplicationsPDF = async function() {
      try {
        const user = auth.currentUser;
        if (!user) {
          alert('Please sign in to download applications.');
          return;
        }

        const approvedApps = [];

        // Load from Firebase applications collection
        try {
          const appsQuery = query(
            collection(db, 'applications'),
            where('userId', '==', user.uid)
          );
          const appsSnapshot = await getDocs(appsQuery);
          
          const categoryLabels = {
            'farming': 'Crop & Plant',
            'livestock': 'Fisheries & Agriculture',
            'agribusiness': 'Agribusiness & Agro-Processing',
            'trade': 'Agricultural Trade',
            'infrastructure': 'Infrastructure',
            'research': 'Research & Innovation',
            'support': 'Support & Insurance',
            'safety': 'Food Safety',
            'extension': 'Extension Services',
            'climate': 'Climate & Risk',
            'data': 'Digital Agriculture',
            'compliance': 'Compliance & Enforcement',
            'institutional': 'Cooperative Development'
          };

          appsSnapshot.forEach((doc) => {
            const app = doc.data();
            const categoryLabel = categoryLabels[app.category] || app.category || 'Application';
            const date = app.submittedAt ? new Date(app.submittedAt.toDate()).toLocaleDateString('en-PH') : 'N/A';
            const status = (app.status || 'Unknown').toUpperCase();
            
            approvedApps.push({
              date: app.submittedAt || new Date(),
              type: categoryLabel,
              description: categoryLabel + ' Application',
              amount: app.investmentQty || 0,
              status: status,
              source: 'firebase',
              harvestQty: app.harvestQty || 0
            });
          });
        } catch (fbError) {
          console.error('Error loading from Firebase:', fbError);
        }

        // Also load from payment transactions API
        try {
          let userEmail = user.email || localStorage.getItem('denr_user_email') || '';
          
          if (userEmail) {
            const response = await fetch(`/api/payments/transactions?email=${encodeURIComponent(userEmail)}`);
            const result = await response.json();

            if (result.status === 'success' && result.transactions && Array.isArray(result.transactions)) {
              const paymentApps = result.transactions.filter(t => {
                const status = (t.display_status || t.status || t.approval_status || '').toLowerCase();
                const isApproved = status === 'approved' || status === 'paid' || status === 'pending_payment';
                const isNotService = !isServiceTransaction(t);
                return isApproved && isNotService;
              });

              paymentApps.forEach(t => {
                const appType = extractAppType(t.transaction_name) || 'License/Permit';
                approvedApps.push({
                  date: t.created_at || new Date(),
                  type: appType,
                  description: t.transaction_name || 'Unknown Application',
                  amount: t.amount || 0,
                  status: 'PAID',
                  source: 'payment',
                  reference: t.reference || t.external_id
                });
              });
            }
          }
        } catch (apiError) {
          console.error('Error loading from payment API:', apiError);
        }

        if (approvedApps.length === 0) {
          alert('No applications to download.');
          return;
        }

        // Sort by date
        approvedApps.sort((a, b) => {
          const dateA = a.date instanceof Date ? a.date : new Date(a.date);
          const dateB = b.date instanceof Date ? b.date : new Date(b.date);
          return dateB - dateA;
        });

        const pdfContainer = document.createElement('div');
        pdfContainer.style.padding = '20px';
        pdfContainer.style.backgroundColor = '#ffffff';
        pdfContainer.style.fontFamily = 'Arial, sans-serif';
        
        const header = document.createElement('div');
        header.style.textAlign = 'center';
        header.style.marginBottom = '20px';
        header.style.borderBottom = '3px solid #3b82f6';
        header.style.paddingBottom = '15px';
        
        header.innerHTML = `
          <h1 style="color: #1b330d; font-size: 22px; margin: 0; font-weight: 800;">DENR Applications Report</h1>
          <p style="color: #6b7280; margin: 4px 0 0 0; font-size: 12px;">Department of Environment and Natural Resources</p>
          <p style="color: #9ca3af; margin: 2px 0 0 0; font-size: 11px;">Generated: ${new Date().toLocaleString()}</p>
          <p style="color: #9ca3af; margin: 2px 0 0 0; font-size: 11px;">Total Applications: ${approvedApps.length}</p>
        `;
        pdfContainer.appendChild(header);

        const detailsSection = document.createElement('div');
        detailsSection.style.marginTop = '15px';

        approvedApps.forEach((app, idx) => {
          const date = app.date instanceof Date ? app.date.toLocaleDateString('en-PH', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          }) : new Date(app.date).toLocaleDateString('en-PH', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
          
          const appCard = document.createElement('div');
          appCard.style.marginBottom = '15px';
          appCard.style.padding = '12px';
          appCard.style.border = '1px solid #e5e7eb';
          appCard.style.borderRadius = '6px';
          appCard.style.backgroundColor = '#f9fafb';
          appCard.style.pageBreakInside = 'avoid';

          let detailsHtml = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #3b82f6;">
              <div>
                <span style="display: inline-block; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; margin-bottom: 4px;">${app.type}</span>
                <h3 style="color: #1b330d; font-size: 13px; font-weight: 700; margin: 4px 0 0 0;">${app.description}</h3>
              </div>
              <span style="color: #6b7280; font-weight: 600; font-size: 11px;">App #${idx + 1}</span>
            </div>
            
            <div style="background: white; padding: 10px; border-radius: 4px; font-size: 11px;">
              <p style="color: #6b7280; margin: 0;"><strong>Status:</strong> <span style="color: #059669; font-weight: 700;">${app.status}</span></p>
              <p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Date:</strong> ${date}</p>
              <p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Amount:</strong> ₱${Number(app.amount || 0).toLocaleString()}</p>`;
          
          if (app.harvestQty) {
            detailsHtml += `<p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Harvest Qty:</strong> ${Number(app.harvestQty).toLocaleString()} units</p>`;
          }
          
          if (app.reference) {
            detailsHtml += `<p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Reference:</strong> ${app.reference}</p>`;
          }
          
          detailsHtml += `
              <p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Email:</strong> ${user.email || 'N/A'}</p>
            </div>
          `;
          
          appCard.innerHTML = detailsHtml;
          detailsSection.appendChild(appCard);
        });

        pdfContainer.appendChild(detailsSection);

        const element = document.createElement('div');
        element.appendChild(pdfContainer);
        document.body.appendChild(element);

        const opt = {
          margin: 10,
          filename: `denr-applications-report-${new Date().getTime()}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        };

        html2pdf().set(opt).from(element).save().finally(() => {
          document.body.removeChild(element);
        });
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF: ' + error.message);
      }
    };

    // Inventory History Download PDF
    window.downloadInventoryHistoryPDF = async function() {
      try {
        const downloadBtn = document.getElementById('downloadInventoryPdfBtn');
        if (downloadBtn) {
          downloadBtn.disabled = true;
          downloadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
        }

        const user = auth.currentUser;
        if (!user) {
          alert('Please sign in to download inventory history.');
          return;
        }

        const q = query(
          collection(db, 'inventory_registrations'), 
          where('userId', '==', user.uid),
          where('status', '==', 'approved')
        );
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          alert('No inventory items to download.');
          if (downloadBtn) {
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i> Download PDF';
          }
          return;
        }

        const categoryLabels = {
          'farming': 'Crop & Plant',
          'livestock': 'Fisheries & Agriculture',
          'agribusiness': 'Agribusiness & Agro-Processing',
          'trade': 'Agricultural Trade',
          'infrastructure': 'Infrastructure',
          'research': 'Research & Innovation',
          'support': 'Support & Insurance',
          'safety': 'Food Safety',
          'extension': 'Extension Services',
          'climate': 'Climate & Risk',
          'data': 'Digital Agriculture',
          'compliance': 'Compliance & Enforcement',
          'institutional': 'Cooperative Development'
        };

        const inventoryItems = [];
        let totalInvestment = 0;
        
        const sortedDocs = [];
        querySnapshot.forEach(doc => sortedDocs.push(doc));
        sortedDocs.sort((a, b) => {
          const aTime = a.data().submittedAt?.toDate?.() || new Date(0);
          const bTime = b.data().submittedAt?.toDate?.() || new Date(0);
          return bTime - aTime;
        });
        
        sortedDocs.forEach((doc) => {
          const item = doc.data();
          const categoryLabel = categoryLabels[item.category] || item.category || 'Product';
          const unitPrice = item.harvestQty > 0 ? (item.investmentQty / item.harvestQty).toFixed(2) : '0.00';
          const submittedDate = item.submittedAt ? new Date(item.submittedAt.toDate()).toLocaleDateString('en-PH') : 'N/A';
          
          totalInvestment += Number(item.investmentQty || 0);
          
          inventoryItems.push({
            id: doc.id,
            category: categoryLabel,
            harvestQty: Number(item.harvestQty || 0),
            investment: Number(item.investmentQty || 0),
            unitPrice: unitPrice,
            date: submittedDate
          });
        });

        const pdfContainer = document.createElement('div');
        pdfContainer.style.padding = '15px';
        pdfContainer.style.backgroundColor = '#ffffff';
        pdfContainer.style.fontFamily = 'Arial, sans-serif';
        pdfContainer.style.lineHeight = '1.3';
        
        const header = document.createElement('div');
        header.style.textAlign = 'center';
        header.style.marginBottom = '12px';
        header.style.borderBottom = '2px solid #10b981';
        header.style.paddingBottom = '8px';
        
        header.innerHTML = `
          <h1 style="color: #1b330d; font-size: 20px; margin: 0; font-weight: 800;">DENR Inventory Transaction History</h1>
          <p style="color: #6b7280; margin: 4px 0 0 0; font-size: 12px;">Department of Environment and Natural Resources</p>
          <p style="color: #9ca3af; margin: 2px 0 0 0; font-size: 10px;">Generated: ${new Date().toLocaleString()}</p>
        `;
        pdfContainer.appendChild(header);

        const stats = document.createElement('div');
        stats.style.display = 'grid';
        stats.style.gridTemplateColumns = 'repeat(3, 1fr)';
        stats.style.gap = '8px';
        stats.style.marginBottom = '12px';
        
        stats.innerHTML = `
          <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; border-left: 3px solid #10b981; text-align: center;">
            <p style="color: #6b7280; font-size: 10px; margin: 0; text-transform: uppercase; font-weight: 700;">Total Items</p>
            <h3 style="color: #10b981; font-size: 18px; margin: 4px 0 0 0; font-weight: 800;">${inventoryItems.length}</h3>
          </div>
          <div style="background: #eff6ff; padding: 10px; border-radius: 6px; border-left: 3px solid #3b82f6; text-align: center;">
            <p style="color: #6b7280; font-size: 10px; margin: 0; text-transform: uppercase; font-weight: 700;">Status</p>
            <h3 style="color: #3b82f6; font-size: 18px; margin: 4px 0 0 0; font-weight: 800;">Active</h3>
          </div>
          <div style="background: #fef3c7; padding: 10px; border-radius: 6px; border-left: 3px solid #f59e0b; text-align: center;">
            <p style="color: #6b7280; font-size: 10px; margin: 0; text-transform: uppercase; font-weight: 700;">Total Value</p>
            <h3 style="color: #f59e0b; font-size: 14px; margin: 4px 0 0 0; font-weight: 800;">₱${totalInvestment.toLocaleString()}</h3>
          </div>
        `;
        pdfContainer.appendChild(stats);

        const detailsSection = document.createElement('div');
        detailsSection.style.marginTop = '12px';
        
        const detailsTitle = document.createElement('h2');
        detailsTitle.innerHTML = 'Inventory Details';
        detailsTitle.style.color = '#1b330d';
        detailsTitle.style.fontSize = '14px';
        detailsTitle.style.fontWeight = '800';
        detailsTitle.style.borderBottom = '2px solid #10b981';
        detailsTitle.style.paddingBottom = '6px';
        detailsTitle.style.marginBottom = '10px';
        detailsSection.appendChild(detailsTitle);

        inventoryItems.forEach((item, idx) => {
          const itemCard = document.createElement('div');
          itemCard.style.marginBottom = '12px';
          itemCard.style.padding = '10px';
          itemCard.style.border = '1px solid #e5e7eb';
          itemCard.style.borderRadius = '6px';
          itemCard.style.backgroundColor = '#f9fafb';
          itemCard.style.pageBreakInside = 'avoid';
          itemCard.style.fontSize = '11px';

          itemCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #10b981;">
              <div>
                <span style="display: inline-block; padding: 4px 8px; background: #d1fae5; color: #047857; border-radius: 4px; font-weight: 700; font-size: 9px; text-transform: uppercase; margin-bottom: 4px;">${item.category}</span>
                <h3 style="color: #1b330d; font-size: 12px; font-weight: 700; margin: 4px 0 0 0;">${item.category} Stock</h3>
              </div>
              <span style="color: #6b7280; font-weight: 600; font-size: 10px;">#INV-${String(idx + 1).padStart(3, '0')}</span>
            </div>
            
            <div style="background: white; padding: 8px; border-radius: 4px; margin-top: 6px; font-size: 10px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div>
                  <p style="color: #6b7280; margin: 0;"><strong>Harvest Qty:</strong> ${item.harvestQty.toLocaleString()} units</p>
                  <p style="color: #6b7280; margin: 4px 0 0 0;"><strong>Investment:</strong> ₱${item.investment.toLocaleString()}</p>
                </div>
                <div>
                  <p style="color: #6b7280; margin: 0;"><strong>Unit Price:</strong> ₱${item.unitPrice}</p>
                  <p style="color: #6b7280; margin: 4px 0 0 0;"><strong>Added:</strong> ${item.date}</p>
                </div>
              </div>

              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                <p style="color: #1b330d; font-size: 9px; font-weight: 700; text-transform: uppercase; margin: 0 0 4px 0;">Item Information</p>
                <div style="background: #f3f4f6; padding: 6px; border-radius: 3px; font-size: 9px; color: #4b5563;">
                  <p style="margin: 0;"><strong>ID:</strong> ${item.id}</p>
                  <p style="margin: 2px 0 0 0;"><strong>Category:</strong> ${item.category}</p>
                  <p style="margin: 2px 0 0 0;"><strong>Status:</strong> <span style="color: #059669; font-weight: 700;">Active</span></p>
                  <p style="margin: 2px 0 0 0;"><strong>User:</strong> ${user.email || 'N/A'}</p>
                </div>
              </div>
            </div>
          `;
          
          detailsSection.appendChild(itemCard);
        });

        pdfContainer.appendChild(detailsSection);

        const footer = document.createElement('div');
        footer.style.marginTop = '12px';
        footer.style.paddingTop = '8px';
        footer.style.borderTop = '1px solid #e5e7eb';
        footer.style.textAlign = 'center';
        footer.style.color = '#6b7280';
        footer.style.fontSize = '10px';
        footer.style.pageBreakInside = 'avoid';
        footer.innerHTML = `
          <p style="margin: 0; line-height: 1.2;">Official DENR Inventory Record | Items: ${inventoryItems.length} | Total Value: ₱${totalInvestment.toLocaleString()}</p>
          <p style="margin: 2px 0 0 0; font-size: 9px; color: #9ca3af;">Document ID: ${Date.now()} | Generated: ${new Date().toLocaleString()}</p>
        `;
        pdfContainer.appendChild(footer);

        const opt = {
          margin: 5,
          filename: `DENR_Inventory_History_${new Date().getTime()}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        };

        html2pdf().set(opt).from(pdfContainer).save();

      } catch (error) {
        console.error('Error generating inventory PDF:', error);
        alert('Failed to generate PDF. Please try again.');
      } finally {
        const downloadBtn = document.getElementById('downloadInventoryPdfBtn');
        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i> Download PDF';
        }
      }
    };

    function generateServiceDetails(service) {
      let detailsHtml = '';
      
      // Common fields
      const excludeFields = ['userId', 'userEmail', 'serviceType', 'status', 'paymentStatus', 'createdAt', 'invoiceId', 'externalId'];
      
      for (const [key, value] of Object.entries(service)) {
        if (excludeFields.includes(key) || !value) continue;
        
        // Format field name
        const fieldName = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        
        // Format value
        let displayValue = value;
        if (Array.isArray(value)) {
          displayValue = value.join(', ');
        } else if (typeof value === 'object') {
          displayValue = JSON.stringify(value);
        }
        
        detailsHtml += `
          <div class="service-detail-item">
            <span class="service-detail-label">${fieldName}</span>
            <span class="service-detail-value">${displayValue}</span>
          </div>
        `;
      }
      
      return detailsHtml || '<p style="color: #9ca3af;">No additional details available.</p>';
    }

    window.toggleServiceDetails = function(serviceId) {
      const detailsElement = document.getElementById(`details-${serviceId}`);
      const button = event.target.closest('button');
      
      if (detailsElement.style.display === 'none') {
        detailsElement.style.display = 'grid';
        button.innerHTML = '<i class="fa-solid fa-eye-slash mr-1"></i> Hide Details';
      } else {
        detailsElement.style.display = 'none';
        button.innerHTML = '<i class="fa-solid fa-eye mr-1"></i> View Details';
      }
    };

    window.retryPayment = async function(serviceId, amount, serviceType, userEmail) {
      try {
        const paymentBtn = document.getElementById(`payment-btn-${serviceId}`);
        if (paymentBtn) {
          paymentBtn.disabled = true;
          paymentBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Processing...';
        }

        const currentUser = auth.currentUser;
        if (!currentUser) {
          alert('Please sign in to complete the payment.');
          return;
        }

        const paymentData = {
          serviceId: serviceId,
          amount: parseFloat(amount) || 0,
          serviceType: serviceType,
          userEmail: userEmail || currentUser.email,
          userId: currentUser.uid,
          timestamp: new Date().toISOString()
        };

        const response = await fetch('/api/payments/service-payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(paymentData)
        });

        const result = await response.json();

        if (result.status === 'success') {
          if (result.paymentUrl) {
            window.location.href = result.paymentUrl;
          } else if (result.invoiceUrl) {
            window.location.href = result.invoiceUrl;
          } else {
            alert('Payment initiated successfully. Please wait for confirmation.');
            setTimeout(() => {
              loadServiceRequests();
            }, 2000);
          }
        } else {
          alert(result.message || 'Failed to initiate payment. Please try again.');
          if (paymentBtn) {
            paymentBtn.disabled = false;
            paymentBtn.innerHTML = '<i class="fa-solid fa-credit-card mr-1"></i> Complete Payment';
          }
        }
      } catch (error) {
        console.error('Error processing payment:', error);
        alert('An error occurred while processing the payment. Please try again.');
        
        const paymentBtn = document.getElementById(`payment-btn-${serviceId}`);
        if (paymentBtn) {
          paymentBtn.disabled = false;
          paymentBtn.innerHTML = '<i class="fa-solid fa-credit-card mr-1"></i> Complete Payment';
        }
      }
    };

    // Wait for Firebase auth to be ready before loading history
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('User authenticated:', user.email);
        loadHistory();
      } else {
        console.log('No user authenticated');
        const historyContainer = document.getElementById('historyContainer');
        historyContainer.innerHTML = `
          <div class="empty-message">
            <i class="fa-solid fa-exclamation-circle"></i>
            <p>Please sign in to view your history.</p>
          </div>
        `;
      }
      unsubscribe(); // Unsubscribe after first check
    });

    // Service Requests Download PDF
    window.downloadServiceRequestsPDF = async function() {
      try {
        const user = auth.currentUser;
        if (!user) {
          alert('Please sign in to download service requests.');
          return;
        }

        const q = query(
          collection(db, 'service_requests'),
          where('userId', '==', user.uid)
        );
        const querySnapshot = await getDocs(q);
        
        const services = [];
        querySnapshot.forEach((doc) => {
          const item = doc.data();
          const status = (item.status || '').toLowerCase();
          const paymentStatus = (item.paymentStatus || '').toLowerCase();
          if (status === 'approved' || paymentStatus === 'completed') {
            services.push({id: doc.id, ...item});
          }
        });

        if (services.length === 0) {
          alert('No service requests to download.');
          return;
        }

        services.sort((a, b) => {
          const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
          return dateB - dateA;
        });

        const pdfContainer = document.createElement('div');
        pdfContainer.style.padding = '20px';
        pdfContainer.style.backgroundColor = '#ffffff';
        pdfContainer.style.fontFamily = 'Arial, sans-serif';
        
        const header = document.createElement('div');
        header.style.textAlign = 'center';
        header.style.marginBottom = '20px';
        header.style.borderBottom = '3px solid #ec4899';
        header.style.paddingBottom = '15px';
        
        header.innerHTML = `
          <h1 style="color: #831843; font-size: 22px; margin: 0; font-weight: 800;">DENR Service Requests Report</h1>
          <p style="color: #6b7280; margin: 4px 0 0 0; font-size: 12px;">Department of Environment and Natural Resources</p>
          <p style="color: #9ca3af; margin: 2px 0 0 0; font-size: 11px;">Generated: ${new Date().toLocaleString()}</p>
        `;
        pdfContainer.appendChild(header);

        const detailsSection = document.createElement('div');
        detailsSection.style.marginTop = '15px';

        services.forEach((service, idx) => {
          const date = service.createdAt ? new Date(service.createdAt).toLocaleDateString('en-PH', {year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A';
          const serviceType = service.serviceType || 'Service Request';
          const status = (service.status || 'Unknown').toUpperCase();
          const description = service.description || 'No description provided';

          const card = document.createElement('div');
          card.style.marginBottom = '15px';
          card.style.padding = '12px';
          card.style.border = '1px solid #e5e7eb';
          card.style.borderRadius = '6px';
          card.style.backgroundColor = '#f9fafb';
          card.style.pageBreakInside = 'avoid';

          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #ec4899;">
              <div>
                <span style="display: inline-block; padding: 4px 8px; background: #fbcfe8; color: #be123c; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; margin-bottom: 4px;">${serviceType}</span>
                <h3 style="color: #1b330d; font-size: 13px; font-weight: 700; margin: 4px 0 0 0;">${description}</h3>
              </div>
              <span style="color: #6b7280; font-weight: 600; font-size: 11px;">Req #${idx + 1}</span>
            </div>
            
            <div style="background: white; padding: 10px; border-radius: 4px; font-size: 11px;">
              <p style="color: #6b7280; margin: 0;"><strong>Status:</strong> <span style="color: #059669; font-weight: 700;">${status}</span></p>
              <p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Service Type:</strong> ${serviceType}</p>
              <p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Date:</strong> ${date}</p>
            </div>
          `;
          
          detailsSection.appendChild(card);
        });

        pdfContainer.appendChild(detailsSection);

        const element = document.createElement('div');
        element.appendChild(pdfContainer);
        document.body.appendChild(element);

        const opt = {
          margin: 10,
          filename: 'denr-service-requests-report.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        };

        html2pdf().set(opt).from(element).save().finally(() => {
          document.body.removeChild(element);
        });
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF. Please try again.');
      }
    };

    // Inventory History Download PDF
    window.downloadInventoryHistoryPDF = async function() {
      try {
        const user = auth.currentUser;
        if (!user) {
          alert('Please sign in to download inventory history.');
          return;
        }

        const q = query(
          collection(db, 'inventory_registrations'), 
          where('userId', '==', user.uid),
          where('status', '==', 'approved')
        );
        const querySnapshot = await getDocs(q);

        const categoryLabels = {
          'farming': 'Crop & Plant',
          'livestock': 'Fisheries & Agriculture',
          'agribusiness': 'Agribusiness & Agro-Processing',
          'trade': 'Agricultural Trade',
          'infrastructure': 'Infrastructure',
          'research': 'Research & Innovation',
          'support': 'Support & Insurance',
          'safety': 'Food Safety',
          'extension': 'Extension Services',
          'climate': 'Climate & Risk',
          'data': 'Digital Agriculture',
          'compliance': 'Compliance & Enforcement',
          'institutional': 'Cooperative Development'
        };

        const sortedDocs = [];
        querySnapshot.forEach(doc => sortedDocs.push(doc));
        sortedDocs.sort((a, b) => {
          const aTime = a.data().submittedAt?.toDate?.() || new Date(0);
          const bTime = b.data().submittedAt?.toDate?.() || new Date(0);
          return bTime - aTime;
        });

        if (sortedDocs.length === 0) {
          alert('No inventory items to download.');
          return;
        }

        const pdfContainer = document.createElement('div');
        pdfContainer.style.padding = '20px';
        pdfContainer.style.backgroundColor = '#ffffff';
        pdfContainer.style.fontFamily = 'Arial, sans-serif';
        
        const header = document.createElement('div');
        header.style.textAlign = 'center';
        header.style.marginBottom = '20px';
        header.style.borderBottom = '3px solid #f59e0b';
        header.style.paddingBottom = '15px';
        
        header.innerHTML = `
          <h1 style="color: #78350f; font-size: 22px; margin: 0; font-weight: 800;">DENR Inventory Report</h1>
          <p style="color: #6b7280; margin: 4px 0 0 0; font-size: 12px;">Department of Environment and Natural Resources</p>
          <p style="color: #9ca3af; margin: 2px 0 0 0; font-size: 11px;">Generated: ${new Date().toLocaleString()}</p>
        `;
        pdfContainer.appendChild(header);

        const detailsSection = document.createElement('div');
        detailsSection.style.marginTop = '15px';

        sortedDocs.forEach((doc, idx) => {
          const item = doc.data();
          const categoryLabel = categoryLabels[item.category] || item.category || 'Product';
          const date = item.submittedAt ? new Date(item.submittedAt.toDate()).toLocaleDateString('en-PH', {year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A';

          const card = document.createElement('div');
          card.style.marginBottom = '15px';
          card.style.padding = '12px';
          card.style.border = '1px solid #e5e7eb';
          card.style.borderRadius = '6px';
          card.style.backgroundColor = '#f9fafb';
          card.style.pageBreakInside = 'avoid';

          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #f59e0b;">
              <div>
                <span style="display: inline-block; padding: 4px 8px; background: #fef3c7; color: #92400e; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; margin-bottom: 4px;">Inventory</span>
                <h3 style="color: #1b330d; font-size: 13px; font-weight: 700; margin: 4px 0 0 0;">${categoryLabel}</h3>
              </div>
              <span style="color: #6b7280; font-weight: 600; font-size: 11px;">Item #${idx + 1}</span>
            </div>
            
            <div style="background: white; padding: 10px; border-radius: 4px; font-size: 11px;">
              <p style="color: #6b7280; margin: 0;"><strong>Date Submitted:</strong> ${date}</p>
              <p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Harvest Qty:</strong> ${Number(item.harvestQty || 0).toLocaleString()} units</p>
              <p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Investment:</strong> ₱${Number(item.investmentQty || 0).toLocaleString()}</p>
              <p style="color: #6b7280; margin: 3px 0 0 0;"><strong>Status:</strong> <span style="color: #059669; font-weight: 700;">Approved</span></p>
            </div>
          `;
          
          detailsSection.appendChild(card);
        });

        pdfContainer.appendChild(detailsSection);

        const element = document.createElement('div');
        element.appendChild(pdfContainer);
        document.body.appendChild(element);

        const opt = {
          margin: 10,
          filename: 'denr-inventory-report.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        };

        html2pdf().set(opt).from(element).save().finally(() => {
          document.body.removeChild(element);
        });
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF. Please try again.');
      }
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DENR Fish Transport</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    {% include 'user/header.html' %}

    <div class="min-h-screen bg-slate-50 py-12 px-4">
    <div class="max-w-5xl mx-auto bg-white rounded-[2.5rem] border-2 border-blue-700 overflow-hidden">
        
        <div class="bg-blue-700 p-10 text-center">
            <h1 class="text-3xl font-black text-white uppercase tracking-widest">Fish Transport Permit</h1>
            <p class="text-blue-100 text-sm mt-2 opacity-90 font-medium">Fisheries Logistics and Resource Movement Office</p>
        </div>

        <form action="#" method="POST" enctype="multipart/form-data" class="p-8 md:p-12 space-y-8">
            
            <!-- Map Section for Origin & Destination -->
            <div class="space-y-4">
                <label class="text-sm font-black text-blue-900 uppercase tracking-wider flex items-center gap-2">
                    <span class="text-xl">üó∫Ô∏è</span> Select Route (Origin & Destination)
                </label>
                
                <!-- Search boxes -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-blue-400 pointer-events-none">üìç</span>
                        <input type="text" id="searchOrigin" placeholder="Search Origin (e.g., Manila)" 
                               class="w-full rounded-2xl border-2 border-slate-100 bg-slate-50 pl-14 pr-20 py-4 text-slate-900 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                        <button type="button" id="searchOriginBtn" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-blue-700 text-white text-xs rounded-lg hover:bg-blue-800 transition">
                            Search
                        </button>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-red-400 pointer-events-none">üéØ</span>
                        <input type="text" id="searchDestination" placeholder="Search Destination (e.g., Cebu)" 
                               class="w-full rounded-2xl border-2 border-slate-100 bg-slate-50 pl-14 pr-20 py-4 text-slate-900 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                        <button type="button" id="searchDestinationBtn" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-red-700 text-white text-xs rounded-lg hover:bg-red-800 transition">
                            Search
                        </button>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div class="relative">
                    <div id="routeMap" class="w-full h-96 rounded-2xl border-2 border-blue-200 relative z-10"></div>
                    <button type="button" id="fullscreenMapBtn" class="absolute top-4 right-4 z-20 bg-white hover:bg-gray-100 p-2 rounded-lg shadow-md transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                    </button>
                </div>
                
                <!-- Selected locations display -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-blue-700 uppercase">Origin (Click blue marker on map)</label>
                        <input type="text" name="origin" id="originDisplay" readonly required
                               placeholder="Click map to set origin" 
                               class="w-full p-3 bg-blue-50 border-2 border-blue-200 rounded-xl text-sm">
                        <input type="hidden" name="origin_lat" id="originLat">
                        <input type="hidden" name="origin_lng" id="originLng">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-red-700 uppercase">Destination (Click red marker on map)</label>
                        <input type="text" name="destination" id="destinationDisplay" readonly required
                               placeholder="Click map to set destination" 
                               class="w-full p-3 bg-red-50 border-2 border-red-200 rounded-xl text-sm">
                        <input type="hidden" name="destination_lat" id="destinationLat">
                        <input type="hidden" name="destination_lng" id="destinationLng">
                    </div>
                </div>
                
                <p class="text-xs text-slate-500">üí° Click "Origin" button, then click map to set starting point. Click "Destination" button, then click map to set endpoint. A route line will appear.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-3">
                    <label class="text-sm font-black text-blue-900 uppercase tracking-wider flex items-center gap-2">
                        <span class="text-xl"></span> Species
                    </label>
                    <input type="text" required placeholder="Ex: Bangus, Tilapia, Tuna" 
                           class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <div class="space-y-3">
                    <label class="text-sm font-black text-blue-900 uppercase tracking-wider flex items-center gap-2">
                        <span class="text-xl"></span> Quantity
                    </label>
                    <div class="relative">
                        <input type="number" required placeholder="0.00" 
                               class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-xs uppercase">KG / Bkt</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-3">
                    <label class="text-sm font-black text-blue-900 uppercase tracking-wider flex items-center gap-2">
                        <span class="text-xl"></span> Transport Method
                    </label>
                    <select required class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all appearance-none cursor-pointer">
                        <option value="" disabled selected>Select method...</option>
                        <option value="open">Open Container</option>
                        <option value="closed">Closed Container</option>
                        <option value="specialized">Specialized Container</option>
                    </select>
                </div>
                <div class="space-y-3">
                    <label class="text-sm font-black text-blue-900 uppercase tracking-wider flex items-center gap-2">
                        <span class="text-xl"></span> Intended Route
                    </label>
                    <input type="text" required placeholder="Ex: SLEX, Coastal Road, Maharlika Hwy" 
                           class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-sm font-black text-blue-900 uppercase tracking-wider flex items-center gap-2">
                    <span class="text-xl"></span> Schedule of Transport
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="date" required class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    <input type="time" required class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
            </div>

            <hr class="border-slate-100">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-3">
                    <label class="text-sm font-black text-blue-900 uppercase tracking-wider flex items-center gap-2">
                        <span class="text-xl"></span> Attach Invoice
                    </label>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-blue-200 rounded-2xl cursor-pointer bg-slate-50 hover:bg-blue-50 transition-all group">
                        <p class="text-xs font-bold text-blue-700">UPLOAD INVOICE / RECEIPT</p>
                        <input type="file" required class="hidden">
                    </label>
                </div>

                <div class="space-y-3">
                    <label class="text-sm font-black text-blue-900 uppercase tracking-wider flex items-center gap-2">
                        <span class="text-xl"></span> Vehicle Details
                    </label>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-blue-200 rounded-2xl cursor-pointer bg-slate-50 hover:bg-blue-50 transition-all group">
                        <p class="text-xs font-bold text-blue-700">UPLOAD OR/CR & PLATE PHOTO</p>
                        <input type="file" required class="hidden">
                    </label>
                </div>
            </div>

            <div class="pt-6">
                <button type="submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-black py-6 px-8 rounded-3xl transition-all transform hover:scale-[1.01] active:scale-95 uppercase tracking-widest text-xl">
                    Submit Permit Application
                </button>
            </div>

        </form>
    </div>
</div>

<script>
// Initialize map centered on Philippines
const routeMap = L.map('routeMap').setView([12.8797, 121.7740], 6);

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(routeMap);

// Markers and line
let originMarker = null;
let destinationMarker = null;
let routeLine = null;
let settingMode = null; // 'origin' or 'destination'

// Map click handler
routeMap.on('click', async function(e) {
    if (!settingMode) {
        alert('Click "Origin" or "Destination" search button first, then click on the map');
        return;
    }
    
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    
    if (settingMode === 'origin') {
        // Remove old origin marker
        if (originMarker) {
            routeMap.removeLayer(originMarker);
        }
        
        // Add blue marker for origin
        originMarker = L.marker([lat, lng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(routeMap);
        originMarker.bindPopup('üìç Origin').openPopup();
        
        // Store coordinates
        document.getElementById('originLat').value = lat;
        document.getElementById('originLng').value = lng;
        document.getElementById('originDisplay').value = 'Loading address...';
        
        // Get address
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            document.getElementById('originDisplay').value = data.display_name;
        } catch (error) {
            document.getElementById('originDisplay').value = `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
        
    } else if (settingMode === 'destination') {
        // Remove old destination marker
        if (destinationMarker) {
            routeMap.removeLayer(destinationMarker);
        }
        
        // Add red marker for destination
        destinationMarker = L.marker([lat, lng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(routeMap);
        destinationMarker.bindPopup('üéØ Destination').openPopup();
        
        // Store coordinates
        document.getElementById('destinationLat').value = lat;
        document.getElementById('destinationLng').value = lng;
        document.getElementById('destinationDisplay').value = 'Loading address...';
        
        // Get address
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            document.getElementById('destinationDisplay').value = data.display_name;
        } catch (error) {
            document.getElementById('destinationDisplay').value = `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
    }
    
    // Draw route line if both points are set
    drawRouteLine();
    settingMode = null;
});

// Draw line between origin and destination
function drawRouteLine() {
    const originLat = document.getElementById('originLat').value;
    const originLng = document.getElementById('originLng').value;
    const destLat = document.getElementById('destinationLat').value;
    const destLng = document.getElementById('destinationLng').value;
    
    if (originLat && originLng && destLat && destLng) {
        // Remove old line
        if (routeLine) {
            routeMap.removeLayer(routeLine);
        }
        
        // Draw new line
        routeLine = L.polyline([
            [parseFloat(originLat), parseFloat(originLng)],
            [parseFloat(destLat), parseFloat(destLng)]
        ], {
            color: '#3b82f6',
            weight: 4,
            opacity: 0.7,
            dashArray: '10, 10'
        }).addTo(routeMap);
        
        // Fit map to show both points
        routeMap.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
    }
}

// Search origin
async function searchOrigin() {
    const query = document.getElementById('searchOrigin').value.trim();
    if (!query) {
        alert('Please enter origin location');
        return;
    }
    
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
        const data = await response.json();
        
        if (data.length > 0) {
            const result = data[0];
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);
            
            // Remove old marker
            if (originMarker) {
                routeMap.removeLayer(originMarker);
            }
            
            // Add marker
            originMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(routeMap);
            originMarker.bindPopup('üìç Origin').openPopup();
            
            // Update fields
            document.getElementById('originLat').value = lat;
            document.getElementById('originLng').value = lng;
            document.getElementById('originDisplay').value = result.display_name;
            
            routeMap.setView([lat, lng], 13);
            drawRouteLine();
        } else {
            alert('Location not found');
        }
    } catch (error) {
        alert('Search failed');
    }
}

// Search destination
async function searchDestination() {
    const query = document.getElementById('searchDestination').value.trim();
    if (!query) {
        alert('Please enter destination location');
        return;
    }
    
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
        const data = await response.json();
        
        if (data.length > 0) {
            const result = data[0];
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);
            
            // Remove old marker
            if (destinationMarker) {
                routeMap.removeLayer(destinationMarker);
            }
            
            // Add marker
            destinationMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(routeMap);
            destinationMarker.bindPopup('üéØ Destination').openPopup();
            
            // Update fields
            document.getElementById('destinationLat').value = lat;
            document.getElementById('destinationLng').value = lng;
            document.getElementById('destinationDisplay').value = result.display_name;
            
            routeMap.setView([lat, lng], 13);
            drawRouteLine();
        } else {
            alert('Location not found');
        }
    } catch (error) {
        alert('Search failed');
    }
}

// Button event listeners
document.getElementById('searchOriginBtn').addEventListener('click', searchOrigin);
document.getElementById('searchDestinationBtn').addEventListener('click', searchDestination);

// Enter key support
document.getElementById('searchOrigin').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchOrigin();
    }
});

document.getElementById('searchDestination').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchDestination();
    }
});

// Fullscreen
document.getElementById('fullscreenMapBtn').addEventListener('click', function() {
    const mapContainer = document.getElementById('routeMap');
    
    if (!document.fullscreenElement) {
        if (mapContainer.requestFullscreen) {
            mapContainer.requestFullscreen();
        } else if (mapContainer.webkitRequestFullscreen) {
            mapContainer.webkitRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        }
    }
});

// Handle fullscreen change
document.addEventListener('fullscreenchange', function() {
    setTimeout(() => routeMap.invalidateSize(), 100);
});

document.addEventListener('webkitfullscreenchange', function() {
    setTimeout(() => routeMap.invalidateSize(), 100);
});
</script>

</body>
</html>
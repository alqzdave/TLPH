<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Applications | DENR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    {% include 'user/header.html' %}

    <div class="container mx-auto px-4 mt-8">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-black uppercase tracking-tight mb-2 text-green-800">
                    My Applications
                </h1>
                <p class="text-gray-500 font-bold uppercase tracking-widest text-xs">
                    Track your application status and history
                </p>
            </div>

            <!-- New Application Button -->
            <div class="text-center mb-8">
                <a href="/user/application/apply" 
                   class="inline-block bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-xl shadow-md transition-all transform hover:scale-105 uppercase tracking-widest no-underline">
                    <i class="fa-solid fa-plus mr-2"></i> New Application
                </a>
            </div>

            <!-- Applications List -->
            <div id="applicationsContainer" class="space-y-2">
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-12">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-green-700"></i>
                    <p class="text-gray-500 mt-4 font-bold uppercase tracking-wider">Loading applications...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12">
                    <i class="fa-solid fa-folder-open text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 font-bold uppercase tracking-wider">No applications yet</p>
                    <a href="/user/application/apply" 
                       class="inline-block mt-4 text-green-700 hover:text-green-800 font-bold uppercase text-sm">
                        Submit your first application →
                    </a>
                </div>

                <!-- Applications will be inserted here -->
                <div id="applicationsList"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from '/static/js/firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const applicationsList = document.getElementById('applicationsList');

        // Category labels mapping
        const categoryLabels = {
            'farming': 'Crop & Plant',
            'livestock': 'Fisheries & Agriculture',
            'agribusiness': 'Agribusiness & Agro-Processing',
            'trade': 'Agricultural Trade (Import & Export)',
            'infrastructure': 'Land Use & Farm Development Infrastructure',
            'research': 'Research, Technology, & Innovation',
            'support': 'Farmer Support, Subsidies, & Insurance',
            'safety': 'Food Safety & Quality',
            'extension': 'Extension Services & Capacity Building',
            'climate': 'Climate Change, Disaster & Risk Management',
            'data': 'Data, Monitoring & Digital Agriculture',
            'compliance': 'Compliance, Inspection, & Enforcement',
            'institutional': 'Institutional & Cooperative Development'
        };

        // Status badge styling
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-yellow-100 text-yellow-800"><i class="fa-solid fa-clock mr-1"></i> Pending</span>',
                'approved': '<span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-green-100 text-green-800"><i class="fa-solid fa-check-circle mr-1"></i> Approved</span>',
                'rejected': '<span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-red-100 text-red-800"><i class="fa-solid fa-times-circle mr-1"></i> Rejected</span>',
                'under-review': '<span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-blue-100 text-blue-800"><i class="fa-solid fa-eye mr-1"></i> Under Review</span>',
                'cancelled': '<span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-gray-100 text-gray-800"><i class="fa-solid fa-ban mr-1"></i> Cancelled</span>'
            };
            return badges[status] || badges['pending'];
        }

        // Format date
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Load applications
        async function loadApplications(userId) {
            try {
                const q = query(
                    collection(db, 'applications'),
                    where('userId', '==', userId)
                );

                const querySnapshot = await getDocs(q);
                
                loadingState.classList.add('hidden');

                if (querySnapshot.empty) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                // Convert to array and sort by date (newest first)
                const applications = [];
                querySnapshot.forEach((doc) => {
                    applications.push({
                        id: doc.id,
                        data: doc.data()
                    });
                });

                // Sort by submittedAt (client-side)
                applications.sort((a, b) => {
                    const dateA = a.data.submittedAt?.toDate?.() || new Date(0);
                    const dateB = b.data.submittedAt?.toDate?.() || new Date(0);
                    return dateB - dateA; // Newest first
                });

                // Build applications HTML
                let html = '';
                applications.forEach(({ id, data: app }) => {
                    const categoryLabel = categoryLabels[app.category] || app.category;
                    
                    html += `
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-2 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-1">
                                <div>
                                    <h3 class="text-sm font-bold text-gray-800 uppercase leading-tight">${categoryLabel}</h3>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">
                                        Application ID: ${id.substring(0, 8)}
                                    </p>
                                </div>
                                <div>
                                    ${getStatusBadge(app.status)}
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                                <div>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Investment</p>
                                    <p class="text-gray-800 font-bold">₱ ${app.investmentQty.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Max Harvest</p>
                                    <p class="text-gray-800 font-bold">${app.harvestQty.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Submitted</p>
                                    <p class="text-gray-800 font-bold">${formatDate(app.submittedAt)}</p>
                                </div>
                            </div>

                            <div class="flex justify-end gap-2 mt-1">
                                <button onclick="viewDetails('${id}')" 
                                        class="px-2 py-0.5 text-xs font-bold uppercase tracking-wider text-green-700 hover:bg-green-50 rounded transition">
                                    <i class="fa-solid fa-eye mr-1"></i> View Details
                                </button>
                                ${app.status === 'pending' || app.status === 'under-review' ? `
                                <button onclick="cancelApplication('${id}')" 
                                        class="px-2 py-0.5 text-xs font-bold uppercase tracking-wider text-red-600 hover:bg-red-50 rounded transition">
                                    <i class="fa-solid fa-times mr-1"></i> Cancel
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                applicationsList.innerHTML = html;

            } catch (error) {
                console.error('Error loading applications:', error);
                loadingState.innerHTML = `
                    <i class="fa-solid fa-exclamation-triangle text-4xl text-red-500"></i>
                    <p class="text-red-500 mt-4 font-bold uppercase tracking-wider">Error loading applications</p>
                    <p class="text-gray-500 text-sm mt-2">${error.message}</p>
                `;
            }
        }

        // Cancel application
        window.cancelApplication = async function(applicationId) {
            if (!confirm('Are you sure you want to cancel this application?')) {
                return;
            }
            
            try {
                const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
                
                const applicationRef = doc(db, 'applications', applicationId);
                await updateDoc(applicationRef, {
                    status: 'cancelled',
                    cancelledAt: new Date()
                });
                
                alert('Application cancelled successfully');
                // Reload applications
                const user = auth.currentUser;
                if (user) {
                    loadApplications(user.uid);
                }
            } catch (error) {
                console.error('Error cancelling application:', error);
                alert('Failed to cancel application: ' + error.message);
            }
        };

        // View application details (placeholder)
        window.viewDetails = function(applicationId) {
            alert('Application details: ' + applicationId + '\nThis feature will be implemented next.');
        };

        // Check authentication and load applications
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadApplications(user.uid);
            } else {
                window.location.href = '/login';
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>

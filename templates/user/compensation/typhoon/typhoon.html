<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typhoon Damage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
      <header class="bg-green-700 text-white shadow-lg sticky top-0 z-50">
  <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
    
    <div class="flex items-center gap-3">
      <img src="{{ url_for('static', filename='images/denr.jpg') }}" 
           alt="DENR Logo" 
           class="h-12 w-12 object-contain bg-white rounded-full p-0.5">
      <h1 class="text-white text-3xl font-bold tracking-tight">DENR</h1>
    </div>

    <div class="flex items-center gap-8">
      
      <div class="hidden md:flex items-center gap-6 border-r border-green-600 pr-8">
        <a href="#" class="text-white hover:text-green-200 font-medium transition-colors">Home</a>
        <a href="#" class="text-white hover:text-green-200 font-medium transition-colors">Application</a>
        <a href="#" class="text-white hover:text-green-200 font-medium transition-colors">Inventory</a>
        <div class="dropdown">
    <a href="#" 
       class="text-white hover:text-green-200 font-medium transition-colors dropdown-toggle flex items-center gap-1" 
       id="requestDropdown" 
       data-bs-toggle="dropdown" 
       aria-expanded="false">
        Request
    </a>
    
    <ul class="dropdown-menu shadow-lg border-0 mt-2" aria-labelledby="requestDropdown">
        <li>
            <a class="dropdown-item py-2 flex items-center gap-2" href="#">
                <span>ğŸ› ï¸</span> Service Request
            </a>
        </li>
        <li>
            <a class="dropdown-item py-2 flex items-center gap-2" href="#">
                <span>ğŸ’°</span> Compensation Request
            </a>
        </li>
        <li>
            <a class="dropdown-item py-2 flex items-center gap-2" href="#">
                <span>ğŸ“œ</span> Licensing/Permit Request
            </a>
        </li>
    </ul>
</div>
        <a href="#" class="text-white hover:text-green-200 font-medium transition-colors">History</a>
      </div>

      <div class="dropdown">
        <button class="hover:opacity-80 transition-all focus:outline-none flex items-center" 
                type="button" 
                id="profileDropdown" 
                data-bs-toggle="dropdown" 
                aria-expanded="false">
          <img src="https://ui-avatars.com/api/?name=User&background=fff&color=15803d" 
               alt="Profile" 
               class="h-10 w-10 rounded-full border-2 border-white shadow-md">
        </button>
        
        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2" aria-labelledby="profileDropdown">
          <li>
              <a class="dropdown-item py-2 flex items-center gap-2" href="#">
                  <span>ğŸ‘¤</span> Profile
              </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
              <a class="dropdown-item py-2 text-danger flex items-center gap-2" href="#">
                  <span>ğŸšª</span> Logout
              </a>
          </li>
        </ul>
      </div>
    </div>

  </nav>
</header>

<section class="container mx-auto px-6 py-10">
  <!-- Page header -->
  <div class="bg-white rounded-2xl shadow-lg border border-green-100 p-6 md:p-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <p class="text-sm font-semibold text-green-700 uppercase tracking-widest">Compensation Request</p>
        <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mt-1">Typhoon Damage</h2>
        <p class="text-slate-600 mt-2">
          Fill out the details below. Fields marked <span class="text-red-600 font-semibold">*</span> are required.
        </p>
      </div>

      <a href="#"
         class="inline-flex items-center justify-center px-4 py-2 rounded-xl border border-slate-200
                text-slate-700 hover:bg-slate-50 transition">
        â† Back
      </a>
    </div>
  </div>

  <!-- Form -->
  <form class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left + middle columns -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Incident details -->
      <div class="bg-white rounded-2xl shadow-md border border-slate-100 p-6 md:p-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-bold text-slate-900">Incident Details</h3>
          <span class="text-xs px-3 py-1 rounded-full bg-green-50 text-green-700 font-semibold">
            Step 1
          </span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <!-- Name of typhoon -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Name of Typhoon <span class="text-red-600">*</span>
            </label>
            <input
              type="text"
              name="typhoon_name"
              placeholder="e.g., Odette, Yolanda"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-slate-900
                     placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
              required
            />
          </div>

          <!-- Date & time -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Date & Time of Occurrence <span class="text-red-600">*</span>
            </label>
            <input
              type="datetime-local"
              name="occurred_at"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-slate-900
                     focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
              required
            />
            <p class="text-xs text-slate-500 mt-2">Choose the date/time from the calendar.</p>
          </div>

          <!-- Location -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Location of Farm <span class="text-red-600">*</span>
            </label>
            
            <!-- Search box for location -->
            <div class="relative mb-3">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">ğŸ”</span>
              <input
                type="text"
                id="searchLocation"
                placeholder="Search location (e.g., Manila, Quezon City)"
                class="w-full rounded-xl border border-slate-200 bg-white pl-14 pr-24 py-3 text-slate-900
                       placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
              />
              <button type="button" id="searchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-1.5 bg-green-700 text-white text-sm rounded-lg hover:bg-green-800 transition">
                Search
              </button>
            </div>
            
            <!-- Map container with fullscreen -->
            <div class="relative">
              <div id="map" class="w-full h-64 rounded-xl border-2 border-slate-200 mb-3 relative z-10"></div>
              <button type="button" id="fullscreenBtn" class="absolute top-4 right-4 z-20 bg-white hover:bg-gray-100 p-2 rounded-lg shadow-md transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                </svg>
              </button>
            </div>
            
            <!-- Hidden input for coordinates -->
            <input type="hidden" name="farm_latitude" id="farm_latitude" required />
            <input type="hidden" name="farm_longitude" id="farm_longitude" required />
            
            <!-- Display selected location -->
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">ğŸ“</span>
              <input
                type="text"
                name="farm_location"
                id="farm_location"
                placeholder="Click on the map to select location"
                class="w-full rounded-xl border border-slate-200 bg-slate-50 pl-14 pr-4 py-3 text-slate-900
                       placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                readonly
                required
              />
            </div>
            <p class="text-xs text-slate-500 mt-2">ğŸ” Search or ğŸ“Œ click anywhere on the map to set your farm location</p>
          </div>
        </div>
      </div>

      <!-- Farm & damage details -->
      <div class="bg-white rounded-2xl shadow-md border border-slate-100 p-6 md:p-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-bold text-slate-900">Farm & Damage Details</h3>
          <span class="text-xs px-3 py-1 rounded-full bg-green-50 text-green-700 font-semibold">
            Step 2
          </span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <!-- Area affected -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Area Affected (hectares) <span class="text-red-600">*</span>
            </label>
            <div class="relative">
              <input
                type="number"
                name="area_affected"
                min="0"
                step="0.01"
                placeholder="0.00"
                class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 pr-16 text-slate-900
                       placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                required
              />
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-semibold text-slate-500">
                hectares
              </span>
            </div>
          </div>

          <!-- Crop/species -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Crop / Species <span class="text-red-600">*</span>
            </label>
            <input
              type="text"
              name="crop_species"
              placeholder="e.g., Rice, Tilapia, Mango"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-slate-900
                     placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
              required
            />
          </div>

          <!-- Type of damage (chips / multi check) -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-3">
              Type of Damage (multi-check) <span class="text-red-600">*</span>
            </label>

            <div class="flex flex-wrap gap-3">
              <!-- Chip checkbox pattern -->
              <label class="cursor-pointer">
                <input type="checkbox" name="damage_type[]" value="Flooding" class="peer sr-only" />
                <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-200
                             bg-white text-slate-700 shadow-sm
                             peer-checked:bg-green-700 peer-checked:text-white peer-checked:border-green-700
                             hover:bg-slate-50 transition">
                  ğŸŒŠ Flooding
                </span>
              </label>

              <label class="cursor-pointer">
                <input type="checkbox" name="damage_type[]" value="Strong Winds" class="peer sr-only" />
                <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-200
                             bg-white text-slate-700 shadow-sm
                             peer-checked:bg-green-700 peer-checked:text-white peer-checked:border-green-700
                             hover:bg-slate-50 transition">
                  ğŸ’¨ Strong Winds
                </span>
              </label>

              <label class="cursor-pointer">
                <input type="checkbox" name="damage_type[]" value="Crop Loss" class="peer sr-only" />
                <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-200
                             bg-white text-slate-700 shadow-sm
                             peer-checked:bg-green-700 peer-checked:text-white peer-checked:border-green-700
                             hover:bg-slate-50 transition">
                  ğŸŒ¾ Crop Loss
                </span>
              </label>

              <label class="cursor-pointer">
                <input type="checkbox" name="damage_type[]" value="Infrastructure Damage" class="peer sr-only" />
                <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-200
                             bg-white text-slate-700 shadow-sm
                             peer-checked:bg-green-700 peer-checked:text-white peer-checked:border-green-700
                             hover:bg-slate-50 transition">
                  ğŸšï¸ Infrastructure
                </span>
              </label>

              <label class="cursor-pointer">
                <input type="checkbox" name="damage_type[]" value="Erosion" class="peer sr-only" />
                <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-200
                             bg-white text-slate-700 shadow-sm
                             peer-checked:bg-green-700 peer-checked:text-white peer-checked:border-green-700
                             hover:bg-slate-50 transition">
                  ğŸª¨ Erosion
                </span>
              </label>

              <label class="cursor-pointer">
                <input type="checkbox" name="damage_type[]" value="Other" class="peer sr-only" />
                <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-200
                             bg-white text-slate-700 shadow-sm
                             peer-checked:bg-green-700 peer-checked:text-white peer-checked:border-green-700
                             hover:bg-slate-50 transition">
                  â• Other
                </span>
              </label>
            </div>

            <p class="text-xs text-slate-500 mt-3">Select all that apply.</p>
          </div>
        </div>
      </div>

      <!-- Narrative -->
      <div class="bg-white rounded-2xl shadow-md border border-slate-100 p-6 md:p-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-bold text-slate-900">Narrative</h3>
          <span class="text-xs px-3 py-1 rounded-full bg-green-50 text-green-700 font-semibold">
            Step 3
          </span>
        </div>

        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Narrative of Accident <span class="text-red-600">*</span>
        </label>
        <textarea
          name="narrative"
          rows="5"
          placeholder="Write a short description of the incident and observed damages..."
          class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-slate-900
                 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
          required
        ></textarea>
        <p class="text-xs text-slate-500 mt-2">
          Tip: Include date, affected area, and what was damaged.
        </p>
      </div>
    </div>

    <!-- Right column: attachments + summary -->
    <aside class="lg:col-span-1 space-y-6">
      <!-- Permits upload -->
      <div class="bg-white rounded-2xl shadow-md border border-slate-100 p-6 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-slate-900">Permits</h3>
          <span class="text-xs px-3 py-1 rounded-full bg-slate-50 text-slate-700 font-semibold">
            Upload
          </span>
        </div>

        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Attach Permits <span class="text-red-600">*</span>
        </label>

        <div class="rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50 p-6 text-center">
          <div class="text-3xl">ğŸ“„</div>
          <p class="mt-2 text-slate-700 font-semibold">Drop files here</p>
          <p class="text-sm text-slate-500">or click to browse</p>

          <input
            type="file"
            name="permits"
            accept=".pdf,.jpg,.jpeg,.png"
            class="mt-4 w-full text-sm text-slate-700
                   file:mr-4 file:rounded-xl file:border-0 file:bg-green-700 file:px-4 file:py-2 file:text-white
                   hover:file:bg-green-800 cursor-pointer"
            required
          />

          <p class="text-xs text-slate-500 mt-3">Accepted: PDF, JPG, PNG</p>
        </div>
      </div>

      <!-- Quick checklist / info card -->
      <div class="bg-green-700 rounded-2xl shadow-md p-6 md:p-8 text-white">
        <h3 class="text-lg font-bold">Before you submit</h3>
        <ul class="mt-3 space-y-2 text-sm text-green-50">
          <li class="flex gap-2"><span>âœ…</span> Ensure typhoon name and date/time are accurate</li>
          <li class="flex gap-2"><span>âœ…</span> Select all relevant damage types</li>
          <li class="flex gap-2"><span>âœ…</span> Attach valid permits/documentation</li>
        </ul>
      </div>
    </aside>

    <!-- Sticky action bar -->
    <div class="lg:col-span-3 sticky bottom-0 z-10">
      <div class="mt-2 bg-white/90 backdrop-blur rounded-2xl border border-slate-200 shadow-lg p-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <p class="text-sm text-slate-600">
          When ready, click <span class="font-semibold text-slate-900">Submit Application</span>.
        </p>

        <div class="flex gap-3">
          <button type="reset"
            class="w-full md:w-auto px-5 py-3 rounded-xl border border-slate-200 text-slate-700 hover:bg-slate-50 transition">
            Clear
          </button>

          <button type="submit"
            class="w-full md:w-auto px-7 py-3 rounded-xl bg-green-700 text-white font-semibold
                   hover:bg-green-800 transition shadow-md">
            Submit Application
          </button>
        </div>
      </div>
    </div>
  </form>
</section>

<script>
// Initialize map centered on Philippines
const map = L.map('map').setView([12.8797, 121.7740], 6); // Philippines center

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Marker variable
let marker;

// Click event on map
map.on('click', async function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    
    // Update hidden inputs
    document.getElementById('farm_latitude').value = lat;
    document.getElementById('farm_longitude').value = lng;
    
    // Remove old marker if exists
    if (marker) {
        map.removeLayer(marker);
    }
    
    // Add new marker
    marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup('ğŸ“ Selected Location').openPopup();
    
    // Show loading in text field
    document.getElementById('farm_location').value = 'Loading address...';
    
    // Reverse geocode to get address
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
        const data = await response.json();
        
        // Extract address components
        const address = data.address || {};
        const parts = [];
        
        if (address.village || address.suburb || address.neighbourhood) {
            parts.push(address.village || address.suburb || address.neighbourhood);
        }
        if (address.city || address.town || address.municipality) {
            parts.push(address.city || address.town || address.municipality);
        }
        if (address.province || address.state) {
            parts.push(address.province || address.state);
        }
        
        const displayAddress = parts.length > 0 ? parts.join(', ') : data.display_name;
        document.getElementById('farm_location').value = displayAddress;
    } catch (error) {
        console.error('Geocoding error:', error);
        document.getElementById('farm_location').value = `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
});

// Search location functionality
async function searchLocation() {
    const query = document.getElementById('searchLocation').value.trim();
    if (!query) {
        alert('Please enter a location to search');
        return;
    }
    
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
        const data = await response.json();
        
        if (data.length > 0) {
            const result = data[0];
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);
            
            // Move map to location
            map.setView([lat, lng], 15);
            
            // Remove old marker
            if (marker) {
                map.removeLayer(marker);
            }
            
            // Add marker
            marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`ğŸ“ ${result.display_name}`).openPopup();
            
            // Update fields
            document.getElementById('farm_latitude').value = lat;
            document.getElementById('farm_longitude').value = lng;
            document.getElementById('farm_location').value = result.display_name;
        } else {
            alert('Location not found. Try a different search term.');
        }
    } catch (error) {
        console.error('Search error:', error);
        alert('Search failed. Please try again.');
    }
}

// Search button click
document.getElementById('searchBtn').addEventListener('click', searchLocation);

// Enter key on search input
document.getElementById('searchLocation').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchLocation();
    }
});

// Fullscreen toggle
document.getElementById('fullscreenBtn').addEventListener('click', function() {
    const mapContainer = document.getElementById('map');
    
    if (!document.fullscreenElement) {
        // Enter fullscreen
        if (mapContainer.requestFullscreen) {
            mapContainer.requestFullscreen();
        } else if (mapContainer.webkitRequestFullscreen) {
            mapContainer.webkitRequestFullscreen();
        } else if (mapContainer.msRequestFullscreen) {
            mapContainer.msRequestFullscreen();
        }
    } else {
        // Exit fullscreen
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
});

// Handle fullscreen changes
document.addEventListener('fullscreenchange', function() {
    setTimeout(() => {
        map.invalidateSize(); // Refresh map size
    }, 100);
});

document.addEventListener('webkitfullscreenchange', function() {
    setTimeout(() => {
        map.invalidateSize();
    }, 100);
});
</script>

</body>
</html>
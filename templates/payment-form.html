<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DENR Payment - Xendit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://checkout.xendit.co/v2/checkout.min.js"></script>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-blue-50">

<div class="min-h-screen flex items-center justify-center px-4 py-8">
    <div class="w-full max-w-md">
        <!-- Header -->
        <div class="bg-white p-6 rounded-t-3xl border-2 border-slate-100 shadow-lg">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-3 bg-emerald-900 rounded-xl shadow-lg">
                    <span class="material-icons-round text-white text-2xl">payment</span>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-emerald-900 m-0">Payment</h1>
                    <p class="text-xs font-bold text-slate-400 m-0 uppercase tracking-wider">Xendit Secure Gateway</p>
                </div>
            </div>
        </div>

        <!-- Form Container -->
        <div class="bg-white p-8 rounded-b-3xl border-2 border-t-0 border-slate-100 shadow-lg">
            
            <!-- Payment Amount Display -->
            <div class="bg-gradient-to-r from-emerald-50 to-blue-50 p-4 rounded-2xl mb-8 border-2 border-emerald-100">
                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Amount to Pay</p>
                <h2 class="text-4xl font-black text-emerald-900 m-0">
                    â‚±<span id="amount-display">0.00</span>
                </h2>
                <p class="text-xs text-slate-400 mt-2 m-0" id="service-description"></p>
            </div>

            <!-- Payment Form -->
            <form id="paymentForm" class="space-y-5">
                
                <!-- Service Type (Hidden) -->
                <input type="hidden" id="service_type" name="service_type" value="{{ service_type }}">

                <!-- Personal Information Section -->
                <div class="border-b-2 border-slate-100 pb-5">
                    <h3 class="text-sm font-black text-slate-700 uppercase tracking-wider mb-4">Personal Information</h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input type="text" id="first_name" placeholder="First Name" required
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none font-bold text-sm placeholder:text-slate-400">
                        <input type="text" id="last_name" placeholder="Last Name" required
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none font-bold text-sm placeholder:text-slate-400">
                    </div>

                    <input type="email" id="email" placeholder="Email Address" required
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none font-bold text-sm placeholder:text-slate-400 mb-3">
                    
                    <input type="tel" id="phone" placeholder="Phone Number" required
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none font-bold text-sm placeholder:text-slate-400">
                </div>

                <!-- Payment Details -->
                <div class="border-b-2 border-slate-100 pb-5">
                    <h3 class="text-sm font-black text-slate-700 uppercase tracking-wider mb-4">Payment Details</h3>
                    
                    <input type="number" id="amount" placeholder="Amount (PHP)" step="0.01" min="0" required
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none font-bold text-sm placeholder:text-slate-400 mb-3"
                        oninput="updateAmountDisplay()">
                    
                    <input type="text" id="item_name" placeholder="Item/License Type" required
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none font-bold text-sm placeholder:text-slate-400 mb-3">
                    
                    <textarea id="description" placeholder="Additional Details (Optional)" rows="3"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none font-bold text-sm placeholder:text-slate-400 resize-none"></textarea>
                </div>

                <!-- Payment Method Selection -->
                <div class="pb-5">
                    <h3 class="text-sm font-black text-slate-700 uppercase tracking-wider mb-4">Payment Method</h3>
                    
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition-all">
                            <input type="radio" name="payment_method" value="credit_card" checked class="w-5 h-5 accent-emerald-600">
                            <div class="ml-3">
                                <p class="font-bold text-slate-700 m-0">Credit/Debit Card</p>
                                <p class="text-xs text-slate-400 m-0">Visa, Mastercard, JCB</p>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition-all">
                            <input type="radio" name="payment_method" value="bank_transfer" class="w-5 h-5 accent-emerald-600">
                            <div class="ml-3">
                                <p class="font-bold text-slate-700 m-0">Bank Transfer</p>
                                <p class="text-xs text-slate-400 m-0">Via Virtual Accounts</p>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition-all">
                            <input type="radio" name="payment_method" value="retail" class="w-5 h-5 accent-emerald-600">
                            <div class="ml-3">
                                <p class="font-bold text-slate-700 m-0">Over-the-Counter</p>
                                <p class="text-xs text-slate-400 m-0">7-Eleven, Robinsons, &amp; Partners</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" 
                    class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-black py-4 rounded-xl uppercase tracking-wider text-sm shadow-lg shadow-emerald-600/30 hover:shadow-emerald-600/50 hover:from-emerald-700 hover:to-emerald-800 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="submitText">Proceed to Payment</span>
                    <span id="loadingSpinner" class="hidden">Processing...</span>
                </button>

                <!-- Terms & Conditions -->
                <div class="flex items-start gap-2 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <input type="checkbox" id="terms" class="w-4 h-4 accent-emerald-600 mt-1" required>
                    <label for="terms" class="text-xs text-slate-600 leading-relaxed">
                        I agree to the <a href="#" class="text-emerald-600 font-bold">terms and conditions</a> and <a href="#" class="text-emerald-600 font-bold">privacy policy</a>
                    </label>
                </div>

            </form>

            <!-- Loading Indicator -->
            <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-2xl p-8 text-center">
                    <div class="animate-spin mb-4 flex justify-center">
                        <span class="material-icons-round text-emerald-600 text-4xl">sync</span>
                    </div>
                    <p class="font-bold text-slate-700">Processing Payment...</p>
                </div>
            </div>

        </div>

        <!-- Footer Info -->
        <div class="px-8 py-4 bg-slate-50 rounded-b-3xl border-2 border-t-0 border-slate-100 text-center">
            <p class="text-xs text-slate-500 m-0">
                <span class="material-icons-round text-xs align-text-bottom">security</span>
                Secured by <strong>Xendit</strong>
            </p>
        </div>

    </div>
</div>

<script>
const XENDIT_PUBLIC_KEY = '{{ xendit_public_key }}';
const SERVICE_TYPE = '{{ service_type }}';

// Service price mapping
const servicePricing = {
    'aquafarm': { name: 'Aquaculture Farm Registration', price: 5000 },
    'fish_transport': { name: 'Fish Transport Permit', price: 2500 },
    'fish_dealer': { name: 'Fish Dealer/Trade License', price: 3000 },
    'processing': { name: 'Fish Processing Facility Permit', price: 4500 },
    'collection_harvest': { name: 'Collection/Harvest Permit', price: 2000 }
};

function initializeForm() {
    if (servicePricing[SERVICE_TYPE]) {
        document.getElementById('amount').value = servicePricing[SERVICE_TYPE].price;
        document.getElementById('item_name').value = servicePricing[SERVICE_TYPE].name;
        document.getElementById('service-description').textContent = servicePricing[SERVICE_TYPE].name;
        updateAmountDisplay();
    }
}

function updateAmountDisplay() {
    const amount = document.getElementById('amount').value;
    document.getElementById('amount-display').textContent = parseFloat(amount || 0).toFixed(2);
}

document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate form
    if (!document.getElementById('terms').checked) {
        alert('Please agree to the terms and conditions');
        return;
    }

    // Show loading
    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.getElementById('submitBtn').disabled = true;

    try {
        const paymentData = {
            external_id: `${SERVICE_TYPE}-${Date.now()}`,
            first_name: document.getElementById('first_name').value,
            last_name: document.getElementById('last_name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            amount: parseFloat(document.getElementById('amount').value),
            item_name: document.getElementById('item_name').value,
            description: document.getElementById('description').value,
            success_url: window.location.origin + '/payment-success',
            failure_url: window.location.origin + '/payment-failed'
        };

        // Create invoice
        const response = await fetch('/api/payments/create-invoice', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(paymentData)
        });

        const result = await response.json();

        if (result.status === 'success') {
            // Redirect to Xendit checkout
            window.location.href = result.invoice_url;
        } else {
            alert('Error creating payment: ' + result.message);
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('submitBtn').disabled = false;
    }
});

// Initialize form on load
window.addEventListener('DOMContentLoaded', initializeForm);
</script>

</body>
</html>

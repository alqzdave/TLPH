<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DENR | Inventory Dashboard (Municipality View)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            govbg: "#f3f4f6",
            govpanel: "#ffffff",
            govborder: "#d1d5db",
            govtext: "#111827",
            govmuted: "#4b5563",
            g900: "#064e3b",
            g800: "#065f46",
            g600: "#059669",
            g500: "#10b981",
            g100: "#d1fae5",
          },
          fontFamily: { gov: ["Verdana","Arial","Tahoma","sans-serif"] },
          boxShadow: { focus: "0 0 0 4px rgba(5,150,105,0.18)" }
        }
      }
    };
  </script>

  <style>
    html,body{font-family:Verdana,Arial,Tahoma,sans-serif;background:#f3f4f6;color:#111827}
    @media print{ .no-print{display:none!important} body{background:#fff!important} }
  </style>
</head>

<body class="bg-govbg text-govtext font-gov">
  {% include 'municipal/sidenav.html' %}
  {% include 'municipal/header.html' %}

  <main class="p-4 sm:p-6">
    <header class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Inventory Dashboard</h1>
        <p class="text-govmuted mt-1">View-only inventory for your municipality.</p>
      </div>
    </header>

    <section class="mb-6 rounded-md border border-govborder bg-govpanel p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center gap-2 font-bold text-slate-800">
        <span class="material-icons-round text-g900">lock</span>
        <span>
          Restricted View: You can only view inventory items within
          <span class="font-bold" id="myMunicipalityLabel"></span>.
        </span>
      </div>


      <span class="inline-flex items-center gap-2 rounded-full border border-govborder bg-slate-50 px-3 py-2 text-[12px] font-bold uppercase tracking-[0.10em] text-slate-700 w-fit">
        <span class="material-icons-round" style="font-size:18px;">location_city</span>
        <span id="myMunicipalityPill"></span>
      </span>
    </section>


    <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
      <div class="rounded-md border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-govmuted font-bold uppercase text-[12px] tracking-[0.10em]">Chemical Inventory</div>
            <div class="text-3xl font-bold mt-2" id="kpiChemical">0</div>
            <div class="text-govmuted text-sm mt-1">Total items</div>
          </div>
          <div class="h-11 w-11 grid place-items-center rounded-md border border-govborder bg-slate-50 text-slate-700">
            <span class="material-icons-round" style="font-size:22px;">science</span>
          </div>
        </div>
      </div>

      <div class="rounded-md border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-govmuted font-bold uppercase text-[12px] tracking-[0.10em]">Natural Resources</div>
            <div class="text-3xl font-bold mt-2" id="kpiResources">0</div>
            <div class="text-govmuted text-sm mt-1">Total items</div>
          </div>
          <div class="h-11 w-11 grid place-items-center rounded-md border border-govborder bg-slate-50 text-slate-700">
            <span class="material-icons-round" style="font-size:22px;">forest</span>
          </div>
        </div>
      </div>

      <div class="rounded-md border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-govmuted font-bold uppercase text-[12px] tracking-[0.10em]">Protected Area</div>
            <div class="text-3xl font-bold mt-2" id="kpiProtected">0</div>
            <div class="text-govmuted text-sm mt-1">Total items</div>
          </div>
          <div class="h-11 w-11 grid place-items-center rounded-md border border-govborder bg-slate-50 text-slate-700">
            <span class="material-icons-round" style="font-size:22px;">verified_user</span>
          </div>
        </div>
      </div>

      <div class="rounded-md border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-govmuted font-bold uppercase text-[12px] tracking-[0.10em]">Biodiversity Inventory</div>
            <div class="text-3xl font-bold mt-2" id="kpiBiodiversity">0</div>
            <div class="text-govmuted text-sm mt-1">Total items</div>
          </div>
          <div class="h-11 w-11 grid place-items-center rounded-md border border-govborder bg-slate-50 text-slate-700">
            <span class="material-icons-round" style="font-size:22px;">pets</span>
          </div>
        </div>
      </div>
    </section>
    
    <section id="filterPanel" class="no-print rounded-md border border-govborder bg-govpanel p-4 mb-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
        <div class="w-full lg:max-w-[520px]">
          <label class="block text-[12px] font-bold uppercase tracking-[0.12em] text-govmuted mb-2">
            Search
          </label>
          <div class="flex items-center gap-2 rounded-md border border-govborder bg-slate-50 px-3 py-2 focus-within:border-g500 focus-within:shadow-focus focus-within:bg-white">
            <span class="material-icons-round text-slate-500" style="font-size:20px;">search</span>
            <input id="searchInput" class="w-full bg-transparent outline-none text-[14px]"
                   type="text" placeholder="Search category, description, province, municipality..." />
          </div>
        </div>

        <div class="w-full sm:w-[320px]">
          <label class="block text-[12px] font-bold uppercase tracking-[0.12em] text-govmuted mb-2">Category</label>
          <select id="filterCategory"
                  class="w-full rounded-md border border-govborder bg-slate-50 px-3 py-2 font-semibold outline-none focus:border-g500 focus:shadow-focus focus:bg-white">
            <option value="All" selected>All</option>
            <option value="Chemical Inventory">Chemical Inventory</option>
            <option value="Natural Resources">Natural Resources</option>
            <option value="Protected Area">Protected Area</option>
            <option value="Biodiversity Inventory">Biodiversity Inventory</option>
          </select>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-2">
        <span class="inline-flex items-center gap-2 rounded-full border border-govborder bg-slate-50 px-3 py-2 text-[12px] font-bold uppercase tracking-[0.10em] text-slate-700">
          <span class="material-icons-round" style="font-size:18px;">filter_alt</span>
          Active Filters
        </span>
        <span class="inline-flex items-center rounded-full border border-govborder bg-slate-50 px-3 py-2 text-[12px] font-bold uppercase tracking-[0.10em] text-slate-700" id="pillCategory">Category: All</span>
        <span class="inline-flex items-center rounded-full border border-govborder bg-slate-50 px-3 py-2 text-[12px] font-bold uppercase tracking-[0.10em] text-slate-700 break-all" id="pillSearch">Search: —</span>
        <span class="ml-auto text-govmuted font-bold" id="resultsCount">Showing 0 items</span>
      </div>
    </section>

    <section class="rounded-md border border-govborder bg-govpanel p-4">
      <div class="mb-3">
        <h2 class="text-xl font-bold">Inventory Items</h2>
        <p class="text-govmuted mt-1">Category, description, quantity. (View-only)</p>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-[15px]">
          <thead>
            <tr class="bg-slate-50 text-slate-700">
              <th class="text-left px-3 py-3 border-b border-govborder font-bold min-w-[210px]">Category</th>
              <th class="text-left px-3 py-3 border-b border-govborder font-bold">Description</th>
              <th class="text-left px-3 py-3 border-b border-govborder font-bold min-w-[120px]">Quantity</th>
              <th class="text-left px-3 py-3 border-b border-govborder font-bold min-w-[180px]">Province</th>
              <th class="text-left px-3 py-3 border-b border-govborder font-bold min-w-[200px]">Municipality</th>
              <th class="text-left px-3 py-3 border-b border-govborder font-bold min-w-[160px]">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    </section>
  </main>


  <script type="module">
    import { auth, db } from '/static/js/firebase-config.js';
    import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    let MY_REGION = "";
    let MY_MUNICIPALITY = "";
    let MY_PROVINCE = "";

    class InventoryItem {
      constructor({ id, category, description, quantity, region, municipality, province }) {
        this.id = String(id);
        this.category = String(category);
        this.description = String(description);
        this.quantity = Number(quantity ?? 0);
        this.region = String(region || "");
        this.municipality = String(municipality || "");
        this.province = String(province || "");
      }
      inScope(municipality) {
        return this.municipality === municipality;
      }
      matches(q) {
        q = (q || "").toLowerCase().trim();
        if (!q) return true;
        const hay = `${this.category} ${this.description} ${this.region} ${this.municipality} ${this.province} ${this.quantity}`.toLowerCase();
        return hay.includes(q);
      }
    }

    class FirebaseInventoryRepository {
      constructor({ db, collectionName = "inventory" }) {
        this.db = db;
        this.collectionName = collectionName;
      }
      async getAll() {
        try {
          console.log('Fetching inventory from Firestore...');
          const inventoryRef = collection(this.db, this.collectionName);
          const snapshot = await getDocs(inventoryRef);
          
          console.log('Total inventory items found:', snapshot.size);
          
          const items = [];
          snapshot.forEach(docSnapshot => {
            const data = docSnapshot.data();
            items.push(new InventoryItem({
              id: docSnapshot.id,
              category: data.category || 'Uncategorized',
              description: data.description || 'No description',
              quantity: data.quantity || 0,
              region: data.region || '',
              municipality: data.municipality || '',
              province: data.province || ''
            }));
          });
          
          console.log('Inventory items loaded:', items.length);
          return items;
        } catch (error) {
          console.error('Error fetching inventory:', error);
          return [];
        }
      }
    }

    const $ = (id) => document.getElementById(id);
    const els = {
      myMunicipalityLabel: $("myMunicipalityLabel"),
      myMunicipalityPill: $("myMunicipalityPill"),
      kpiChemical: $("kpiChemical"),
      kpiResources: $("kpiResources"),
      kpiProtected: $("kpiProtected"),
      kpiBiodiversity: $("kpiBiodiversity"),
      filterCategory: $("filterCategory"),
      searchInput: $("searchInput"),
      pillCategory: $("pillCategory"),
      pillSearch: $("pillSearch"),
      resultsCount: $("resultsCount"),
      itemsTbody: $("itemsTbody"),
    };

    let allItems = [];

    const kpiMap = [
      ["Chemical Inventory", "kpiChemical"],
      ["Natural Resources", "kpiResources"],
      ["Protected Area", "kpiProtected"],
      ["Biodiversity Inventory", "kpiBiodiversity"],
    ];

    function filteredItems() {
      const cat = els.filterCategory.value;
      const q = els.searchInput.value;

      return allItems.filter(i =>
        i.inScope(MY_MUNICIPALITY) &&
        (cat === "All" || i.category === cat) &&
        i.matches(q)
      );
    }

    function renderKpis(list) {
      for (const [category, kpiId] of kpiMap) {
        els[kpiId].textContent = list.filter(i => i.category === category).length;
      }
    }

    function renderTable(list) {
      if (!list.length) {
        els.itemsTbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-3 py-6 text-center text-govmuted font-bold">
              No items found in <span class="font-bold">${MY_MUNICIPALITY}</span> for the selected filters.
            </td>
          </tr>
        `;
        els.resultsCount.textContent = "Showing 0 items";
        return;
      }

      els.itemsTbody.innerHTML = list.map(i => `
        <tr>
          <td class="px-3 py-3 border-b border-govborder font-bold text-slate-800">${i.category}</td>
          <td class="px-3 py-3 border-b border-govborder text-slate-700">${i.description}</td>
          <td class="px-3 py-3 border-b border-govborder font-bold text-slate-900">${i.quantity}</td>
          <td class="px-3 py-3 border-b border-govborder text-slate-700">${i.province || i.region}</td>
          <td class="px-3 py-3 border-b border-govborder text-slate-700">${i.municipality}</td>
          <td class="px-3 py-3 border-b border-govborder">
            <button
              class="inline-flex items-center gap-2 rounded-md border border-govborder bg-white px-3 py-2 text-[12px] font-bold uppercase tracking-[0.10em] text-slate-700 hover:bg-slate-50"
              data-action="view" data-id="${i.id}">
              <span class="material-icons-round" style="font-size:16px;">visibility</span>
              View
            </button>
          </td>
        </tr>
      `).join("");

      els.resultsCount.textContent = `Showing ${list.length} item${list.length === 1 ? "" : "s"}`;
    }

    function refresh() {
      const list = filteredItems();
      els.pillCategory.textContent = `Category: ${els.filterCategory.value}`;
      els.pillSearch.textContent = `Search: ${els.searchInput.value.trim() || "—"}`;
      renderKpis(list);
      renderTable(list);
    }

    function onViewClick(e) {
      const btn = e.target.closest("button[data-action='view']");
      if (!btn) return;

      const id = String(btn.dataset.id);
      const item = allItems.find(x => x.id === id);

      if (!item) return;

      if (!item.inScope(MY_MUNICIPALITY)) {
        alert("Access denied: This item is outside your assigned municipality.");
        return;
      }

      alert(
        `Inventory Item (View)\n\n` +
        `Category: ${item.category}\n` +
        `Province: ${item.province}\n` +
        `Municipality: ${item.municipality}\n` +
        `Quantity: ${item.quantity}\n\n` +
        `Description: ${item.description}`
      );
    }

    async function init() {
      try {
        console.log('Initializing inventory dashboard...');
        
        const currentUser = auth.currentUser;
        if (!currentUser) {
          console.error('No user logged in');
          window.location.href = '/login';
          return;
        }
        
        // Get admin's municipality
        const adminDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (adminDoc.exists()) {
          const adminData = adminDoc.data();
          MY_MUNICIPALITY = adminData.municipality || '';
          MY_PROVINCE = adminData.province || 'Oriental Mindoro';
          MY_REGION = 'Region IV-B (MIMAROPA)';
          
          console.log('Current admin municipality:', MY_MUNICIPALITY);
          console.log('Current admin province:', MY_PROVINCE);
        }
        
        els.myMunicipalityLabel.textContent = MY_MUNICIPALITY;
        els.myMunicipalityPill.textContent = MY_MUNICIPALITY;

        const repo = new FirebaseInventoryRepository({ db });

        allItems = await repo.getAll();
        console.log('All items loaded:', allItems.length);
        
        // Filter to show only municipality-specific items
        const municipalityItems = allItems.filter(i => i.inScope(MY_MUNICIPALITY));
        console.log('Municipality-specific items:', municipalityItems.length);
        
        refresh();
      } catch (error) {
        console.error('Error initializing:', error);
        throw error;
      }
    }

    els.filterCategory.addEventListener("change", refresh);

    let t;
    els.searchInput.addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(refresh, 120);
    });

    els.itemsTbody.addEventListener("click", onViewClick);

    // Initialize with authentication
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('User authenticated:', user.email);
        init().catch(err => {
          console.error(err);
          els.itemsTbody.innerHTML = `
            <tr><td colspan="6" class="px-3 py-6 text-center text-red-700 font-bold">
              Failed to load inventory. Check console for details.
            </td></tr>
          `;
        });
      } else {
        console.log('No user authenticated, redirecting...');
        window.location.href = '/login';
      }
    });
  </script>
</body>
</html>

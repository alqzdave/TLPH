<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DENR | Inventory Dashboard (Municipality View)</title>

  <!-- Load ONCE -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root{
      --gov-font: Verdana, Arial, Tahoma, sans-serif;
      --gov-text: #111827;
      --gov-muted: #4b5563;
      --gov-border: #d1d5db;
      --gov-bg: #f3f4f6;
      --gov-panel: #ffffff;
      --gov-primary: #0f172a;
      --gov-focus: rgba(5, 150, 105, 0.18);
    }

    html, body{
      font-family: var(--gov-font);
      font-size: 16px;
      color: var(--gov-text);
      background: var(--gov-bg);
    }

    .page-wrap{ padding: 16px; }

    .panel, .card-kpi, .notice{
      background: var(--gov-panel);
      border: 1px solid var(--gov-border);
      border-radius: 6px;
      box-shadow: none;
    }

    .gov-h1{ font-weight: 700; letter-spacing: 0.2px; color: var(--gov-text); }
    .gov-subtitle{ font-weight: 400; color: var(--gov-muted); }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--gov-border);
      background: #f9fafb;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: #374151;
      white-space: nowrap;
    }

    .card-kpi .icon{
      height: 44px;
      width: 44px;
      border: 1px solid var(--gov-border);
      background: #f9fafb;
      border-radius: 6px;
      display: grid;
      place-items: center;
      color: #374151;
    }
    .card-kpi .icon .material-icons-round{ font-size: 22px; }

    .btn-outline-soft{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 6px;
      font-family: var(--gov-font);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      font-size: 12px;
      border: 1px solid var(--gov-border);
      background: #fff;
      color: var(--gov-text);
    }
    .btn-outline-soft:hover{ background:#f9fafb; }
    .btn-outline-soft:focus{
      outline: none;
      box-shadow: 0 0 0 4px var(--gov-focus);
    }

    .gov-label{
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--gov-muted);
      margin-bottom: 6px;
      display:block;
    }

    .form-select{
      border-radius: 6px !important;
      border-color: var(--gov-border) !important;
      background-color: #f9fafb !important;
      font-family: var(--gov-font);
      font-weight: 600;
      color: var(--gov-text);
    }
    .form-select:focus{
      border-color: #10b981 !important;
      box-shadow: 0 0 0 4px var(--gov-focus) !important;
      background-color: #fff !important;
    }


    .table{
      font-family: var(--gov-font);
      font-size: 16px;
    }
    .table thead th{
      background: #f9fafb;
      font-weight: 700;
      border-bottom: 1px solid var(--gov-border) !important;
    }
    .table tbody td{
      border-bottom: 1px solid var(--gov-border) !important;
      vertical-align: middle;
    }

    .font-black, .font-extrabold{ font-weight: 700 !important; }

    @media print{
      body{ background:#fff; }
      .btn-outline-soft, #btnViewInventory, #filterPanel { display:none !important; }
      .panel, .card-kpi, .notice{ border: 1px solid #999; }
    }
  </style>
</head>

<body>
  {% include 'municipal/sidenav.html' %}
  {% include 'municipal/header.html' %}

  <div class="page-wrap">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div>
        <h1 class="text-2xl md:text-3xl gov-h1 m-0">Inventory Dashboard</h1>
        <p class="gov-subtitle mt-1 mb-0">View-only inventory for your municipality.</p>
      </div>
    </div>

    <!-- Municipality Restriction Notice -->
    <div class="notice mb-6 p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div class="flex items-center gap-2 text-slate-800 fw-bold">
        <span class="material-icons-round" style="color:#064e3b;">lock</span>
        <span>
          Restricted View: You can only view inventory items within
          <span class="fw-bold" id="myMunicipalityLabel"></span>.
        </span>
      </div>
      <div class="pill">
        <span class="material-icons-round" style="font-size:18px;">location_city</span>
        <span id="myMunicipalityPill"></span>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
      <div class="card-kpi p-4">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-slate-600 font-bold uppercase text-[12px] tracking-wide">Chemical Inventory</div>
            <div class="text-3xl font-bold mt-2" id="kpiChemical">0</div>
            <div class="text-slate-600 text-sm mt-1">Total items</div>
          </div>
          <div class="icon"><span class="material-icons-round">science</span></div>
        </div>
      </div>

      <div class="card-kpi p-4">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-slate-600 font-bold uppercase text-[12px] tracking-wide">Natural Resources</div>
            <div class="text-3xl font-bold mt-2" id="kpiResources">0</div>
            <div class="text-slate-600 text-sm mt-1">Total items</div>
          </div>
          <div class="icon"><span class="material-icons-round">forest</span></div>
        </div>
      </div>

      <div class="card-kpi p-4">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-slate-600 font-bold uppercase text-[12px] tracking-wide">Protected Area</div>
            <div class="text-3xl font-bold mt-2" id="kpiProtected">0</div>
            <div class="text-slate-600 text-sm mt-1">Total items</div>
          </div>
          <div class="icon"><span class="material-icons-round">verified_user</span></div>
        </div>
      </div>

      <div class="card-kpi p-4">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-slate-600 font-bold uppercase text-[12px] tracking-wide">Biodiversity Inventory</div>
            <div class="text-3xl font-bold mt-2" id="kpiBiodiversity">0</div>
            <div class="text-slate-600 text-sm mt-1">Total items</div>
          </div>
          <div class="icon"><span class="material-icons-round">pets</span></div>
        </div>
      </div>
    </div>

    <!-- Filters (Search + Category only) -->
    <div id="filterPanel" class="panel p-4 mb-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
        <div class="w-full lg:max-w-[520px]">
          <label class="gov-label">Search <label class="material-icons-round text-slate-500" style="font-size:20px;">search</label></label>
          <div class="search-wrap"></div>
            <input id="searchInput" class="search-input" type="text" placeholder="Search by category, description, region, municipality..." />
          </div>
        </div>

        <div class="w-full sm:w-[320px]">
          <label class="gov-label">Category</label>
          <select class="form-select py-2" id="filterCategory">
            <option value="All" selected>All</option>
            <option value="Chemical Inventory">Chemical Inventory</option>
            <option value="Natural Resources">Natural Resources</option>
            <option value="Protected Area">Protected Area</option>
            <option value="Biodiversity Inventory">Biodiversity Inventory</option>
          </select>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-2">
        <span class="pill">
          <span class="material-icons-round" style="font-size:18px;">filter_alt</span>
          Active Filters
        </span>
        <span class="pill" id="pillCategory">Category: All</span>
        <span class="pill" id="pillSearch">Search: —</span>
        <span class="ms-auto text-slate-600 fw-bold" id="resultsCount">Showing 0 items</span>
      </div>
    </div>

    <!-- Items Table (View-only) -->
    <div class="panel p-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <div>
          <h2 class="text-xl font-bold text-slate-900 m-0">Inventory Items</h2>
          <p class="gov-subtitle mt-1 mb-0">Category, description, quantity. (View-only)</p>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="min-width: 210px;">Category</th>
              <th>Description</th>
              <th style="min-width: 120px;">Quantity</th>
              <th style="min-width: 180px;">Region</th>
              <th style="min-width: 200px;">Municipality</th>
              <th style="min-width: 160px;">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /**
   * ✅ MUNICIPALITY + REGION RESTRICTED VIEW
   * In production, set these from your login/session.
   */
  const MY_REGION = "NCR";
  const MY_MUNICIPALITY = "Quezon City";

  // ✅ DEMO DATA
  const items = [
    // In-scope (NCR / Quezon City)
    { id: 1,  category: "Chemical Inventory",      description: "Laboratory solvents (ethanol, acetone)",             quantity: 24,  region: "NCR", municipality: "Quezon City" },
    { id: 2,  category: "Chemical Inventory",      description: "Water test reagent kits (pH, nitrates)",             quantity: 60,  region: "NCR", municipality: "Quezon City" },
    { id: 3,  category: "Chemical Inventory",      description: "Spill containment pads and neutralizer",             quantity: 15,  region: "NCR", municipality: "Quezon City" },

    { id: 4,  category: "Natural Resources",       description: "Nursery tools set (shovels, pruners, gloves)",      quantity: 19,  region: "NCR", municipality: "Quezon City" },
    { id: 5,  category: "Natural Resources",       description: "Seedling stock for reforestation (narra, acacia)",   quantity: 300, region: "NCR", municipality: "Quezon City" },

    { id: 6,  category: "Protected Area",          description: "Visitor permit logbook supply",                      quantity: 12,  region: "NCR", municipality: "Quezon City" },
    { id: 7,  category: "Protected Area",          description: "Boundary marker paint and signage materials",        quantity: 35,  region: "NCR", municipality: "Quezon City" },

    { id: 8,  category: "Biodiversity Inventory",  description: "Wildlife monitoring tags (RFID) and bands",          quantity: 80,  region: "NCR", municipality: "Quezon City" },
    { id: 9,  category: "Biodiversity Inventory",  description: "Camera trap batteries and SD cards",                 quantity: 50,  region: "NCR", municipality: "Quezon City" },

    // Out-of-scope (should NOT appear)
    { id: 10, category: "Biodiversity Inventory",  description: "Wildlife monitoring equipment tags",                 quantity: 80,  region: "NCR", municipality: "Manila" },
    { id: 11, category: "Natural Resources",       description: "Seedling stock for reforestation",                   quantity: 450, region: "Region IV-A", municipality: "Calamba" },
    { id: 12, category: "Protected Area",          description: "Ranger uniform patches",                             quantity: 20,  region: "Region V", municipality: "Legazpi" },
    { id: 13, category: "Chemical Inventory",      description: "Hazard label stickers and containers",               quantity: 120, region: "Region III", municipality: "San Fernando" },
  ];

  const els = {
    myMunicipalityLabel: document.getElementById("myMunicipalityLabel"),
    myMunicipalityPill: document.getElementById("myMunicipalityPill"),

    kpiChemical: document.getElementById("kpiChemical"),
    kpiResources: document.getElementById("kpiResources"),
    kpiProtected: document.getElementById("kpiProtected"),
    kpiBiodiversity: document.getElementById("kpiBiodiversity"),

    filterCategory: document.getElementById("filterCategory"),
    searchInput: document.getElementById("searchInput"),

    pillCategory: document.getElementById("pillCategory"),
    pillSearch: document.getElementById("pillSearch"),

    resultsCount: document.getElementById("resultsCount"),
    itemsTbody: document.getElementById("itemsTbody"),
  };

  function normalize(s){ return (s || "").toString().toLowerCase().trim(); }

  function initLocks() {
    els.myMunicipalityLabel.textContent = MY_MUNICIPALITY;
    els.myMunicipalityPill.textContent = MY_MUNICIPALITY;
  }

  function matchesScope(item){
    return item.region === MY_REGION && item.municipality === MY_MUNICIPALITY;
  }

  function matchesFilters(item) {
    if (!matchesScope(item)) return false;

    const selectedCategory = els.filterCategory.value;
    const categoryOk = (selectedCategory === "All") || (item.category === selectedCategory);

    const q = normalize(els.searchInput.value);
    const haystack = normalize(`${item.category} ${item.description} ${item.region} ${item.municipality} ${item.quantity}`);
    const searchOk = !q || haystack.includes(q);

    return categoryOk && searchOk;
  }

  function computeKpis(currentList) {
    const countBy = (name) => currentList.filter(i => i.category === name).length;
    els.kpiChemical.textContent = countBy("Chemical Inventory");
    els.kpiResources.textContent = countBy("Natural Resources");
    els.kpiProtected.textContent = countBy("Protected Area");
    els.kpiBiodiversity.textContent = countBy("Biodiversity Inventory");
  }

  function renderTable(currentList) {
    els.itemsTbody.innerHTML = "";

    if (currentList.length === 0) {
      els.itemsTbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-slate-600 fw-bold py-4">
            No items found in <strong>${MY_MUNICIPALITY}</strong> (${MY_REGION}) for the selected filters.
          </td>
        </tr>
      `;
      els.resultsCount.textContent = "Showing 0 items";
      return;
    }

    currentList.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="fw-bold text-slate-800">${item.category}</td>
        <td class="text-slate-700">${item.description}</td>
        <td class="fw-bold text-slate-900">${item.quantity}</td>
        <td class="text-slate-700">${item.region}</td>
        <td class="text-slate-700">${item.municipality}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary rounded-2 fw-bold" data-action="view" data-id="${item.id}">
            <span class="material-icons-round align-middle" style="font-size:16px;">visibility</span>
            View
          </button>
        </td>
      `;
      els.itemsTbody.appendChild(tr);
    });

    els.resultsCount.textContent = `Showing ${currentList.length} item${currentList.length === 1 ? "" : "s"}`;
  }

  function refresh() {
    const filtered = items.filter(matchesFilters);

    els.pillCategory.textContent = `Category: ${els.filterCategory.value}`;
    els.pillSearch.textContent = `Search: ${els.searchInput.value.trim() ? els.searchInput.value.trim() : "—"}`;

    computeKpis(filtered);
    renderTable(filtered);
  }

  // Events
  els.filterCategory.addEventListener("change", refresh);

  let debounce;
  els.searchInput.addEventListener("input", () => {
    clearTimeout(debounce);
    debounce = setTimeout(refresh, 120);
  });

  els.itemsTbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action='view']");
    if (!btn) return;

    const id = Number(btn.getAttribute("data-id"));
    const item = items.find(i => i.id === id);
    if (!item) return;

    if (!matchesScope(item)) {
      alert("Access denied: This item is outside your assigned region/municipality.");
      return;
    }

    alert(
      `Inventory Item (View)\n\n` +
      `Category: ${item.category}\n` +
      `Region: ${item.region}\n` +
      `Municipality: ${item.municipality}\n` +
      `Quantity: ${item.quantity}\n\n` +
      `Description: ${item.description}`
    );
  });

  // Init
  initLocks();
  refresh();
</script>

</body>
</html>

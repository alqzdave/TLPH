<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            govbg: "#f3f4f6",
            govpanel: "#ffffff",
            govborder: "#d1d5db",
            govtext: "#0f172a",
            govmuted: "#475569",
            g900: "#064e3b",
            g800: "#065f46",
            g700: "#047857",
            g600: "#059669",
            g500: "#10b981",
            g200: "#a7f3d0",
            g100: "#d1fae5",
          },
          fontFamily: {
            gov: ["Verdana", "Arial", "Tahoma", "sans-serif"],
          },
          boxShadow: {
            focus: "0 0 0 4px rgba(16,185,129,0.22)",
          }
        }
      }
    };
  </script>

  <style>
    html, body { font-family: Verdana, Arial, Tahoma, sans-serif; background: #f3f4f6; color: #0f172a; }
    @media print { .no-print { display: none !important; } body { background: #fff !important; } }
  </style>
</head>

<body class="bg-govbg text-govtext">
  {% include 'municipal/sidenav.html' %}
  {% include 'municipal/header.html' %}

  <main class="p-4 sm:p-6">
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-5">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-[0.2px]">Inventory Dashboard</h1>
        <p class="text-govmuted mt-1">Agriculture inventory overview with charts, daily activity, and live filtering.</p>
      </div>

      <div class="no-print inline-flex items-center gap-2 rounded-full border border-govborder bg-white/60 px-3 py-2 text-[12px] font-extrabold uppercase tracking-[0.10em] text-slate-700 w-fit">
        <span class="material-icons-round text-g800" style="font-size:18px;">today</span>
        <span id="todayLabel"></span>
      </div>
    </header>
    
    <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
      <div class="rounded-xl border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-govmuted font-extrabold uppercase text-[12px] tracking-[0.12em]">Total Products</div>
            <div class="text-3xl font-extrabold mt-2" id="kpiTotalProducts">0</div>
            <div class="text-govmuted text-sm mt-1">Unique product records</div>
          </div>
          <div class="h-11 w-11 grid place-items-center rounded-xl border border-govborder bg-g100 text-g900">
            <span class="material-icons-round" style="font-size:22px;">inventory_2</span>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-govmuted font-extrabold uppercase text-[12px] tracking-[0.12em]">Total Quantity</div>
            <div class="text-3xl font-extrabold mt-2" id="kpiTotalQty">0</div>
            <div class="text-govmuted text-sm mt-1">Sum of current quantity</div>
          </div>
          <div class="h-11 w-11 grid place-items-center rounded-xl border border-govborder bg-g100 text-g900">
            <span class="material-icons-round" style="font-size:22px;">stacked_bar_chart</span>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-govmuted font-extrabold uppercase text-[12px] tracking-[0.12em]">Added Today</div>
            <div class="text-3xl font-extrabold mt-2" id="kpiAddedToday">0</div>
            <div class="text-govmuted text-sm mt-1">Created today</div>
          </div>
          <div class="h-11 w-11 grid place-items-center rounded-xl border border-govborder bg-g100 text-g900">
            <span class="material-icons-round" style="font-size:22px;">add_circle</span>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-govmuted font-extrabold uppercase text-[12px] tracking-[0.12em]">Removed Today</div>
            <div class="text-3xl font-extrabold mt-2" id="kpiRemovedToday">0</div>
            <div class="text-govmuted text-sm mt-1">Removed today</div>
          </div>
          <div class="h-11 w-11 grid place-items-center rounded-xl border border-govborder bg-g100 text-g900">
            <span class="material-icons-round" style="font-size:22px;">remove_circle</span>
          </div>
        </div>
      </div>
    </section>

    <section class="grid grid-cols-1 xl:grid-cols-2 gap-4 mb-6">
      <div class="rounded-xl border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-3 mb-2">
          <div>
            <h2 class="text-xl font-extrabold">Total Quantity Trend</h2>
            <p class="text-govmuted mt-1">Last 7 days (demo trend)</p>
          </div>
          <span class="hidden sm:inline-flex items-center gap-2 rounded-full border border-govborder bg-white/60 px-3 py-2 text-[12px] font-extrabold uppercase tracking-[0.10em] text-slate-700">
            <span class="material-icons-round text-g800" style="font-size:18px;">show_chart</span>
            Trend
          </span>
        </div>

        <p class="text-xs text-govmuted mb-2">This is mock daily totals to demonstrate the graph.</p>

        <div class="relative h-[240px] sm:h-[240px] max-sm:h-[200px]">
          <canvas id="chartTotal"></canvas>
        </div>
      </div>

      <div class="rounded-xl border border-govborder bg-govpanel p-4">
        <div class="flex items-start justify-between gap-3 mb-2">
          <div>
            <h2 class="text-xl font-extrabold">Category Distribution</h2>
            <p class="text-govmuted mt-1">Based on current quantity</p>
          </div>
          <span class="hidden sm:inline-flex items-center gap-2 rounded-full border border-govborder bg-white/60 px-3 py-2 text-[12px] font-extrabold uppercase tracking-[0.10em] text-slate-700">
            <span class="material-icons-round text-g800" style="font-size:18px;">donut_large</span>
            Categories
          </span>
        </div>

        <p class="text-xs text-govmuted mb-2">Shows how current quantity is split across categories.</p>

        <div class="relative h-[240px] sm:h-[240px] max-sm:h-[200px]">
          <canvas id="chartCategories"></canvas>
        </div>
      </div>
    </section>

    <section class="no-print rounded-xl border border-govborder bg-govpanel p-4 mb-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
        <div class="w-full lg:max-w-[520px]">
          <label class="block text-[12px] font-extrabold uppercase tracking-[0.12em] text-govmuted mb-2">Search</label>
          <div id="searchWrap" class="flex items-center gap-2 rounded-xl border border-govborder bg-slate-50 px-3 py-2 focus-within:border-g500 focus-within:shadow-focus focus-within:bg-white">
            <span class="material-icons-round text-slate-500" style="font-size:20px;">search</span>
            <input
              id="searchInput"
              class="w-full bg-transparent outline-none text-[14px] text-govtext"
              type="text"
              placeholder="Type to filter (product name, category, owner)..."
            />
          </div>
        </div>

        <div class="w-full lg:max-w-[620px]">
          <label class="block text-[12px] font-extrabold uppercase tracking-[0.12em] text-govmuted mb-2">Category</label>
          <select
            id="filterCategory"
            class="w-full rounded-xl border border-govborder bg-slate-50 px-3 py-2 font-bold text-govtext outline-none focus:border-g500 focus:shadow-focus focus:bg-white"
          >
            <option value="All" selected>All</option>
            <option value="Agriculture">Agriculture</option>
            <option value="Crop & Plant">Crop & Plant</option>
            <option value="Livestock & Poultry">Livestock & Poultry</option>
            <option value="Fisheries & Aquaculture">Fisheries & Aquaculture</option>
            <option value="Agribusiness & Agro-Processing">Agribusiness & Agro-Processing</option>
            <option value="Agricultural Trade (Import & Export)">Agricultural Trade (Import & Export)</option>
            <option value="Land Use & Farm Development infrastracture">Land Use & Farm Development infrastracture</option>
            <option value="Research, Technology & Innovation">Research, Technology & Innovation</option>
            <option value="Farmer Support, Subsidies & Insurance">Farmer Support, Subsidies & Insurance</option>
            <option value="Food Safety & Quality Regulation">Food Safety & Quality Regulation</option>
            <option value="Extension Services & Capacity Building">Extension Services & Capacity Building</option>
            <option value="Climate Change, Disaster & Risk Management">Climate Change, Disaster & Risk Management</option>
            <option value="Data, Monitoring & Digital Agriculture">Data, Monitoring & Digital Agriculture</option>
            <option value="Compliance, Inspection & Enforcement">Compliance, Inspection & Enforcement</option>
            <option value="Institutional & Cooperative Development">Institutional & Cooperative Development</option>
          </select>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-2">
        <span class="inline-flex items-center gap-2 rounded-full border border-govborder bg-white/60 px-3 py-2 text-[12px] font-extrabold uppercase tracking-[0.10em] text-slate-700">
          <span class="material-icons-round text-g800" style="font-size:18px;">filter_alt</span>
          Active Filters
        </span>
        <span class="inline-flex items-center rounded-full border border-govborder bg-white/60 px-3 py-2 text-[12px] font-extrabold uppercase tracking-[0.10em] text-slate-700" id="pillCategory">Category: All</span>
        <span class="inline-flex items-center rounded-full border border-govborder bg-white/60 px-3 py-2 text-[12px] font-extrabold uppercase tracking-[0.10em] text-slate-700 break-all" id="pillSearch">Search: —</span>

        <div class="lg:ml-auto text-govmuted font-bold" id="resultsCount">Showing 0 items</div>
      </div>
    </section>

    <section class="rounded-xl border border-govborder bg-govpanel p-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <div>
          <h2 class="text-xl font-extrabold">Products</h2>
          <p class="text-govmuted mt-1">Name, category, owner, and quantities.</p>
        </div>

        <button
          id="btnPrint"
          type="button"
          class="no-print inline-flex items-center gap-2 rounded-xl border border-g600 px-3 py-2 text-g700 font-extrabold hover:bg-g100"
        >
          <span class="material-icons-round" style="font-size:18px;">print</span>
          Print
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-[15px]">
          <thead>
            <tr class="bg-slate-50">
              <th class="text-left px-3 py-3 border-b border-govborder uppercase tracking-[0.10em] text-[12px] font-extrabold text-slate-700 whitespace-nowrap min-w-[220px]">Product Name</th>
              <th class="text-left px-3 py-3 border-b border-govborder uppercase tracking-[0.10em] text-[12px] font-extrabold text-slate-700 whitespace-nowrap min-w-[280px]">Category</th>
              <th class="text-left px-3 py-3 border-b border-govborder uppercase tracking-[0.10em] text-[12px] font-extrabold text-slate-700 whitespace-nowrap min-w-[200px]">Owner</th>
              <th class="text-left px-3 py-3 border-b border-govborder uppercase tracking-[0.10em] text-[12px] font-extrabold text-slate-700 whitespace-nowrap min-w-[140px]">Initial Qty</th>
              <th class="text-left px-3 py-3 border-b border-govborder uppercase tracking-[0.10em] text-[12px] font-extrabold text-slate-700 whitespace-nowrap min-w-[140px]">Current Qty</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db } from '/static/js/firebase-config.js';
    import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    let currentAdminMunicipality = null;

    const normalize = (s) => (s ?? "").toString().toLowerCase().trim();
    const pad2 = (n) => String(n).padStart(2, "0");
    const fmtDateISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;

    const TODAY = new Date();
    const TODAY_ISO = fmtDateISO(TODAY);

    document.getElementById("todayLabel").textContent =
      TODAY.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });

    class Product {
      constructor({ id, name, category, owner, initialQty, currentQty, addedDate, removedDate, userId, municipality }) {
        this.id = String(id);
        this.name = String(name);
        this.category = String(category);
        this.owner = String(owner);
        this.initialQty = Number(initialQty ?? 0);
        this.currentQty = Number(currentQty ?? 0);
        this.addedDate = String(addedDate ?? "");
        this.removedDate = removedDate ? String(removedDate) : null;
        this.userId = String(userId || "");
        this.municipality = String(municipality || "");
      }
    }

    class FirebaseProductRepository {
      constructor({ db, collectionName = "userInventory" }) {
        this.db = db;
        this.collectionName = collectionName;
      }

      async getAll() {
        try {
          console.log('Fetching user inventory from Firestore...');
          const productsRef = collection(this.db, this.collectionName);
          const snapshot = await getDocs(productsRef);
          
          console.log('Total inventory items found:', snapshot.size);
          
          // Get users map for municipality and names
          const usersRef = collection(this.db, 'users');
          const usersSnapshot = await getDocs(usersRef);
          const usersMap = {};
          
          usersSnapshot.forEach(userDoc => {
            const userData = userDoc.data();
            usersMap[userDoc.id] = {
              name: `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.email || 'Unknown User',
              municipality: userData.municipality || null
            };
          });
          
          const products = [];
          snapshot.forEach(docSnapshot => {
            const data = docSnapshot.data();
            const userInfo = usersMap[data.userId];
            const userMunicipality = userInfo?.municipality;
            
            // Filter by municipality
            console.log(`Inventory ${docSnapshot.id}: User municipality="${userMunicipality}", Admin municipality="${currentAdminMunicipality}"`);
            if (currentAdminMunicipality && userMunicipality !== currentAdminMunicipality) {
              console.log(`⛔ SKIPPED: Inventory ${docSnapshot.id} - municipality mismatch`);
              return;
            }
            
            console.log(`✅ INCLUDED: Inventory ${docSnapshot.id}`);
            
            let addedDate = '';
            if (data.createdAt) {
              const dateObj = data.createdAt.toDate();
              addedDate = fmtDateISO(dateObj);
            }
            
            let removedDate = null;
            if (data.removedAt) {
              const dateObj = data.removedAt.toDate();
              removedDate = fmtDateISO(dateObj);
            }
            
            products.push(new Product({
              id: docSnapshot.id,
              name: data.productName || data.name || 'Unnamed Product',
              category: data.category || 'Uncategorized',
              owner: userInfo?.name || 'Unknown',
              initialQty: data.initialQuantity || data.initialQty || 0,
              currentQty: data.currentQuantity || data.currentQty || 0,
              addedDate: addedDate,
              removedDate: removedDate,
              userId: data.userId || '',
              municipality: userMunicipality || ''
            }));
          });
          
          console.log('Filtered inventory items:', products.length);
          return products;
        } catch (error) {
          console.error('Error fetching user inventory:', error);
          return [];
        }
      }
    }

    let chartTotal = null;
    let chartCategories = null;

    const GREEN_SERIES = [
      "#064e3b", "#065f46", "#047857", "#059669", "#10b981",
      "#34d399", "#6ee7b7", "#a7f3d0", "#d1fae5", "#0f766e",
      "#14532d", "#166534", "#22c55e", "#16a34a", "#4ade80"
    ];

    const dailyTotals = [
      { date: "2026-02-05", totalQty: 2400 },
      { date: "2026-02-06", totalQty: 2525 },
      { date: "2026-02-07", totalQty: 2700 },
      { date: "2026-02-08", totalQty: 2810 },
      { date: "2026-02-09", totalQty: 2960 },
      { date: "2026-02-10", totalQty: 3055 },
      { date: TODAY_ISO,   totalQty: 3120 },
    ];

    function buildCharts(filteredList) {
      const labels = dailyTotals.map(d => d.date);
      const totals = dailyTotals.map(d => d.totalQty);

      if (chartTotal) chartTotal.destroy();
      chartTotal = new Chart(document.getElementById("chartTotal"), {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Total Quantity",
            data: totals,
            backgroundColor: "rgba(16, 185, 129, 0.35)",
            borderColor: "rgba(6, 95, 70, 0.9)",
            borderWidth: 1,
            borderRadius: 6,
            maxBarThickness: 38
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true, labels: { boxWidth: 12 } } },
          scales: {
            x: { grid: { display: false }, ticks: { maxRotation: 0, autoSkip: true } },
            y: { beginAtZero: true, ticks: { maxTicksLimit: 5 } }
          }
        }
      });

      const map = new Map();
      for (const p of filteredList) {
        map.set(p.category, (map.get(p.category) || 0) + Number(p.currentQty || 0));
      }
      const catLabels = Array.from(map.keys());
      const catValues = Array.from(map.values());

      if (chartCategories) chartCategories.destroy();
      chartCategories = new Chart(document.getElementById("chartCategories"), {
        type: "doughnut",
        data: {
          labels: catLabels,
          datasets: [{
            label: "Current Quantity",
            data: catValues,
            backgroundColor: catLabels.map((_, i) => GREEN_SERIES[i % GREEN_SERIES.length]),
            borderColor: "#ffffff",
            borderWidth: 2,
            hoverOffset: 6,
            cutout: "68%"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                boxWidth: 12,
                padding: 12,
                font: { size: window.innerWidth <= 640 ? 10 : 11 }
              }
            }
          }
        }
      });
    }

    const els = {
      kpiTotalProducts: document.getElementById("kpiTotalProducts"),
      kpiTotalQty: document.getElementById("kpiTotalQty"),
      kpiAddedToday: document.getElementById("kpiAddedToday"),
      kpiRemovedToday: document.getElementById("kpiRemovedToday"),
      searchInput: document.getElementById("searchInput"),
      filterCategory: document.getElementById("filterCategory"),
      pillCategory: document.getElementById("pillCategory"),
      pillSearch: document.getElementById("pillSearch"),
      resultsCount: document.getElementById("resultsCount"),
      itemsTbody: document.getElementById("itemsTbody"),
      btnPrint: document.getElementById("btnPrint"),
    };

    let allProducts = [];

    function matchesFilters(p) {
      const selectedCategory = els.filterCategory.value;
      const categoryOk = (selectedCategory === "All") || (p.category === selectedCategory);

      const q = normalize(els.searchInput.value);
      const haystack = normalize(`${p.name} ${p.category} ${p.owner} ${p.initialQty} ${p.currentQty}`);
      const searchOk = !q || haystack.includes(q);

      return categoryOk && searchOk;
    }

    function computeKpis(list) {
      const totalProducts = list.length;
      const totalQty = list.reduce((sum, p) => sum + Number(p.currentQty || 0), 0);
      const addedToday = list.filter(p => p.addedDate === TODAY_ISO).length;
      const removedToday = list.filter(p => p.removedDate === TODAY_ISO).length;

      els.kpiTotalProducts.textContent = totalProducts;
      els.kpiTotalQty.textContent = totalQty;
      els.kpiAddedToday.textContent = addedToday;
      els.kpiRemovedToday.textContent = removedToday;
    }

    function renderTable(list) {
      els.itemsTbody.innerHTML = "";

      if (list.length === 0) {
        els.itemsTbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-3 py-6 text-center text-govmuted font-bold">
              No products found for the selected filters.
            </td>
          </tr>
        `;
        els.resultsCount.textContent = "Showing 0 items";
        return;
      }

      for (const p of list) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-3 border-b border-govborder font-extrabold text-slate-900">${p.name}</td>
          <td class="px-3 py-3 border-b border-govborder text-slate-700">${p.category}</td>
          <td class="px-3 py-3 border-b border-govborder text-slate-700">${p.owner}</td>
          <td class="px-3 py-3 border-b border-govborder font-extrabold text-slate-900">${p.initialQty}</td>
          <td class="px-3 py-3 border-b border-govborder font-extrabold text-slate-900">${p.currentQty}</td>
        `;
        els.itemsTbody.appendChild(tr);
      }

      els.resultsCount.textContent = `Showing ${list.length} item${list.length === 1 ? "" : "s"}`;
    }

    function refresh() {
      const filtered = allProducts.filter(matchesFilters);

      els.pillCategory.textContent = `Category: ${els.filterCategory.value}`;
      els.pillSearch.textContent = `Search: ${els.searchInput.value.trim() ? els.searchInput.value.trim() : "—"}`;

      computeKpis(filtered);
      renderTable(filtered);
      buildCharts(filtered);
    }

    async function initDashboard() {
      try {
        console.log('Initializing user inventory dashboard...');
        
        const currentUser = auth.currentUser;
        if (!currentUser) {
          console.error('No user logged in');
          window.location.href = '/login';
          return;
        }
        
        // Get admin's municipality
        const adminDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (adminDoc.exists()) {
          const adminData = adminDoc.data();
          currentAdminMunicipality = adminData.municipality;
          console.log('Current admin municipality:', currentAdminMunicipality);
        }

        const repo = new FirebaseProductRepository({ db });

        allProducts = await repo.getAll();
        console.log('All products loaded:', allProducts.length);
        
        refresh();
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        throw error;
      }
    }

    els.filterCategory.addEventListener("change", refresh);

    let debounce;
    els.searchInput.addEventListener("input", () => {
      clearTimeout(debounce);
      debounce = setTimeout(refresh, 120);
    });

    window.addEventListener("resize", () => {
      clearTimeout(debounce);
      debounce = setTimeout(refresh, 200);
    });

    els.btnPrint.addEventListener("click", () => window.print());

    // Initialize with authentication
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('User authenticated:', user.email);
        initDashboard().catch((err) => {
          console.error(err);
          els.itemsTbody.innerHTML = `
            <tr><td colspan="5" class="px-3 py-6 text-center text-red-700 font-bold">
              Failed to load products. Check console for details.
            </td></tr>
          `;
        });
      } else {
        console.log('No user authenticated, redirecting...');
        window.location.href = '/login';
      }
    });
  </script>
</body>
</html>

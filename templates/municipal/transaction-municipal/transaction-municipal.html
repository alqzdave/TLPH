<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DENR Transactions Analytics</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --gov-font: Verdana, Arial, Tahoma, sans-serif;
    }
    html, body{
      font-family: var(--gov-font);
      font-size: 16px; /* ~12pt */
    }
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url('/static/images/denr.jpg');
      background-repeat: no-repeat;
      background-position: center 30%;
      background-size: 520px;
      opacity: 0.035;
      pointer-events: none;
      z-index: -1;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-100 text-slate-900">
  {% include 'municipal/header.html' %}
  {% include 'municipal/sidenav.html' %}

  <div class="mx-auto w-full max-w-[1400px] px-4 py-5">
    <!-- Topbar -->
    <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold tracking-tight text-slate-900">
          DENR Transactions Analytics
        </h1>
        <p class="mt-1 text-sm text-slate-600">
          Graphs and analytics for payments and transaction status (Municipality-scoped view).
        </p>
      </div>

      <div class="flex flex-wrap items-center gap-2 md:justify-end">
        <div id="scopeChip"
             class="inline-flex items-center gap-2 rounded-full border border-gray-300 bg-gray-50 px-3 py-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-700">
          Municipality: —
        </div>

        <button id="demoRefreshBtn"
                class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-3 py-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-800 hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-emerald-100"
                type="button">
          <span class="material-icons-round text-[18px]">refresh</span>
          Refresh
        </button>

        <button id="exportBtn"
                class="inline-flex items-center gap-2 rounded-md border border-slate-900 bg-slate-900 px-3 py-2 text-xs font-bold uppercase tracking-[0.12em] text-white hover:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-emerald-100"
                type="button">
          <span class="material-icons-round text-[18px]">file_download</span>
          Export (Demo)
        </button>
      </div>
    </div>

    <section class="grid grid-cols-1 gap-3 sm:grid-cols-2 xl:grid-cols-4 mb-4">
      <div class="rounded-md border border-gray-300 bg-white p-4">
        <div class="text-xs font-bold uppercase tracking-[0.12em] text-slate-600">Total Transactions</div>
        <div class="mt-2 text-3xl font-bold text-slate-900" id="kpiTotalTx">0</div>
        <div class="mt-1 text-sm text-slate-600">In your municipality</div>
      </div>

      <div class="rounded-md border border-gray-300 bg-white p-4">
        <div class="text-xs font-bold uppercase tracking-[0.12em] text-slate-600">Total Paid</div>
        <div class="mt-2 text-3xl font-bold text-slate-900" id="kpiPaid">0</div>
        <div class="mt-1 text-sm text-slate-600">Paid transactions</div>
      </div>

      <div class="rounded-md border border-gray-300 bg-white p-4">
        <div class="text-xs font-bold uppercase tracking-[0.12em] text-slate-600">Total Pending</div>
        <div class="mt-2 text-3xl font-bold text-slate-900" id="kpiPending">0</div>
        <div class="mt-1 text-sm text-slate-600">Awaiting payment</div>
      </div>

      <div class="rounded-md border border-gray-300 bg-white p-4">
        <div class="text-xs font-bold uppercase tracking-[0.12em] text-slate-600">Total Amount Paid</div>
        <div class="mt-2 text-3xl font-bold text-slate-900" id="kpiAmount">₱0.00</div>
        <div class="mt-1 text-sm text-slate-600">Sum of paid amounts</div>
      </div>
    </section>

    <section class="grid grid-cols-1 gap-3 xl:grid-cols-2 mb-4">
      <div class="rounded-md border border-gray-300 bg-white p-4">
        <div class="flex items-start justify-between gap-3 mb-3">
          <div>
            <h2 class="text-base font-bold text-slate-900">Volume by Type</h2>
            <p class="mt-1 text-sm text-slate-600">Import Permit, Licensing Fees, Service Fees, Others</p>
          </div>
          <span class="inline-flex items-center gap-2 rounded-full border border-gray-300 bg-gray-50 px-3 py-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-700">
            <span class="material-icons-round text-[18px]">insights</span>
            Summary
          </span>
        </div>
        <div class="relative h-[320px]">
          <canvas id="typeBar"></canvas>
        </div>
      </div>

      <div class="rounded-md border border-gray-300 bg-white p-4">
        <div class="flex items-start justify-between gap-3 mb-3">
          <div>
            <h2 class="text-base font-bold text-slate-900">Transaction Status</h2>
            <p class="mt-1 text-sm text-slate-600">Paid, Pending, Failed</p>
          </div>
          <span class="inline-flex items-center gap-2 rounded-full border border-gray-300 bg-gray-50 px-3 py-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-700">
            <span class="material-icons-round text-[18px]">donut_large</span>
            Status Split
          </span>
        </div>
        <div class="relative h-[320px]">
          <canvas id="statusDonut"></canvas>
        </div>
      </div>
    </section>

    <section class="rounded-md border border-gray-300 bg-white p-4">
      <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between mb-3">
        <div>
          <h3 class="text-lg font-bold text-slate-900">Transactions</h3>
          <p class="mt-1 text-sm text-slate-600">
            Per-transaction view (ID, Payer, Type, Date, Status, Amount) in your municipality.
          </p>
        </div>

        <div class="inline-flex items-center rounded-full border border-gray-300 bg-gray-50 px-3 py-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-700">
          Currency: Philippine Peso (₱)
        </div>
      </div>

      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-3">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:flex-wrap">
          <div class="flex items-center gap-2 rounded-md border border-gray-300 bg-gray-50 px-3 py-2 focus-within:ring-4 focus-within:ring-emerald-100 focus-within:border-emerald-400">
            <span class="material-icons-round text-slate-500">search</span>
            <input
              id="searchInput"
              type="text"
              placeholder="Search by ID, Payer, or Type…"
              class="w-[260px] max-w-full bg-transparent text-sm text-slate-900 outline-none placeholder:text-slate-500"
            />
          </div>

          <div class="relative">
            <select id="statusSelect"
                    class="h-[42px] rounded-md border border-gray-300 bg-gray-50 px-3 pr-10 text-xs font-bold uppercase tracking-[0.12em] text-slate-800 outline-none hover:bg-white focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100">
              <option value="all">All Status</option>
              <option value="Paid">Paid</option>
              <option value="Pending">Pending</option>
              <option value="Failed">Failed</option>
            </select>
            <span class="material-icons-round pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-500">expand_more</span>
          </div>

          <button id="searchBtn"
                  class="inline-flex items-center justify-center rounded-md border border-slate-900 bg-slate-900 px-3 py-2 text-xs font-bold uppercase tracking-[0.12em] text-white hover:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-emerald-100"
                  type="button">
            Search
          </button>
        </div>

        <div id="resultsChip"
             class="inline-flex items-center rounded-full border border-gray-300 bg-gray-50 px-3 py-2 text-xs font-bold uppercase tracking-[0.12em] text-slate-700">
          Showing 0 of 0
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full table-fixed border-collapse">
          <thead>
            <tr class="bg-gray-50">
              <th class="border-y border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-[0.12em] text-slate-600 w-[14%]">ID</th>
              <th class="border-y border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-[0.12em] text-slate-600 w-[20%]">Payer</th>
              <th class="border-y border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-[0.12em] text-slate-600 w-[18%]">Type</th>
              <th class="border-y border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-[0.12em] text-slate-600 w-[16%]">Date</th>
              <th class="border-y border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-[0.12em] text-slate-600 w-[14%]">Status</th>
              <th class="border-y border-gray-300 px-3 py-3 text-right text-xs font-bold uppercase tracking-[0.12em] text-slate-600 w-[18%]">Amount</th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
  import { auth, db } from '/static/js/firebase-config.js';
  import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

  let CURRENT_MUNICIPALITY = null;
  let allTransactions = [];

  const peso = new Intl.NumberFormat("en-PH", {
    style: "currency", currency: "PHP", minimumFractionDigits: 2
  });

  const dateFmt = new Intl.DateTimeFormat("en-PH", {
    year: "numeric", month: "short", day: "2-digit"
  });

  function formatDate(iso){
    const d = new Date(iso + "T00:00:00");
    return isNaN(d.getTime()) ? iso : dateFmt.format(d);
  }

  // DOM
  const scopeChip = document.getElementById("scopeChip");
  const resultsChip = document.getElementById("resultsChip");

  const searchInput = document.getElementById("searchInput");
  const statusSelect = document.getElementById("statusSelect");
  const searchBtn = document.getElementById("searchBtn");

  const kpiTotalTx = document.getElementById("kpiTotalTx");
  const kpiPaid = document.getElementById("kpiPaid");
  const kpiPending = document.getElementById("kpiPending");
  const kpiAmount = document.getElementById("kpiAmount");

  const txBody = document.getElementById("txBody");

  let barChart, donutChart;

  function applySearchAndStatus(data){
    const q = searchInput.value.trim().toLowerCase();
    const status = statusSelect.value;

    const filtered = data.filter(t => {
      const matchQuery =
        q === "" ||
        (t.id || "").toLowerCase().includes(q) ||
        (t.payer || "").toLowerCase().includes(q) ||
        (t.type || "").toLowerCase().includes(q);

      const matchStatus = status === "all" || t.status === status;
      return matchQuery && matchStatus;
    });

    resultsChip.textContent = `Showing ${filtered.length} of ${data.length}`;
    return filtered;
  }

  function computeStats(data){
    const totalTx = data.length;
    const paid = data.filter(x => x.status === "Paid").length;
    const pending = data.filter(x => x.status === "Pending").length;
    const failed = data.filter(x => x.status === "Failed").length;

    const amountPaid = data
      .filter(x => x.status === "Paid")
      .reduce((sum, x) => sum + (Number(x.amount) || 0), 0);

    const byType = {};
    for (const t of data){
      byType[t.type] = (byType[t.type] || 0) + 1;
    }

    return { totalTx, paid, pending, failed, amountPaid, byType };
  }

  function renderKpis(stats){
    kpiTotalTx.textContent = stats.totalTx;
    kpiPaid.textContent = stats.paid;
    kpiPending.textContent = stats.pending;
    kpiAmount.textContent = peso.format(stats.amountPaid);
  }

  function renderCharts(stats){
    const typeLabels = Object.keys(stats.byType);
    const typeValues = Object.values(stats.byType);

    if (barChart) barChart.destroy();
    barChart = new Chart(document.getElementById("typeBar"), {
      type: "bar",
      data: { labels: typeLabels, datasets: [{ label: "Transactions", data: typeValues }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
      }
    });

    if (donutChart) donutChart.destroy();
    donutChart = new Chart(document.getElementById("statusDonut"), {
      type: "doughnut",
      data: {
        labels: ["Paid","Pending","Failed"],
        datasets: [{ data: [stats.paid, stats.pending, stats.failed], cutout: "60%" }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } }
    });
  }

  function statusBadge(status) {
    const base = "inline-flex items-center rounded-full border border-gray-300 bg-white px-2.5 py-1 text-xs font-bold uppercase tracking-[0.12em]";
    if (status === "Paid") return `<span class="${base} text-emerald-800">Paid</span>`;
    if (status === "Pending") return `<span class="${base} text-amber-800">Pending</span>`;
    return `<span class="${base} text-rose-800">Failed</span>`;
  }

  function renderTransactionsTable(data){
    const sorted = [...data].sort((a,b) => (b.date || "").localeCompare(a.date || ""));
    txBody.innerHTML = "";

    for (const t of sorted){
      txBody.innerHTML += `
        <tr class="border-b border-gray-200">
          <td class="px-3 py-3 text-sm text-slate-900" title="${t.id}">${t.id}</td>
          <td class="px-3 py-3 text-sm text-slate-900" title="${t.payer || ""}">${t.payer ? t.payer : "—"}</td>
          <td class="px-3 py-3 text-sm text-slate-900" title="${t.type}">${t.type}</td>
          <td class="px-3 py-3 text-sm text-slate-900" title="${t.date}">${formatDate(t.date)}</td>
          <td class="px-3 py-3 text-sm">${statusBadge(t.status)}</td>
          <td class="px-3 py-3 text-sm text-right text-slate-900">${peso.format(Number(t.amount) || 0)}</td>
        </tr>
      `;
    }

    if (txBody.innerHTML.trim() === "") {
      txBody.innerHTML = `
        <tr>
          <td colspan="6" class="px-3 py-4 text-sm text-slate-600">
            No transactions found for the selected search/filter.
          </td>
        </tr>
      `;
    }
  }

  async function loadTransactions() {
    try {
      console.log('Loading transactions...');
      
      const currentUser = auth.currentUser;
      if (!currentUser) {
        console.error('No user logged in');
        return;
      }
      
      // Get admin's municipality
      const adminDoc = await getDoc(doc(db, 'users', currentUser.uid));
      if (adminDoc.exists()) {
        const adminData = adminDoc.data();
        CURRENT_MUNICIPALITY = adminData.municipality;
        console.log('Current admin municipality:', CURRENT_MUNICIPALITY);
        scopeChip.textContent = `Municipality: ${CURRENT_MUNICIPALITY}`;
      }
      
      // Create a map of users with their municipalities
      const usersRef = collection(db, 'users');
      const usersSnapshot = await getDocs(usersRef);
      const usersMap = {};
      
      usersSnapshot.forEach(userDoc => {
        const userData = userDoc.data();
        usersMap[userDoc.id] = {
          name: `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.email || 'Unknown User',
          municipality: userData.municipality || null
        };
      });
      
      console.log('Users loaded:', Object.keys(usersMap).length);
      
      // Fetch transactions
      const transactionsRef = collection(db, 'transactions');
      const transactionsSnapshot = await getDocs(transactionsRef);
      
      console.log('Total transactions found:', transactionsSnapshot.size);
      
      allTransactions = [];
      
      transactionsSnapshot.forEach(docSnapshot => {
        const data = docSnapshot.data();
        const userInfo = usersMap[data.userId];
        const userName = userInfo?.name || 'Unknown User';
        const userMunicipality = userInfo?.municipality;
        
        // Filter by municipality
        console.log(`Transaction ${docSnapshot.id}: User municipality="${userMunicipality}", Admin municipality="${CURRENT_MUNICIPALITY}"`);
        if (CURRENT_MUNICIPALITY && userMunicipality !== CURRENT_MUNICIPALITY) {
          console.log(`⛔ SKIPPED: Transaction ${docSnapshot.id} - municipality mismatch`);
          return;
        }
        
        console.log(`✅ INCLUDED: Transaction ${docSnapshot.id}`);
        
        let dateStr = 'N/A';
        if (data.createdAt) {
          const dateObj = data.createdAt.toDate();
          const year = dateObj.getFullYear();
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const day = String(dateObj.getDate()).padStart(2, '0');
          dateStr = `${year}-${month}-${day}`;
        }
        
        allTransactions.push({
          id: docSnapshot.id,
          municipality: userMunicipality,
          payer: userName,
          type: data.transactionType || data.type || 'Other',
          date: dateStr,
          status: data.status || 'Pending',
          amount: Number(data.amount) || 0
        });
      });
      
      console.log('Filtered transactions:', allTransactions.length);
      
      renderAll();
      
    } catch (error) {
      console.error('Error loading transactions:', error);
    }
  }

  async function renderAll(){
    if (!CURRENT_MUNICIPALITY) {
      scopeChip.textContent = 'Municipality: —';
      return;
    }
    
    scopeChip.textContent = `Municipality: ${CURRENT_MUNICIPALITY}`;

    const filtered = applySearchAndStatus(allTransactions);

    const stats = computeStats(filtered);
    renderKpis(stats);
    renderCharts(stats);
    renderTransactionsTable(filtered);
  }

  document.getElementById("demoRefreshBtn").addEventListener("click", async () => {
    await loadTransactions();
  });

  document.getElementById("exportBtn").addEventListener("click", () => {
    alert("Demo export. In production, export only municipality-scoped & filtered data.");
  });

  let debounce;
  searchInput.addEventListener("input", () => {
    clearTimeout(debounce);
    debounce = setTimeout(() => renderAll(), 150);
  });

  statusSelect.addEventListener("change", () => renderAll());
  searchBtn.addEventListener("click", () => renderAll());

  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") renderAll();
  });

  // Authentication check and data loading
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      console.log('No user authenticated, redirecting to login...');
      window.location.href = '/login';
    } else {
      console.log('User authenticated:', user.email);
      loadTransactions();
    }
  });
</script>

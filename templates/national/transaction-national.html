<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TLPH | National Dashboard - Transactions</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --gov-font: "Inter", -apple-system, sans-serif;
      --gov-bg: #f1f5f9;
      --gov-panel: #ffffff;
      --gov-border: #e2e8f0;
    }
    html, body { font-family: var(--gov-font); height: 100vh; overflow: hidden; }
    body { background: var(--gov-bg); }
    .card { background: var(--gov-panel); border: 1px solid var(--gov-border); border-radius: 8px; }
    .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .table-compact td, .table-compact th { padding: 0.4rem 0.6rem; font-size: 0.7rem; }
    .chart-container { position: relative; height: 130px; width: 100%; }
    .modal-bg { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); }
    .status-pill { font-size: 0.65rem; font-weight: 700; padding: 0.15rem 0.5rem; border-radius: 9999px; border: 1px solid; }
  </style>
</head>

<body class="text-slate-900">
  <div class="flex h-screen overflow-hidden">
    {% include 'national/sidenav-national.html' %}

    <main class="flex-1 flex flex-col min-w-0 p-3 space-y-3 overflow-hidden">
      
      <section class="card p-2 px-4 flex items-center justify-between shrink-0">
        <div>
          <h1 class="font-bold text-sm flex items-center gap-2">
            <span class="material-icons-round text-slate-500">account_balance_wallet</span>
            National Transaction Registry
          </h1>
          <p class="text-[10px] text-gray-500 uppercase tracking-wider">Republic of the Philippines • Centralized Monitoring</p>
        </div>
        <button class="px-3 py-1.5 rounded-md border border-slate-200 bg-white hover:bg-slate-50 text-[11px] font-bold flex items-center gap-1.5">
          <span class="material-icons-round text-sm">download</span> Export CSV
        </button>
      </section>

      <section class="card p-2 shrink-0">
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-1 border-r pr-2 border-slate-200">
            <input id="fFrom" type="date" class="px-2 py-1 rounded border border-slate-200 text-[11px] bg-slate-50 outline-none focus:ring-1 focus:ring-emerald-500" />
            <span class="text-[10px] text-slate-400 font-bold uppercase">to</span>
            <input id="fTo" type="date" class="px-2 py-1 rounded border border-slate-200 text-[11px] bg-slate-50 outline-none focus:ring-1 focus:ring-emerald-500" />
          </div>

          <select id="fType" class="px-2 py-1 rounded border border-slate-200 text-[11px] bg-white outline-none">
            <option value="ALL">All Transaction Types</option>
            <option>Application</option><option>Service Request</option><option>Licensing/Permit</option>
          </select>

          <select id="fRegion" class="px-2 py-1 rounded border border-slate-200 text-[11px] bg-white outline-none">
            <option value="ALL">All Regions</option>
            <option>NCR</option><option>Region IV-A</option><option>Region VII</option><option>Region III</option><option>BARMM</option><option>CAR</option>
          </select>

          <select id="fStatus" class="px-2 py-1 rounded border border-slate-200 text-[11px] bg-white outline-none">
            <option value="ALL">All Status</option>
            <option>Paid</option><option>Refunded</option>
          </select>

          <input id="fSearch" type="text" placeholder="Search ref # / name / location..." class="flex-1 min-w-[150px] px-2 py-1 rounded border border-slate-200 text-[11px] focus:ring-1 focus:ring-emerald-500 outline-none" />

          <button onclick="applyTxnFilters()" class="px-3 py-1 bg-slate-900 text-white rounded text-[11px] font-bold hover:bg-slate-800 transition-colors">Apply</button>
          <button onclick="resetTxnFilters()" class="px-3 py-1 bg-slate-100 rounded text-[11px] font-bold hover:bg-slate-200 text-slate-600 transition-colors">Reset</button>
        </div>
      </section>

      <section class="grid grid-cols-4 gap-3 shrink-0">
        <div class="card p-2 px-3"><span class="text-[9px] text-gray-500 font-bold uppercase">Count</span><div id="kpiTxnCount" class="text-base font-black">—</div></div>
        <div class="card p-2 px-3 border-l-2 border-l-emerald-500"><span class="text-[9px] text-emerald-600 font-bold uppercase">Total Paid</span><div id="kpiPaid" class="text-base font-black">—</div></div>
        <div class="card p-2 px-3 border-l-2 border-l-rose-500"><span class="text-[9px] text-rose-600 font-bold uppercase">Total Refunded</span><div id="kpiRefunded" class="text-base font-black">—</div></div>
        <div class="card p-2 px-3 border-l-2 border-l-blue-500"><span class="text-[9px] text-blue-600 font-bold uppercase">Net Revenue</span><div id="kpiNet" class="text-base font-black">—</div></div>
      </section>

      <div class="flex-1 grid grid-cols-12 gap-3 min-h-0">
        <div class="col-span-12 xl:col-span-3 flex flex-col gap-3 overflow-y-auto custom-scroll pr-1">
          <div class="card p-3"><p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">Status breakdown</p><div class="chart-container"><canvas id="chartStatus"></canvas></div></div>
          <div class="card p-3"><p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">Amount by Type</p><div class="chart-container"><canvas id="chartType"></canvas></div></div>
          <div class="card p-3"><p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">Amount by Region</p><div class="chart-container"><canvas id="chartRegion"></canvas></div></div>
        </div>

        <section class="col-span-12 xl:col-span-9 card flex flex-col overflow-hidden">
          <div class="p-2 px-4 border-b bg-slate-50 flex justify-between items-center shrink-0">
            <span class="font-bold text-[11px] text-slate-700">TRANSACTION DATA LOG</span>
            <span class="text-[10px] text-slate-400 font-bold uppercase">Showing filtered records</span>
          </div>

          <div class="flex-1 overflow-auto custom-scroll">
            <table class="min-w-full table-compact">
              <thead class="bg-white border-b sticky top-0 z-10 shadow-sm">
                <tr class="text-left text-slate-500">
                  <th>Reference #</th>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Location</th>
                  <th>Status</th>
                  <th class="text-right">Amount</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody id="txnTbody" class="divide-y divide-slate-100">
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="font-bold text-slate-800">TXN-004182</td>
                  <td>Dela Cruz, Juan</td>
                  <td class="text-[10px] text-slate-500">Application</td>
                  <td>2026-02-12</td>
                  <td class="text-[10px] text-slate-500">NCR, QC</td>
                  <td><span class="status-pill border-emerald-200 bg-emerald-50 text-emerald-800">Paid</span></td>
                  <td class="text-right font-bold" data-amount="1250">₱ 1,250</td>
                  <td class="text-center">
                    <button onclick="viewThisRow(this)" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-900 transition-colors" title="View Details">
                      <span class="material-icons-round text-base">visibility</span>
                    </button>
                  </td>
                </tr>
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="font-bold text-slate-800">TXN-004170</td>
                  <td>Santos, Maria</td>
                  <td class="text-[10px] text-slate-500">Licensing/Permit</td>
                  <td>2026-02-10</td>
                  <td class="text-[10px] text-slate-500">R4A, Calamba</td>
                  <td><span class="status-pill border-rose-200 bg-rose-50 text-rose-800">Refunded</span></td>
                  <td class="text-right font-bold" data-amount="850">₱ 850</td>
                  <td class="text-center">
                    <button onclick="viewThisRow(this)" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-900 transition-colors">
                      <span class="material-icons-round text-base">visibility</span>
                    </button>
                  </td>
                </tr>
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="font-bold text-slate-800">TXN-004155</td>
                  <td>Rivera, Liza</td>
                  <td class="text-[10px] text-slate-500">Service Request</td>
                  <td>2026-02-09</td>
                  <td class="text-[10px] text-slate-500">R7, Cebu City</td>
                  <td><span class="status-pill border-emerald-200 bg-emerald-50 text-emerald-800">Paid</span></td>
                  <td class="text-right font-bold" data-amount="600">₱ 600</td>
                  <td class="text-center">
                    <button onclick="viewThisRow(this)" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-900 transition-colors">
                      <span class="material-icons-round text-base">visibility</span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <footer class="flex justify-between items-center py-1 border-t text-[10px] text-slate-400 shrink-0">
        <div>© 2026 TLPH • National Registry System</div>
        <div class="flex gap-3 uppercase font-bold tracking-tighter">
          <span>Official Confidential Data</span>
          <span class="text-slate-300">|</span>
          <span>Environment: Production</span>
        </div>
      </footer>
    </main>
  </div>

  <div id="txnViewModal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50 p-4">
    <div class="bg-white rounded-lg w-full max-w-sm overflow-hidden shadow-2xl">
      <div class="px-4 py-3 bg-slate-50 border-b flex items-center justify-between">
        <h3 class="font-bold text-slate-700 text-sm uppercase">Transaction Summary</h3>
        <button onclick="closeTxnView()" class="text-slate-400 hover:text-slate-600"><span class="material-icons-round">close</span></button>
      </div>
      <div id="txnViewContent" class="p-4 grid grid-cols-2 gap-x-4 gap-y-3"></div>
      <div class="px-4 py-3 bg-slate-50 border-t flex justify-end">
        <button onclick="closeTxnView()" class="px-4 py-1.5 rounded bg-white border border-slate-200 text-xs font-bold hover:bg-slate-50 transition-colors shadow-sm uppercase">Close</button>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.getElementById('txnTbody');
    const fFrom = document.getElementById('fFrom');
    const fTo = document.getElementById('fTo');
    const fType = document.getElementById('fType');
    const fRegion = document.getElementById('fRegion');
    const fStatus = document.getElementById('fStatus');
    const fSearch = document.getElementById('fSearch');
    let charts = {};

    function peso(n){ return "₱ " + new Intl.NumberFormat('en-US', { minimumFractionDigits: 0 }).format(Number(n || 0)); }
    function getAmount(td){ return Number(td.getAttribute('data-amount')) || 0; }

    function applyTxnFilters(){
      const type = fType.value;
      const region = fRegion.value;
      const status = fStatus.value;
      const q = fSearch.value.trim().toLowerCase();
      const from = fFrom.value ? new Date(fFrom.value + "T00:00:00") : null;
      const to = fTo.value ? new Date(fTo.value + "T23:59:59") : null;

      [...tbody.querySelectorAll('tr')].forEach(tr => {
        const c = tr.cells;
        const hay = (c[0].innerText + " " + c[1].innerText + " " + c[4].innerText).toLowerCase();
        const d = new Date(c[3].innerText + "T12:00:00");

        const okType = (type === "ALL") || (c[2].innerText.trim() === type);
        const okRegion = (region === "ALL") || (c[4].innerText.includes(region));
        const okStatus = (status === "ALL") || (c[5].innerText.trim() === status);
        const okQ = (!q) || hay.includes(q);
        let okDate = true;
        if(from && d < from) okDate = false;
        if(to && d > to) okDate = false;

        tr.style.display = (okType && okRegion && okStatus && okQ && okDate) ? "" : "none";
      });
      updateTxnAnalytics();
    }

    function resetTxnFilters(){
      fFrom.value = fTo.value = fSearch.value = "";
      fType.value = fRegion.value = fStatus.value = "ALL";
      [...tbody.querySelectorAll('tr')].forEach(tr => tr.style.display = "");
      updateTxnAnalytics();
    }

    function updateTxnAnalytics(){
      const rows = [...tbody.querySelectorAll('tr')].filter(tr => tr.style.display !== "none");
      let paidSum = 0, refundedSum = 0, paidCount = 0, refundedCount = 0;
      const byType = {}, byRegion = {};

      rows.forEach(tr => {
        const c = tr.cells;
        const type = c[2].innerText.trim();
        const reg = c[4].innerText.split(',')[0].trim();
        const st = c[5].innerText.trim();
        const amt = getAmount(c[6]);

        if(st === "Paid"){
          paidSum += amt; paidCount++;
          byType[type] = (byType[type] || 0) + amt;
          byRegion[reg] = (byRegion[reg] || 0) + amt;
        } else {
          refundedSum += amt; refundedCount++;
        }
      });

      document.getElementById('kpiTxnCount').textContent = rows.length;
      document.getElementById('kpiPaid').textContent = peso(paidSum);
      document.getElementById('kpiRefunded').textContent = peso(refundedSum);
      document.getElementById('kpiNet').textContent = peso(paidSum - refundedSum);

      updateCompactChart('chartStatus', 'doughnut', ['Paid', 'Refunded'], [paidCount, refundedCount], { backgroundColor: ['#059669', '#e11d48'] });
      updateCompactChart('chartType', 'bar', Object.keys(byType), Object.values(byType), { label: 'Paid Amounts' });
      updateCompactChart('chartRegion', 'bar', Object.keys(byRegion), Object.values(byRegion), { label: 'Regional Income' });
    }

    function updateCompactChart(id, type, labels, data, extra = {}){
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type, data: { labels, datasets: [{ data, backgroundColor: extra.backgroundColor || ['#0f172a', '#334155', '#64748b', '#94a3b8'], label: extra.label }] },
        options: { 
          responsive: true, maintainAspectRatio: false, 
          plugins: { legend: { display: type==='doughnut', position: 'bottom', labels: { boxWidth: 8, font: { size: 9, weight: 'bold' } } } },
          scales: type === 'bar' ? { y: { beginAtZero: true, ticks: { font: { size: 8 } } }, x: { ticks: { font: { size: 8 } } } } : {}
        }
      });
    }

    function viewThisRow(btn){
      const c = btn.closest('tr').cells;
      const data = { "Reference #": c[0].innerText, "Customer Name": c[1].innerText, "Trans. Type": c[2].innerText, "Date Filed": c[3].innerText, "Full Location": c[4].innerText, "Registry Status": c[5].innerText, "Transaction Amount": c[6].innerText };
      document.getElementById('txnViewContent').innerHTML = Object.entries(data).map(([k,v]) => `
        <div class="p-2 border border-slate-100 rounded bg-slate-50">
          <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tight">${k}</p>
          <p class="text-xs font-bold text-slate-700">${v}</p>
        </div>
      `).join('');
      document.getElementById('txnViewModal').classList.replace('hidden', 'flex');
    }

    function closeTxnView(){ document.getElementById('txnViewModal').classList.replace('flex', 'hidden'); }

    // Initial Analytics Run
    updateTxnAnalytics();
  </script>
</body>
</html>
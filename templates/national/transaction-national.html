<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TLPH | National Dashboard - Transactions</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>

    :root{
      --gov-font: Verdana, Arial, Tahoma, sans-serif;
      --gov-bg: #f3f4f6;
      --gov-panel: #ffffff;
      --gov-border: #d1d5db;
      --gov-focus: rgba(5,150,105,0.18);
    }

    html,body{ font-family: var(--gov-font); }

    body{ background: var(--gov-bg); }

    .card{ 
      background: var(--gov-panel); 
      border: 1px solid var(--gov-border); 
      border-radius: 16px; 
    }

    .focus-ring:focus{ 
      outline: 3px solid var(--gov-focus); 
      outline-offset: 2px; 
    }

    .sticky-head thead th{ position: sticky; top: 0; z-index: 5; }

    .modal-bg{ background: rgba(0,0,0,0.4); }

  </style>
</head>

<body class="min-h-screen text-slate-900">
  <div class="min-h-screen flex">
    {% include 'national/sidenav-national.html' %}

    <main class="flex-1 min-w-0 px-5 sm:px-6 lg:px-8 py-6 space-y-6">
      <div class="w-full max-w-[1700px] space-y-6">

        <section class="card p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <div class="text-lg font-bold">Transactions (National)</div>
            <div class="text-xs text-gray-600">
              Monitor payments and refunds from Applications, Service Requests, and Licensing/Permits.
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button
              class="px-4 py-2 rounded-xl border border-gray-300 bg-white hover:bg-gray-50 text-sm inline-flex items-center gap-2">
              <span class="material-icons-round text-[18px]">download</span>
              Export
            </button>
          </div>
        </section>

        <section class="card p-4">
          <div class="flex flex-wrap items-center gap-2">
            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-600">From</label>
              <input id="fFrom" type="date" class="px-3 py-2 rounded-xl border border-gray-300 text-sm bg-white focus-ring" />
            </div>

            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-600">To</label>
              <input id="fTo" type="date" class="px-3 py-2 rounded-xl border border-gray-300 text-sm bg-white focus-ring" />
            </div>

            <select id="fType" class="px-3 py-2 rounded-xl border border-gray-300 text-sm bg-white focus-ring">
              <option value="ALL" selected>All Types</option>
              <option>Application</option>
              <option>Service Request</option>
              <option>Licensing/Permit</option>
            </select>

            <select id="fRegion" class="px-3 py-2 rounded-xl border border-gray-300 text-sm bg-white focus-ring">
              <option value="ALL" selected>All Regions</option>
              <option>NCR</option>
              <option>Region IV-A</option>
              <option>Region VII</option>
              <option>Region III</option>
              <option>BARMM</option>
              <option>CAR</option>
            </select>

            <select id="fStatus" class="px-3 py-2 rounded-xl border border-gray-300 text-sm bg-white focus-ring">
              <option value="ALL" selected>All Status</option>
              <option>Paid</option>
              <option>Refunded</option>
            </select>

            <input
              id="fSearch"
              type="text"
              placeholder="Search ref # / name / municipality…"
              class="px-3 py-2 rounded-xl border border-gray-300 text-sm bg-white w-72 focus-ring"
            />

            <button
              onclick="applyTxnFilters()"
              class="px-4 py-2 rounded-xl border border-gray-300 bg-white hover:bg-gray-50 text-sm">
              Apply
            </button>

            <button
              onclick="resetTxnFilters()"
              class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm">
              Reset
            </button>
          </div>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
          <div class="card p-4">
            <div class="text-xs text-gray-600">Total Transactions</div>
            <div id="kpiTxnCount" class="text-2xl font-bold mt-1">—</div>
            <div class="mt-2 text-xs text-gray-600">Visible rows (filters applied)</div>
          </div>

          <div class="card p-4">
            <div class="text-xs text-gray-600">Total Paid</div>
            <div id="kpiPaid" class="text-2xl font-bold mt-1">—</div>
            <div class="mt-2 text-xs text-gray-600">Sum of paid amounts</div>
          </div>

          <div class="card p-4">
            <div class="text-xs text-gray-600">Total Refunded</div>
            <div id="kpiRefunded" class="text-2xl font-bold mt-1">—</div>
            <div class="mt-2 text-xs text-gray-600">Sum of refunded amounts</div>
          </div>

          <div class="card p-4">
            <div class="text-xs text-gray-600">Net Revenue</div>
            <div id="kpiNet" class="text-2xl font-bold mt-1">—</div>
            <div class="mt-2 text-xs text-gray-600">Paid − Refunded</div>
          </div>
        </section>

        <section class="grid grid-cols-1 xl:grid-cols-3 gap-4">
          <div class="card p-4">
            <div class="font-bold">Status Breakdown</div>
            <div class="text-xs text-gray-600">Paid vs Refunded (count)</div>
            <div class="mt-3 h-[320px]">
              <canvas id="chartStatus"></canvas>
            </div>
          </div>

          <div class="card p-4">
            <div class="font-bold">Amount by Type</div>
            <div class="text-xs text-gray-600">Paid amounts per transaction type</div>
            <div class="mt-3 h-[320px]">
              <canvas id="chartType"></canvas>
            </div>
          </div>

          <div class="card p-4">
            <div class="font-bold">Amount by Region</div>
            <div class="text-xs text-gray-600">Paid amounts per region</div>
            <div class="mt-3 h-[320px]">
              <canvas id="chartRegion"></canvas>
            </div>
          </div>
        </section>

        <section class="card overflow-hidden">
          <div class="p-4 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div>
              <div class="font-bold">Transaction List</div>
              <div class="text-xs text-gray-600">
                Reference # • Name • Type • Date • Region • Municipality • Status • Amount
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <button
                onclick="openTxnViewSelectedInfo()"
                class="px-3 py-2 rounded-xl border border-gray-300 bg-white hover:bg-gray-50 text-sm inline-flex items-center gap-2">
                <span class="material-icons-round text-[18px]">visibility</span>
                Quick View
              </button>

              <button
                class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm inline-flex items-center gap-2">
                <span class="material-icons-round text-[18px]">download</span>
                Export Table
              </button>
            </div>
          </div>

          <div class="overflow-x-auto max-h-[560px] sticky-head">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50 border-y border-gray-200">
                <tr class="text-left text-gray-600">
                  <th class="py-3 px-4 whitespace-nowrap">Select</th>
                  <th class="py-3 px-4 whitespace-nowrap">Reference #</th>
                  <th class="py-3 px-4 whitespace-nowrap">Name</th>
                  <th class="py-3 px-4 whitespace-nowrap">Type</th>
                  <th class="py-3 px-4 whitespace-nowrap">Date</th>
                  <th class="py-3 px-4 whitespace-nowrap">Region</th>
                  <th class="py-3 px-4 whitespace-nowrap">Municipality</th>
                  <th class="py-3 px-4 whitespace-nowrap">Status</th>
                  <th class="py-3 px-4 whitespace-nowrap">Amount</th>
                </tr>
              </thead>

              <tbody id="txnTbody" class="divide-y divide-gray-200">

                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4"><input type="radio" name="txnPick" /></td>
                  <td class="py-3 px-4 font-semibold">TXN-004182</td>
                  <td class="py-3 px-4">Dela Cruz, Juan</td>
                  <td class="py-3 px-4">Application</td>
                  <td class="py-3 px-4 whitespace-nowrap">2026-02-12</td>
                  <td class="py-3 px-4 whitespace-nowrap">NCR</td>
                  <td class="py-3 px-4 whitespace-nowrap">Quezon City</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs border border-emerald-200 bg-emerald-50 text-emerald-800">Paid</span>
                  </td>
                  <td class="py-3 px-4 whitespace-nowrap" data-amount="1250">₱ 1,250</td>
                </tr>

                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4"><input type="radio" name="txnPick" /></td>
                  <td class="py-3 px-4 font-semibold">TXN-004170</td>
                  <td class="py-3 px-4">Santos, Maria</td>
                  <td class="py-3 px-4">Licensing/Permit</td>
                  <td class="py-3 px-4 whitespace-nowrap">2026-02-10</td>
                  <td class="py-3 px-4 whitespace-nowrap">Region IV-A</td>
                  <td class="py-3 px-4 whitespace-nowrap">Calamba</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs border border-rose-200 bg-rose-50 text-rose-800">Refunded</span>
                  </td>
                  <td class="py-3 px-4 whitespace-nowrap" data-amount="850">₱ 850</td>
                </tr>

                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4"><input type="radio" name="txnPick" /></td>
                  <td class="py-3 px-4 font-semibold">TXN-004155</td>
                  <td class="py-3 px-4">Rivera, Liza</td>
                  <td class="py-3 px-4">Service Request</td>
                  <td class="py-3 px-4 whitespace-nowrap">2026-02-09</td>
                  <td class="py-3 px-4 whitespace-nowrap">Region VII</td>
                  <td class="py-3 px-4 whitespace-nowrap">Cebu City</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs border border-emerald-200 bg-emerald-50 text-emerald-800">Paid</span>
                  </td>
                  <td class="py-3 px-4 whitespace-nowrap" data-amount="600">₱ 600</td>
                </tr>

                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4"><input type="radio" name="txnPick" /></td>
                  <td class="py-3 px-4 font-semibold">TXN-004131</td>
                  <td class="py-3 px-4">Garcia, Noel</td>
                  <td class="py-3 px-4">Application</td>
                  <td class="py-3 px-4 whitespace-nowrap">2026-02-06</td>
                  <td class="py-3 px-4 whitespace-nowrap">CAR</td>
                  <td class="py-3 px-4 whitespace-nowrap">Baguio</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs border border-emerald-200 bg-emerald-50 text-emerald-800">Paid</span>
                  </td>
                  <td class="py-3 px-4 whitespace-nowrap" data-amount="950">₱ 950</td>
                </tr>

              </tbody>
            </table>
          </div>

          <div class="p-4 border-t border-gray-100 text-xs text-gray-600 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div>Showing visible rows based on filters (UI Draft)</div>
            <div class="inline-flex items-center gap-2">
              <span>National</span>
              <span>Chart-ready</span>
            </div>
          </div>
        </section>

        <footer class="py-6 text-xs text-gray-600">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div>© 2026 TLPH • Transactions (National) (UI Draft)</div>
            <div class="inline-flex items-center gap-2">
              <span>RBAC-ready</span>
              <span>DB-ready</span>
            </div>
          </div>
        </footer>

      </div>
    </main>
  </div>

  <div id="txnViewModal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50">
    <div class="bg-white rounded-2xl w-[560px] max-w-[92vw] p-6 space-y-4">
      <div class="flex items-center justify-between">
        <div class="font-bold text-lg">Transaction Details</div>
        <button onclick="closeTxnView()" class="text-gray-500">
          <span class="material-icons-round">close</span>
        </button>
      </div>

      <div id="txnViewContent" class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm"></div>

      <div class="flex justify-end">
        <button onclick="closeTxnView()" class="px-4 py-2 rounded-xl border border-gray-300 bg-white hover:bg-gray-50 text-sm">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.getElementById('txnTbody');
    const fFrom = document.getElementById('fFrom');
    const fTo = document.getElementById('fTo');
    const fType = document.getElementById('fType');
    const fRegion = document.getElementById('fRegion');
    const fStatus = document.getElementById('fStatus');
    const fSearch = document.getElementById('fSearch');

    let charts = {};

    function peso(n){
      const v = Number(n || 0);
      return "₱ " + new Intl.NumberFormat('en-US', { minimumFractionDigits: 0 }).format(v);
    }
    function getAmount(td){
      const raw = td.getAttribute('data-amount');
      if(raw !== null) return Number(raw) || 0;
      return Number((td.innerText || "").replace(/[^\d.-]/g, "")) || 0;
    }

    function applyTxnFilters(){
      const type = fType.value;
      const region = fRegion.value;
      const status = fStatus.value;
      const q = fSearch.value.trim().toLowerCase();

      const from = fFrom.value ? new Date(fFrom.value + "T00:00:00") : null;
      const to = fTo.value ? new Date(fTo.value + "T23:59:59") : null;

      [...tbody.querySelectorAll('tr')].forEach(tr => {
        const cells = tr.cells;
        const ref = cells[1].innerText.trim();
        const name = cells[2].innerText.trim();
        const t = cells[3].innerText.trim();
        const dateStr = cells[4].innerText.trim(); 
        const r = cells[5].innerText.trim();
        const muni = cells[6].innerText.trim();
        const st = cells[7].innerText.trim(); 

        const hay = (ref + " " + name + " " + muni).toLowerCase();

        let okType = (type === "ALL") || (t === type);
        let okRegion = (region === "ALL") || (r === region);
        let okStatus = (status === "ALL") || (st === status);
        let okQ = (!q) || hay.includes(q);

        let okDate = true;
        if(from || to){
          const d = new Date(dateStr + "T12:00:00");
          if(from && d < from) okDate = false;
          if(to && d > to) okDate = false;
        }

        tr.style.display = (okType && okRegion && okStatus && okQ && okDate) ? "" : "none";
      });

      updateTxnAnalytics();
    }

    function resetTxnFilters(){
      fFrom.value = "";
      fTo.value = "";
      fType.value = "ALL";
      fRegion.value = "ALL";
      fStatus.value = "ALL";
      fSearch.value = "";
      [...tbody.querySelectorAll('tr')].forEach(tr => tr.style.display = "");
      updateTxnAnalytics();
    }

    function visibleRows(){
      return [...tbody.querySelectorAll('tr')].filter(tr => tr.style.display !== "none");
    }

    function updateTxnAnalytics(){
      const rows = visibleRows();

      let count = rows.length;
      let paidSum = 0;
      let refundedSum = 0;

      let paidCount = 0;
      let refundedCount = 0;

      const byTypePaid = {};
      const byRegionPaid = {};

      rows.forEach(tr => {
        const cells = tr.cells;
        const type = cells[3].innerText.trim();
        const region = cells[5].innerText.trim();
        const status = cells[7].innerText.trim();
        const amount = getAmount(cells[8]);

        if(status === "Paid"){
          paidSum += amount;
          paidCount += 1;
          byTypePaid[type] = (byTypePaid[type] || 0) + amount;
          byRegionPaid[region] = (byRegionPaid[region] || 0) + amount;
        } else if(status === "Refunded"){
          refundedSum += amount;
          refundedCount += 1;
        }
      });

      document.getElementById('kpiTxnCount').textContent = new Intl.NumberFormat('en-US').format(count);
      document.getElementById('kpiPaid').textContent = peso(paidSum);
      document.getElementById('kpiRefunded').textContent = peso(refundedSum);
      document.getElementById('kpiNet').textContent = peso(paidSum - refundedSum);

      if(charts.status) charts.status.destroy();
      charts.status = new Chart(document.getElementById('chartStatus'), {
        type: 'doughnut',
        data: {
          labels: ['Paid', 'Refunded'],
          datasets: [{ data: [paidCount, refundedCount] }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });

      const typeEntries = Object.entries(byTypePaid);
      if(charts.type) charts.type.destroy();
      charts.type = new Chart(document.getElementById('chartType'), {
        type: 'bar',
        data: {
          labels: typeEntries.map(x => x[0]),
          datasets: [{ label: 'Paid Amount', data: typeEntries.map(x => x[1]) }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom' } },
          scales:{ y:{ beginAtZero:true } }
        }
      });

      const regionEntries = Object.entries(byRegionPaid).sort((a,b)=>b[1]-a[1]);
      if(charts.region) charts.region.destroy();
      charts.region = new Chart(document.getElementById('chartRegion'), {
        type: 'bar',
        data: {
          labels: regionEntries.map(x => x[0]),
          datasets: [{ label: 'Paid Amount', data: regionEntries.map(x => x[1]) }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom' } },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    }
    
    function openTxnViewSelectedInfo(){
      const rows = visibleRows();
      let selectedTr = null;

      rows.forEach(tr => {
        const radio = tr.querySelector('input[type="radio"]');
        if(radio && radio.checked) selectedTr = tr;
      });

      if(!selectedTr){
        alert("Select a transaction row first.");
        return;
      }

      const c = selectedTr.cells;
      const data = {
        "Reference #": c[1].innerText.trim(),
        "Name": c[2].innerText.trim(),
        "Type": c[3].innerText.trim(),
        "Date": c[4].innerText.trim(),
        "Region": c[5].innerText.trim(),
        "Municipality": c[6].innerText.trim(),
        "Status": c[7].innerText.trim(),
        "Amount": c[8].innerText.trim()
      };

      const content = document.getElementById('txnViewContent');
      content.innerHTML = Object.entries(data).map(([k,v]) => `
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <div class="text-xs text-gray-600">${k}</div>
          <div class="font-semibold mt-1">${v}</div>
        </div>
      `).join('');

      const modal = document.getElementById('txnViewModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeTxnView(){
      const modal = document.getElementById('txnViewModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    updateTxnAnalytics();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DENR | Master Console (Compact)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gov-blue': '#0038a8', 
                        'gov-red': '#ce1126',  
                        'denr-dark': '#004d00',
                        'denr-green': '#006400',
                    },
                    fontFamily: {
                        'serif': ['Georgia', 'serif'],
                        'sans': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .gov-strip { background: linear-gradient(to right, #0038a8 50%, #ce1126 50%); height: 3px; width: 100%; position: fixed; top: 0; z-index: 2000; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #004d00; border-radius: 10px; }
        .nav-trigger.active { border-bottom: 3px solid #0038a8; background-color: #f1f5f9; color: #0038a8; font-weight: 800; }
        td, th { padding: 0.5rem 0.75rem !important; font-size: 11px !important; }
        @media print { .no-print { display: none !important; } main { margin-left: 0 !important; padding-top: 0 !important; } }
    </style>
</head>
<body class="bg-[#f1f4f3] font-sans text-slate-900 overflow-x-hidden">
    <div class="gov-strip no-print"></div>

    <div class="fixed top-0 w-full z-[1050] no-print">
        {% include 'super-admin/header-superadmin.html' %}
    </div>
    <div class="fixed left-0 h-full z-[1040] no-print">
        {% include 'super-admin/sidenav-superadmin.html' %}
    </div>

    <main class="lg:ml-64 pt-24 pb-4 transition-all duration-300">
        <div class="max-w-[1700px] mx-auto p-2 lg:px-4 space-y-3"> 
            
            <div class="flex items-center justify-between bg-white p-3 border border-slate-200 shadow-sm rounded-sm">
                <div class="flex items-center gap-3">
                    <img src="{{ url_for('static', filename='images/denr.jpg') }}" class="h-10 w-10" alt="DENR Seal">
                    <div class="border-l border-slate-300 pl-3">
                        <h1 class="font-serif text-lg font-black text-denr-dark uppercase leading-tight">Master Control Console</h1>
                        <p class="text-[9px] font-bold text-gov-blue uppercase tracking-widest leading-tight">National Registry & Intelligence</p>
                    </div>
                </div>
                <div class="flex gap-2 items-center no-print">
                    <button onclick="window.print()" class="bg-slate-800 text-white px-3 py-1.5 text-[9px] font-black uppercase rounded shadow hover:bg-black flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-print"></i> Print Report
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-4 md:grid-cols-7 gap-2 no-print">
                <div class="bg-white border-t-2 border-t-denr-green p-2 shadow-sm text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Apps</p>
                    <h3 class="text-sm font-black" id="kpi-apps">0</h3>
                </div>
                <div class="bg-white border-t-2 border-t-gov-blue p-2 shadow-sm text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Reqs</p>
                    <h3 class="text-sm font-black" id="kpi-reqs">0</h3>
                </div>
                <div class="bg-white border-t-2 border-t-amber-500 p-2 shadow-sm text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Permits</p>
                    <h3 class="text-sm font-black" id="kpi-permits">0</h3>
                </div>
                <div class="bg-white border-t-2 border-t-emerald-600 p-2 shadow-sm text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Inv</p>
                    <h3 class="text-sm font-black" id="kpi-inv">0</h3>
                </div>
                <div class="bg-white border-t-2 border-t-indigo-600 p-2 shadow-sm text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Assets</p>
                    <h3 class="text-sm font-black" id="kpi-uinv">0</h3>
                </div>
                <div class="bg-white border-t-2 border-t-gov-red p-2 shadow-sm text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Rev</p>
                    <h3 class="text-sm font-black" id="kpi-txn">0</h3>
                </div>
                <div class="bg-white border-t-2 border-t-slate-800 p-2 shadow-sm text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Users</p>
                    <h3 class="text-sm font-black" id="kpi-users">0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 no-print">
                <div class="lg:col-span-2 bg-white border p-3 shadow-sm">
                    <h4 class="text-[9px] font-black text-denr-dark uppercase mb-2 border-l-2 border-gov-blue pl-2">Nationwide Trends</h4>
                    <div class="h-[140px]"><canvas id="lineChart"></canvas></div>
                </div>
                <div class="bg-white border p-3 shadow-sm">
                    <h4 class="text-[9px] font-black text-denr-dark uppercase mb-2 border-l-2 border-gov-red pl-2">Regional Rank</h4>
                    <div class="h-[140px]"><canvas id="barChart"></canvas></div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 shadow-sm flex flex-col min-h-[500px]">
                <div class="p-3 bg-slate-50 border-b no-print">
                    <div class="flex flex-col lg:flex-row gap-3 items-center">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 flex-1 w-full">
                            <div>
                                <label class="text-[8px] font-black text-slate-400 uppercase ml-1">Search</label>
                                <input id="searchInput" class="w-full px-2 py-1.5 text-[11px] border border-slate-300 rounded outline-none focus:ring-1 focus:ring-gov-blue" placeholder="Filter Registry...">
                            </div>
                            <div>
                                <label class="text-[8px] font-black text-slate-400 uppercase ml-1">Sector</label>
                                <select id="categorySelect" class="w-full px-2 py-1.5 text-[11px] border border-slate-300 bg-white font-bold outline-none uppercase"></select>
                            </div>
                            <div>
                                <label class="text-[8px] font-black text-slate-400 uppercase ml-1">Jurisdiction</label>
                                <select id="scopeSelect" class="w-full px-2 py-1.5 text-[11px] border border-slate-300 bg-white outline-none">
                                    <option value="all">ALL REGIONS</option>
                                    <option value="NCR">NCR</option>
                                    <option value="CAR">CAR</option>
                                    <option value="I">REGION I</option>
                                    <option value="II">REGION II</option>
                                    <option value="III">REGION III</option>
                                    <option value="IV-A">REGION IV-A</option>
                                    <option value="IV-B">REGION IV-B</option>
                                    <option value="V">REGION V</option>
                                    <option value="VI">REGION VI</option>
                                    <option value="VII">REGION VII</option>
                                    <option value="VIII">REGION VIII</option>
                                    <option value="IX">REGION IX</option>
                                    <option value="X">REGION X</option>
                                    <option value="XI">REGION XI</option>
                                    <option value="XII">REGION XII</option>
                                    <option value="XIII">REGION XIII</option>
                                    <option value="BARMM">BARMM</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="exportTableToCSV()" class="bg-denr-green text-white px-4 py-2 text-[8px] font-black uppercase tracking-widest rounded shadow hover:bg-denr-dark transition-all flex items-center gap-1 shrink-0">
                            <i class="fa-solid fa-file-csv"></i> CSV
                        </button>
                    </div>
                </div>

                <nav class="flex bg-slate-100 border-b no-print overflow-x-auto">
                    <button class="nav-trigger active px-4 py-2.5 text-[9px] font-black uppercase whitespace-nowrap" data-tab="applications">Applications</button>
                    <button class="nav-trigger px-4 py-2.5 text-[9px] font-black uppercase text-slate-500 whitespace-nowrap" data-tab="requests">Service Requests</button>
                    <button class="nav-trigger px-4 py-2.5 text-[9px] font-black uppercase text-slate-500 whitespace-nowrap" data-tab="inventory">Inventory</button>
                    <button class="nav-trigger px-4 py-2.5 text-[9px] font-black uppercase text-slate-500 whitespace-nowrap" data-tab="permits">Licensing</button>
                    <button class="nav-trigger px-4 py-2.5 text-[9px] font-black uppercase text-slate-500 whitespace-nowrap" data-tab="transactions">Revenue</button>
                    <button class="nav-trigger px-4 py-2.5 text-[9px] font-black uppercase text-slate-500 whitespace-nowrap" data-tab="users">Accounts</button>
                </nav>

                <div class="overflow-x-auto flex-1">
                    <table id="masterTable" class="w-full text-left border-collapse">
                        <thead class="bg-white border-b-2 border-slate-200">
                            <tr id="tableHeadRow" class="text-[9px] uppercase font-black text-slate-600"></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100 text-[11px] text-slate-700"></tbody>
                    </table>
                </div>
                
                <div class="px-3 py-2 bg-slate-800 flex justify-between items-center text-[8px] font-black text-white uppercase tracking-widest no-print">
                    <div>Matches: <span id="resultCount" class="text-amber-400">0</span></div>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                        Secure Registry Session â€¢ 2026
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const CATEGORIES = {
            applications: ["Forestry Management", "Biodiversity", "Lands", "Mining", "Environmental Services"],
            requests: ["Site Inspection", "Administrative Audit", "Clearance", "Certification"],
            inventory: ["Seedlings", "Wildlife Registry", "Seized Materials", "Government Assets"],
            permits: ["Tree Cutting", "Wildlife Trade", "ECC", "PTO", "CITES"],
            transactions: ["Application Fee", "Permit Fee", "Administrative Penalty"],
            users: ["Central Office", "Regional Director", "PENRO Official", "CENRO Personnel"]
        };

        const DATA = {
            applications: [
                { date: "2026-02-13", ref: "DENR-APP-2026-001", entity: "MIMAROPA Dev Corp", sector: "Forestry Management", region: "IV-B", lgu: "Calapan City", status: "PENDING" },
                { date: "2026-02-12", ref: "DENR-APP-2026-002", entity: "Naujan NGO", sector: "Biodiversity", region: "IV-B", lgu: "Naujan", status: "APPROVED" },
                { date: "2026-02-11", ref: "DENR-APP-2026-003", entity: "NCR Project", sector: "Lands", region: "NCR", lgu: "Quezon City", status: "APPROVED" }
            ],
            requests: [{ date: "2026-02-13", ref: "SR-9910-B", entity: "Mindoro Cooperative", sector: "Inspection", region: "IV-B", lgu: "Victoria", status: "FOR REVIEW" }],
            inventory: [{ cat: "Seedlings", desc: "Narra Saplings", qty: 5000, region: "IV-B", lgu: "Baco" }],
            permits: [{ ref: "PMT-CITES-882", entity: "Nature Exporters", sector: "Wildlife Trade", region: "IV-B", lgu: "San Teodoro", status: "ACTIVE" }],
            transactions: [{ ref: "OR-10291-TX", entity: "MIMAROPA Corp", type: "Permit Fee", date: "2026-02-13", region: "IV-B", status: "PAID", amount: 15400 }],
            users: [{ name: "Maria Santos", email: "maria@denr.gov.ph", type: "Regional Director", region: "IV-B", lgu: "Calapan", status: "ACTIVE" }]
        };

        const HEADERS = {
            applications: ["Date", "Registry ID", "Entity", "Sector", "Region", "LGU", "Status"],
            requests: ["Date", "Request ID", "Client", "Category", "Region", "LGU", "Status"],
            inventory: ["Category", "Description", "Qty", "Region", "Muni"],
            permits: ["License No", "Licensee", "Sector", "Region", "LGU", "Status"],
            transactions: ["OR No.", "Payor", "Fee Type", "Date", "Reg", "Status", "Amt"],
            users: ["Personnel", "Email", "Designation", "Reg", "LGU", "Acc"]
        };

        let activeTab = "applications";
        const $ = (id) => document.getElementById(id);
        let myLineChart, myBarChart;

        function populateCategories() {
            const select = $("categorySelect");
            select.innerHTML = '<option value="all">-- ALL SECTORS --</option>';
            (CATEGORIES[activeTab] || []).forEach(cat => {
                const opt = document.createElement("option"); opt.value = cat; opt.textContent = cat.toUpperCase(); select.appendChild(opt);
            });
        }

        function renderTable() {
            const head = $("tableHeadRow"); const body = $("tableBody");
            const search = $("searchInput").value.toLowerCase();
            const catF = $("categorySelect").value;
            const scopeF = $("scopeSelect").value;
            
            head.innerHTML = ""; body.innerHTML = "";
            (HEADERS[activeTab] || []).forEach(t => { const th = document.createElement("th"); th.textContent = t; head.appendChild(th); });
            
            const filtered = (DATA[activeTab] || []).filter(r => {
                const mSearch = Object.values(r).join(" ").toLowerCase().includes(search);
                const mCat = catF === "all" || r.sector === catF || r.category === catF || r.cat === catF;
                const mScope = scopeF === "all" || r.region === scopeF || r.Reg === scopeF || r.reg === scopeF;
                return mSearch && mCat && mScope;
            });

            $("resultCount").textContent = filtered.length;
            filtered.forEach(r => {
                const tr = document.createElement("tr"); tr.className = "hover:bg-slate-50 transition-colors border-b";
                Object.values(r).forEach(v => {
                    const td = document.createElement("td"); td.className = "whitespace-nowrap";
                    td.textContent = (typeof v === 'number' && v > 1000) ? v.toLocaleString() : v;
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        }

        function initCharts() {
            myLineChart = new Chart($('lineChart'), { 
                type: 'line', 
                data: { labels: ['07','08','09','10','11','12','13'], datasets: [{ label:'Submissions', data:[450, 620, 580, 890, 720, 950, 1100], borderColor:'#0038a8', pointRadius: 2, fill: true, tension: 0.3 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{font:{size:9}}},y:{ticks:{font:{size:9}}}}}
            });
            myBarChart = new Chart($('barChart'), { 
                type: 'bar', 
                data: { labels: ['NCR','IV-A','IV-B','III','VII'], datasets: [{ data:[92, 85, 95, 78, 88], backgroundColor:['#004d00','#006400','#0038a8','#f59e0b','#ce1126'] }] },
                options: { indexAxis: 'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{max:100,ticks:{font:{size:9}}},y:{ticks:{font:{size:9}}}} }
            });
        }

        function exportTableToCSV() {
            let csv = [];
            const rows = document.querySelectorAll("#masterTable tr");
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
                csv.push(row.join(","));
            }
            const csvBlob = new Blob([csv.join("\n")], { type: "text/csv" });
            const url = window.URL.createObjectURL(csvBlob);
            const a = document.createElement("a");
            a.href = url; a.download = `DENR_COMPACT_REPORT_2026.csv`; a.click();
        }

        document.querySelectorAll(".nav-trigger").forEach(btn => {
            btn.addEventListener("click", (e) => {
                document.querySelectorAll(".nav-trigger").forEach(b => b.classList.remove("active"));
                e.target.classList.add("active");
                activeTab = e.target.getAttribute("data-tab");
                populateCategories(); renderTable();
            });
        });

        $("searchInput").addEventListener("input", renderTable);
        $("categorySelect").addEventListener("change", renderTable);
        $("scopeSelect").addEventListener("change", renderTable);

        window.onload = () => { 
            initCharts(); populateCategories(); renderTable(); 
            ["apps","reqs","permits","inv","uinv","txn","users"].forEach(k => {
                $( `kpi-${k}`).textContent = DATA[k === "uinv" ? "applications" : k === "txn" ? "transactions" : k]?.length || 0;
            });
        };
    </script>
</body>
</html>